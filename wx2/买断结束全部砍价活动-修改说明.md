# ä¹°æ–­åŠŸèƒ½å®Œå–„ - ä¿®æ”¹è¯´æ˜

## ğŸ¯ éœ€æ±‚æè¿°
**ä¹°æ–­ä»¥åï¼Œæ•´ä¸ªæ–‡ç« çš„ç ä»·æ´»åŠ¨éƒ½ç»“æŸ**

å½“ä»»ä½•ç”¨æˆ·ä¹°æ–­ç ä»·å•†å“åï¼Œè¯¥æ–‡ç« çš„ç ä»·æ´»åŠ¨åº”è¯¥å®Œå…¨ç»“æŸï¼Œå…¶ä»–ç”¨æˆ·æ— æ³•ç»§ç»­å‚ä¸ç ä»·ã€‚

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. å®Œå–„äº‘å‡½æ•° `buyoutBargain` â­â­â­
**æ–‡ä»¶**: `uniCloud-aliyun/cloudfunctions/articleWx/index.obj.js`

**ä¿®æ”¹å†…å®¹**:
```javascript
// æ›´æ–°æ–‡ç« çŠ¶æ€ï¼šæ ‡è®°ä¸ºå·²å®Œæˆå¹¶ä¸‹æ¶/é”å®š
await this.articleCollection.doc(article_id).update({
    bargain_completed: true, // æ ‡è®°ç ä»·å®Œæˆ
    bargain_winner_id: user_id, // è®°å½•è·èƒœè€…ID
    bargain_winner_nickname: userInfo.nickName || 'åŒ¿åç”¨æˆ·', // è®°å½•è·èƒœè€…æ˜µç§°
    bargain_buyout_price: finalBuyoutPrice, // è®°å½•ä¹°æ–­ä»·æ ¼
    bargain_buyout_time: now, // è®°å½•ä¹°æ–­æ—¶é—´
    state: 2, // è‡ªåŠ¨ä¸‹æ¶/é”å®šæ–‡ç« 
    enable_bargain: false // ğŸ†• å…³é—­ç ä»·åŠŸèƒ½ï¼Œé˜²æ­¢å…¶ä»–äººç»§ç»­å‚ä¸
});
```

**æ–°å¢åŠŸèƒ½**:
- âœ… è®¾ç½® `enable_bargain: false` å…³é—­ç ä»·åŠŸèƒ½
- âœ… è®¾ç½® `state: 2` ä¸‹æ¶æ–‡ç« 
- âœ… è®°å½•ä¹°æ–­è€…ä¿¡æ¯

---

### 2. å®Œå–„äº‘å‡½æ•° `completeBuyout` â­â­â­
**æ–‡ä»¶**: `uniCloud-aliyun/cloudfunctions/articleWx/index.obj.js`

**ä¿®æ”¹å†…å®¹**:
```javascript
// æ›´æ–°æ–‡ç« çŠ¶æ€ - æ ‡è®°ç ä»·æ´»åŠ¨å®Œæˆå¹¶ä¸‹æ¶æ–‡ç« 
await this.articleCollection.doc(order.article_id).update({
    bargain_completed: true, // æ ‡è®°ç ä»·å®Œæˆ
    bargain_winner_id: user_id, // è®°å½•è·èƒœè€…ID
    bargain_winner_nickname: order.user_info.nickname || 'åŒ¿åç”¨æˆ·', // è®°å½•è·èƒœè€…æ˜µç§°
    bargain_buyout_price: order.buyout_price, // è®°å½•ä¹°æ–­ä»·æ ¼
    bargain_buyout_time: now, // è®°å½•ä¹°æ–­æ—¶é—´
    state: 2, // è‡ªåŠ¨ä¸‹æ¶/é”å®šæ–‡ç« 
    enable_bargain: false // ğŸ†• å…³é—­ç ä»·åŠŸèƒ½ï¼Œé˜²æ­¢å…¶ä»–äººç»§ç»­å‚ä¸
});
```

**æ–°å¢åŠŸèƒ½**:
- âœ… è®¾ç½® `enable_bargain: false` å…³é—­ç ä»·åŠŸèƒ½
- âœ… è®¾ç½® `state: 2` ä¸‹æ¶æ–‡ç« 
- âœ… è®°å½•ä¹°æ–­è€…ä¿¡æ¯

---

### 3. å®Œå–„æ”¯ä»˜å›è°ƒ `recharge.js` â­â­â­
**æ–‡ä»¶**: `uni_modules/uni-pay/uniCloud/cloudfunctions/uni-pay-co/notify/recharge.js`

**ä¿®æ”¹å†…å®¹**:
```javascript
// 6. æ›´æ–°æ–‡ç« çŠ¶æ€ - æ ‡è®°ç ä»·æ´»åŠ¨å®Œæˆå¹¶ä¸‹æ¶æ–‡ç« 
await db.collection('articleList').doc(buyoutOrder.article_id).update({
    bargain_completed: true, // æ ‡è®°ç ä»·å®Œæˆ
    bargain_winner_id: buyoutOrder.user_id, // è®°å½•è·èƒœè€…ID
    bargain_winner_nickname: buyoutOrder.user_info.nickname || 'åŒ¿åç”¨æˆ·', // è®°å½•è·èƒœè€…æ˜µç§°
    bargain_buyout_price: buyoutOrder.buyout_price, // è®°å½•ä¹°æ–­ä»·æ ¼
    bargain_buyout_time: now, // è®°å½•ä¹°æ–­æ—¶é—´
    state: 2, // ä¸‹æ¶æ–‡ç« ï¼Œé˜²æ­¢å…¶ä»–äººç»§ç»­ç ä»·
    enable_bargain: false // ğŸ†• å…³é—­ç ä»·åŠŸèƒ½
});
console.log('âœ… æ–‡ç« çŠ¶æ€å·²æ›´æ–°ï¼Œç ä»·æ´»åŠ¨å·²ç»“æŸï¼Œæ–‡ç« å·²ä¸‹æ¶');
```

**æ–°å¢åŠŸèƒ½**:
- âœ… è®¾ç½® `enable_bargain: false` å…³é—­ç ä»·åŠŸèƒ½
- âœ… è®¾ç½® `state: 2` ä¸‹æ¶æ–‡ç« 
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡º

---

### 4. å®Œå–„å‰ç«¯ç ä»·å®Œæˆåˆ¤æ–­ â­â­
**æ–‡ä»¶**: `wx2/pages/article/articleDetail.vue`

**ä¿®æ”¹å‰**:
```javascript
const isBargainComplete = computed(() => {
    // å½“ä»·æ ¼ä¸º0æ—¶ï¼Œç ä»·å®Œæˆ
    return currentBargainPrice.value <= 0 && articleDetail.value.enable_bargain
})
```

**ä¿®æ”¹å**:
```javascript
const isBargainComplete = computed(() => {
    // æ£€æŸ¥ç ä»·æ˜¯å¦å®Œæˆï¼šä»·æ ¼ä¸º0 æˆ– åç«¯æ ‡è®°å·²å®Œæˆ
    return (currentBargainPrice.value <= 0 && articleDetail.value.enable_bargain) 
        || articleDetail.value.bargain_completed === true
})
```

**æ–°å¢åŠŸèƒ½**:
- âœ… æ£€æŸ¥ `bargain_completed` å­—æ®µ
- âœ… å³ä½¿ä»·æ ¼ä¸ä¸º0ï¼Œåªè¦åç«¯æ ‡è®°å®Œæˆå°±æ˜¾ç¤ºå®ŒæˆçŠ¶æ€

---

### 5. æ·»åŠ ç ä»·æ´»åŠ¨å·²ç»“æŸæç¤º â­â­
**æ–‡ä»¶**: `wx2/pages/article/articleDetail.vue`

**æ–°å¢å†…å®¹**:
```vue
<!-- ç ä»·æ´»åŠ¨å·²ç»“æŸæç¤ºï¼ˆä¹°æ–­å®Œæˆï¼‰ -->
<view class="bargain-ended-card" v-if="articleDetail.bargain_completed && !articleDetail.enable_bargain">
    <view class="ended-icon">
        <uni-icons type="checkmarkempty" size="48" color="#52c41a"></uni-icons>
    </view>
    <view class="ended-content">
        <text class="ended-title">ç ä»·æ´»åŠ¨å·²ç»“æŸ</text>
        <text class="ended-subtitle" v-if="articleDetail.bargain_winner_nickname">
            æ­å–œ {{ articleDetail.bargain_winner_nickname }} ä»¥ ï¿¥{{ articleDetail.bargain_buyout_price?.toFixed(2) || '0.00' }} ä¹°æ–­æˆåŠŸï¼
        </text>
        <text class="ended-subtitle" v-else>è¯¥å•†å“å·²è¢«ä¹°æ–­</text>
    </view>
</view>
```

**æ–°å¢æ ·å¼**:
- âœ… ç»¿è‰²æ¸å˜èƒŒæ™¯
- âœ… åœ†å½¢æˆåŠŸå›¾æ ‡
- âœ… æ˜¾ç¤ºä¹°æ–­è€…æ˜µç§°å’Œä¹°æ–­ä»·æ ¼
- âœ… ç¾è§‚çš„å¡ç‰‡è®¾è®¡

---

### 6. ä¼˜åŒ–ç ä»·å¡ç‰‡æ˜¾ç¤ºæ¡ä»¶ â­
**æ–‡ä»¶**: `wx2/pages/article/articleDetail.vue`

**ä¿®æ”¹å‰**:
```vue
<view class="bargain-info-card" v-if="articleDetail.enable_bargain">
```

**ä¿®æ”¹å**:
```vue
<view class="bargain-info-card" v-if="articleDetail.enable_bargain && !articleDetail.bargain_completed">
```

**æ–°å¢åŠŸèƒ½**:
- âœ… å½“ç ä»·å®Œæˆæ—¶éšè—ç ä»·å¡ç‰‡
- âœ… æ˜¾ç¤º"æ´»åŠ¨å·²ç»“æŸ"æç¤ºå¡ç‰‡

---

## ğŸ”§ å®ç°åŸç†

### ä¹°æ–­æµç¨‹ï¼š
```
ç”¨æˆ·ç‚¹å‡»ä¹°æ–­æŒ‰é’®
    â†“
åˆ›å»ºä¹°æ–­è®¢å•
    â†“
è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
    â†“
æ”¯ä»˜æˆåŠŸ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ›´æ–°æ–‡ç« çŠ¶æ€ï¼ˆ3ä¸ªåœ°æ–¹åŒæ—¶æ›´æ–°ï¼‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. bargain_completed = true        â”‚
â”‚  2. enable_bargain = false  ğŸ†•      â”‚
â”‚  3. state = 2 (ä¸‹æ¶æ–‡ç« )            â”‚
â”‚  4. è®°å½•ä¹°æ–­è€…ä¿¡æ¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ•´ä¸ªæ–‡ç« çš„ç ä»·æ´»åŠ¨ç»“æŸ
    â†“
å…¶ä»–ç”¨æˆ·æ— æ³•ç»§ç»­ç ä»·
```

### å…³é”®å­—æ®µè¯´æ˜ï¼š

| å­—æ®µ | ç±»å‹ | ä½œç”¨ |
|------|------|------|
| `bargain_completed` | Boolean | æ ‡è®°ç ä»·æ˜¯å¦å®Œæˆ |
| `enable_bargain` | Boolean | ğŸ†• æ˜¯å¦å…è®¸ç ä»·ï¼ˆå…³é—­åå½»åº•ç¦æ­¢ï¼‰ |
| `state` | Number | æ–‡ç« çŠ¶æ€ï¼ˆ2=ä¸‹æ¶ï¼‰ |
| `bargain_winner_id` | String | ä¹°æ–­è·èƒœè€…ç”¨æˆ·ID |
| `bargain_winner_nickname` | String | ä¹°æ–­è·èƒœè€…æ˜µç§° |
| `bargain_buyout_price` | Number | ä¹°æ–­ä»·æ ¼ |
| `bargain_buyout_time` | Number | ä¹°æ–­æ—¶é—´æˆ³ |

---

## ğŸ¯ æ•ˆæœè¯´æ˜

### ä¹°æ–­å‰ï¼š
- âœ… ç ä»·å¡ç‰‡æ­£å¸¸æ˜¾ç¤º
- âœ… ç”¨æˆ·å¯ä»¥å¸®ç ä¸€åˆ€
- âœ… ç”¨æˆ·å¯ä»¥ä¹°æ–­

### ä¹°æ–­åï¼š
- âœ… ç ä»·å¡ç‰‡éšè—
- âœ… æ˜¾ç¤º"ç ä»·æ´»åŠ¨å·²ç»“æŸ"æç¤ºå¡ç‰‡
- âœ… æ˜¾ç¤ºä¹°æ–­è€…æ˜µç§°å’Œä¹°æ–­ä»·æ ¼
- âœ… æ–‡ç« è‡ªåŠ¨ä¸‹æ¶ï¼ˆstate=2ï¼‰
- âœ… ç ä»·åŠŸèƒ½å…³é—­ï¼ˆenable_bargain=falseï¼‰
- âœ… å…¶ä»–ç”¨æˆ·æ— æ³•ç»§ç»­å‚ä¸ç ä»·
- âœ… å…¶ä»–ç”¨æˆ·çœ‹åˆ°çš„æ˜¯"æ´»åŠ¨å·²ç»“æŸ"çŠ¶æ€

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### 1ï¸âƒ£ ä¸Šä¼ äº‘å‡½æ•°
```
å³é”®: uniCloud-aliyun/cloudfunctions/articleWx
é€‰æ‹©: ä¸Šä¼ éƒ¨ç½²
```

### 2ï¸âƒ£ ä¸Šä¼  uni-pay-co äº‘å¯¹è±¡
```
å³é”®: uni_modules/uni-pay/uniCloud/cloudfunctions/uni-pay-co
é€‰æ‹©: ä¸Šä¼ éƒ¨ç½²ï¼ˆä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ï¼‰
```

### 3ï¸âƒ£ ä¸Šä¼ å°ç¨‹åº
```
å‘å¸ƒå°ç¨‹åºä½“éªŒç‰ˆæˆ–æ­£å¼ç‰ˆ
```

### 4ï¸âƒ£ çœŸæœºæµ‹è¯•
```
1. åœ¨çœŸæœºä¸Šæ‰“å¼€å°ç¨‹åº
2. è¿›å…¥æœ‰ç ä»·æ´»åŠ¨çš„æ–‡ç« 
3. å®Œæˆä¸€æ¬¡ä¹°æ–­æ“ä½œ
4. åˆ·æ–°é¡µé¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æ˜¾ç¤º"æ´»åŠ¨å·²ç»“æŸ"
5. å°è¯•ç‚¹å‡»ç ä»·ï¼Œåº”è¯¥æ— æ³•æ“ä½œ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸‰ä¸ªåœ°æ–¹éƒ½è¦æ›´æ–°**
   - `buyoutBargain` å‡½æ•°
   - `completeBuyout` å‡½æ•°
   - `recharge.js` å›è°ƒ

2. **å¹‚ç­‰æ€§ä¿è¯**
   - æ‰€æœ‰æ›´æ–°æ“ä½œéƒ½æ”¯æŒé‡å¤æ‰§è¡Œ
   - ä¸ä¼šå› ä¸ºé‡å¤è°ƒç”¨è€Œå‡ºé”™

3. **å‰ç«¯çŠ¶æ€åˆ·æ–°**
   - ä¹°æ–­æˆåŠŸåå‰ç«¯ä¼šåˆ·æ–°é¡µé¢
   - è‡ªåŠ¨åŠ è½½æœ€æ–°çš„æ–‡ç« çŠ¶æ€

4. **ä¸‹æ¶çŠ¶æ€**
   - `state: 2` è¡¨ç¤ºæ–‡ç« å·²ä¸‹æ¶
   - ä¸‹æ¶åæ–‡ç« å¯èƒ½åœ¨åˆ—è¡¨ä¸­ä¸æ˜¾ç¤º

---

## ğŸ” æµ‹è¯•æ£€æŸ¥ç‚¹

### âœ… åç«¯æ£€æŸ¥
- [ ] ä¹°æ–­å `bargain_completed` ä¸º `true`
- [ ] ä¹°æ–­å `enable_bargain` ä¸º `false`
- [ ] ä¹°æ–­å `state` ä¸º `2`
- [ ] è®°å½•äº†ä¹°æ–­è€…ä¿¡æ¯
- [ ] è®°å½•äº†ä¹°æ–­ä»·æ ¼å’Œæ—¶é—´

### âœ… å‰ç«¯æ£€æŸ¥
- [ ] ä¹°æ–­åæ˜¾ç¤º"æ´»åŠ¨å·²ç»“æŸ"å¡ç‰‡
- [ ] ç ä»·å¡ç‰‡å·²éšè—
- [ ] æ˜¾ç¤ºä¹°æ–­è€…æ˜µç§°
- [ ] æ˜¾ç¤ºä¹°æ–­ä»·æ ¼
- [ ] å…¶ä»–ç”¨æˆ·çœ‹åˆ°ç›¸åŒçŠ¶æ€

### âœ… åŠŸèƒ½æ£€æŸ¥
- [ ] å…¶ä»–ç”¨æˆ·æ— æ³•ç»§ç»­ç ä»·
- [ ] ä¹°æ–­æŒ‰é’®å·²éšè—
- [ ] å¸®ç ä¸€åˆ€æŒ‰é’®å·²éšè—æˆ–ç¦ç”¨

---

## ğŸ“Š æ•°æ®åº“å­—æ®µå¯¹æ¯”

### ä¹°æ–­å‰ï¼š
```json
{
  "bargain_completed": false,
  "enable_bargain": true,
  "state": 1
}
```

### ä¹°æ–­åï¼š
```json
{
  "bargain_completed": true,
  "enable_bargain": false,
  "state": 2,
  "bargain_winner_id": "user123",
  "bargain_winner_nickname": "å¼ ä¸‰",
  "bargain_buyout_price": 95.98,
  "bargain_buyout_time": 1738033200000
}
```

---

## ğŸ‰ å®Œæˆæ ‡å¿—

å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹æƒ…å†µï¼Œè¯´æ˜åŠŸèƒ½å®Œå–„æˆåŠŸï¼š

âœ… ä¹°æ–­æ”¯ä»˜æˆåŠŸ
âœ… é¡µé¢åˆ·æ–°åæ˜¾ç¤º"æ´»åŠ¨å·²ç»“æŸ"
âœ… ç ä»·å¡ç‰‡å·²éšè—
âœ… å…¶ä»–ç”¨æˆ·çœ‹åˆ°"æ´»åŠ¨å·²ç»“æŸ"æç¤º
âœ… å…¶ä»–ç”¨æˆ·æ— æ³•ç»§ç»­ç ä»·
âœ… äº‘å‡½æ•°æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®æ›´æ–°äº†æ–‡ç« çŠ¶æ€

---

**ä¿®æ”¹æ—¥æœŸ**: 2026-01-26  
**ä¿®æ”¹æ–‡ä»¶æ•°**: 3ä¸ªäº‘å‡½æ•° + 1ä¸ªå‰ç«¯é¡µé¢  
**ä¿®æ”¹ç±»å‹**: åŠŸèƒ½å®Œå–„ + ç”¨æˆ·ä½“éªŒä¼˜åŒ–
