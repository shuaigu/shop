# 买断按钮权限修改说明

## ✅ 修改内容

### 需求
只允许小组长（砍价发起人）显示买断按钮，普通参与者不显示买断按钮。

---

## 📝 修改的文件

### 1. dianzan 组件（`components/dianzan/dianzan.vue`）

#### 修改 1：添加新的 prop 参数

**位置**：第 281-285 行

```vue
// 是否是小组长（发起人）- 只有小组长才能看到买断按钮
isInitiator: {
	type: Boolean,
	default: false
}
```

**说明**：新增一个布尔类型的属性，用于判断当前用户是否是小组长。

#### 修改 2：更新买断按钮的显示条件

**位置**：第 68-76 行

**修改前**：
```vue
<!-- 买断按钮（紧凑版，在价格后面） -->
<view 
	v-if="enableBuyout && !isBargainComplete && !isBargainExpired && currentPrice > 0"
	class="buyout-button-compact"
	:class="{ 'buyout-clicking': isBuyoutClicking }"
	@click="handleBuyoutClick"
>
	<text>买断</text>
</view>
```

**修改后**：
```vue
<!-- 买断按钮（紧凑版，在价格后面）- 只有小组长才能看到 -->
<view 
	v-if="enableBuyout && isInitiator && !isBargainComplete && !isBargainExpired && currentPrice > 0"
	class="buyout-button-compact"
	:class="{ 'buyout-clicking': isBuyoutClicking }"
	@click="handleBuyoutClick"
>
	<text>买断</text>
</view>
```

**关键变化**：在 `v-if` 条件中添加了 `&& isInitiator`，确保只有小组长才能看到买断按钮。

---

### 2. 文章详情页（`pages/article/articleDetail.vue`）

#### 修改：传递 isInitiator 参数给 dianzan 组件

**位置**：第 4278 行

**修改前**：
```vue
<dianzan 
	ref="dianzanBargainRef"
	mode="bargain"
	:articleId="articleDetail._id || props.article_id"
	...
	:enableBuyout="true"
	@update:liked="(val) => isArticleLiked = val"
	...
/>
```

**修改后**：
```vue
<dianzan 
	ref="dianzanBargainRef"
	mode="bargain"
	:articleId="articleDetail._id || props.article_id"
	...
	:enableBuyout="true"
	:isInitiator="isCurrentUserInitiator"
	@update:liked="(val) => isArticleLiked = val"
	...
/>
```

**关键变化**：新增 `:isInitiator="isCurrentUserInitiator"` 属性传递。

---

## 🎯 实现逻辑

### isCurrentUserInitiator 计算属性

这个计算属性已经存在于 `articleDetail.vue` 中（第 391-398 行）：

```javascript
// 检查当前用户是否是某个砍价小组的发起人（小组长）
const isCurrentUserInitiator = computed(() => {
	// 用户有自己发起的砍价小组，且该小组未完成、未买断
	if (userOwnGroup.value) {
		return !userOwnGroup.value.is_complete && !userOwnGroup.value.is_buyout
	}
	return false
})
```

**判断逻辑**：
1. ✅ 用户有自己发起的砍价小组（`userOwnGroup.value` 存在）
2. ✅ 小组未完成（`!is_complete`）
3. ✅ 小组未买断（`!is_buyout`）

满足以上条件时返回 `true`，用户为小组长且可以看到买断按钮。

---

## 🔍 显示逻辑总结

### 买断按钮的完整显示条件

```javascript
enableBuyout        // 买断功能已启用
&& isInitiator      // ✅ 新增：当前用户是小组长
&& !isBargainComplete  // 砍价未完成
&& !isBargainExpired   // 砍价未过期
&& currentPrice > 0    // 当前价格大于0
```

### 用户类型与显示规则

| 用户类型 | 条件 | 是否显示买断按钮 |
|---------|------|----------------|
| 小组长（发起人） | 自己发起的砍价小组，未完成、未买断 | ✅ 显示 |
| 普通参与者 | 帮别人砍价 | ❌ 不显示 |
| 未发起砍价的用户 | 没有发起过砍价 | ❌ 不显示 |
| 已完成砍价的用户 | 小组已完成或已买断 | ❌ 不显示 |

---

## 🧪 测试验证

### 测试场景 1：小组长查看自己的砍价

**操作**：
1. 用户 A 发起砍价
2. 用户 A 查看文章详情页

**预期结果**：
- ✅ 显示"买断"按钮
- ✅ 可以点击买断按钮
- ✅ 买断价格为当前剩余价格

### 测试场景 2：普通参与者查看

**操作**：
1. 用户 A 发起砍价
2. 用户 B 帮用户 A 砍价
3. 用户 B 查看文章详情页

**预期结果**：
- ❌ **不显示**"买断"按钮
- ✅ 只显示"帮砍一刀"按钮

### 测试场景 3：未参与的用户

**操作**：
1. 用户 C 查看有砍价活动的文章
2. 用户 C 没有发起过砍价

**预期结果**：
- ❌ **不显示**"买断"按钮
- ✅ 显示"帮砍一刀"按钮

### 测试场景 4：已完成的小组长

**操作**：
1. 用户 A 发起砍价并完成
2. 用户 A 再次查看文章详情页

**预期结果**：
- ❌ **不显示**"买断"按钮（因为已完成）
- ✅ 显示"砍价成功"相关提示

---

## 📋 部署步骤

### 无需特殊部署

这两个文件都是前端文件，修改后：

1. **小程序开发工具**
   - 直接保存文件
   - 点击"编译"按钮
   - 真机预览测试

2. **云端部署**
   - 无需上传云函数
   - 直接上传小程序代码即可

---

## 💡 技术要点

### 1. 组件间通信
- 父组件（articleDetail.vue）通过 props 向子组件（dianzan.vue）传递数据
- 使用计算属性 `isCurrentUserInitiator` 实时计算用户权限

### 2. 权限判断
- 在前端通过用户的砍价小组数据判断权限
- 避免普通用户误点击买断按钮

### 3. 用户体验
- 小组长：看到买断按钮，可以选择直接买断
- 普通用户：界面更简洁，不会被无关按钮干扰

---

## ⚠️ 注意事项

### 1. 安全性
虽然前端隐藏了买断按钮，但后端云函数中已经有完整的权限验证：
- `handleBuyout` 函数中会验证用户是否有权限买断
- 即使前端被绕过，后端也会拒绝非法请求

### 2. 数据同步
- `userOwnGroup` 数据会在用户登录、文章加载时自动更新
- 确保 `isCurrentUserInitiator` 始终反映最新状态

### 3. 边界情况
- 用户登出：`isCurrentUserInitiator` 自动变为 `false`
- 小组完成：`isCurrentUserInitiator` 自动变为 `false`
- 买断完成：`isCurrentUserInitiator` 自动变为 `false`

---

## 🎉 修改完成

**修改文件**：
- ✅ `components/dianzan/dianzan.vue` - 添加 `isInitiator` prop 和显示逻辑
- ✅ `pages/article/articleDetail.vue` - 传递 `isCurrentUserInitiator` 参数

**预期效果**：
- ✅ 只有小组长能看到买断按钮
- ✅ 普通参与者不显示买断按钮
- ✅ 界面更清晰，权限更明确

**现在可以直接测试了！** 🚀
