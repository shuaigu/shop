# 🎉 商家转账配置已完成！

## ✅ 配置摘要

### 自动配置完成时间
**2026年1月29日 09:56:37**

### 配置参数
```
✅ 小程序APPID: wxf7ee79349bd957b8
✅ 商户号: 1545803671
✅ 证书序列号: 7282272EC446E827251B9FBAC2757DE1897026D3
✅ APIv3密钥: ***已配置*** (32位)
✅ 商户私钥: ***已配置*** (1708字符)
✅ 平台证书: ***已配置*** (已自动获取)
✅ 转账场景ID: 1001 (分销返佣)
```

---

## 📁 生成的文件

### 1. 配置文件
```
位置: wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-config.js
状态: ✅ 已生成
用途: 存储所有商家转账配置参数
```

### 2. 处理器文件
```
位置: wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-handler-v3.js
状态: ✅ 已更新（自动加载配置）
用途: 处理商家转账到零钱的核心逻辑
```

### 3. 配置脚本
```
位置: setupCashback.js
状态: ✅ 已运行成功
用途: 自动提取证书信息并获取平台证书
```

---

## 🚀 下一步操作

### 第1步：上传云函数（5分钟）

需要上传以下文件到uniCloud：

```
wx2/uniCloud-aliyun/cloudfunctions/articleWx/
├── index.obj.js                    ← 已修改
├── cashback-handler-v3.js          ← 已更新
├── cashback-config.js              ← 🆕 新增（重要！）
└── package.json
```

**操作步骤**：
1. 打开 HBuilderX
2. 右键点击 `articleWx` 云函数文件夹
3. 选择"上传部署"
4. 等待上传完成

---

### 第2步：测试转账功能（10分钟）

#### 方法A：uniCloud Web控制台测试（推荐）

1. 登录 uniCloud Web控制台
2. 选择云函数 → articleWx
3. 点击"云函数调试"
4. 输入测试参数：

```json
{
  "action": "processCashback",
  "bargain_record_id": "test_record_123",
  "user_id": "test_user_456"
}
```

5. 点击"运行"查看结果

#### 方法B：小程序中测试

```javascript
// 在小程序代码中调用
const articleWx = uniCloud.importObject('articleWx');

const result = await articleWx.processCashback(
  'bargain_record_id',  // 砍价记录ID
  'user_id'             // 用户ID
);

console.log('返现结果:', result);
```

**注意**：测试前确保：
- ✅ 用户已购买（buyout_orders 表中 status = 1）
- ✅ 用户有 openid（uni-id-users 表中）
- ✅ 商户账户余额充足
- ✅ 用户已完成微信实名认证

---

### 第3步：配置定时任务（5分钟）

#### 创建定时任务云函数

1. 创建新云函数 `batchCashback`
2. 代码内容：

```javascript
'use strict';

exports.main = async (event, context) => {
  console.log('开始批量处理返现...');
  
  const articleWx = uniCloud.importObject('articleWx');
  const result = await articleWx.batchProcessCashbacks();
  
  console.log('批量返现处理完成:', result);
  return result;
};
```

#### 配置触发器

```
触发器类型: 定时触发
Cron表达式: 0 * * * * * *
说明: 每分钟执行一次
```

**Cron表达式说明**：
- `0 * * * * * *` = 每分钟第0秒执行
- `0 */5 * * * * *` = 每5分钟执行一次（如果返现量大，可以用这个）

---

## 🔍 功能测试清单

### 基础功能测试

- [ ] **测试1：未购买用户砍价**
  ```
  预期：提示"小组长还未购买，无法获得返现"
  ```

- [ ] **测试2：已购买用户砍价**
  ```
  预期：创建返现记录，cashback_status = 0
  ```

- [ ] **测试3：单次返现处理**
  ```
  预期：返现成功，用户微信零钱到账
  ```

- [ ] **测试4：批量返现处理**
  ```
  预期：定时任务自动处理所有待返现记录
  ```

- [ ] **测试5：返现达到上限**
  ```
  预期：提示"返现已达上限"
  ```

### 边界测试

- [ ] **测试6：重复砍价**
  ```
  预期：提示"您已经帮TA砍过价了"
  ```

- [ ] **测试7：自己帮自己砍**
  ```
  预期：提示"不能帮自己砍价"
  ```

- [ ] **测试8：金额验证**
  ```
  预期：单笔0.10-500元，超出范围拒绝
  ```

---

## 📊 监控指标

### 关键指标

建议监控以下数据：

1. **返现成功率**
   ```sql
   SELECT 
     COUNT(*) as total,
     SUM(CASE WHEN cashback_status = 1 THEN 1 ELSE 0 END) as success,
     SUM(CASE WHEN cashback_status = 2 THEN 1 ELSE 0 END) as failed
   FROM kanjia
   WHERE cashback_amount > 0
   ```

2. **每日返现金额**
   ```sql
   SELECT 
     DATE(create_time) as date,
     SUM(cashback_amount) as total_amount,
     COUNT(*) as count
   FROM kanjia
   WHERE cashback_status = 1
   GROUP BY DATE(create_time)
   ```

3. **待返现记录数**
   ```sql
   SELECT COUNT(*) 
   FROM kanjia
   WHERE cashback_status = 0 AND cashback_amount > 0
   ```

---

## ⚠️ 重要提醒

### 安全注意事项

1. **配置文件保密**
   - ❗ `cashback-config.js` 包含敏感信息
   - ❗ 不要提交到 Git 仓库
   - ❗ 建议添加到 `.gitignore`

2. **API密钥管理**
   - ✅ 定期更换 APIv3密钥（建议3-6个月）
   - ✅ 证书到期前及时更新
   - ✅ 发现泄露立即更换

3. **返现风控**
   - ✅ 监控异常返现行为
   - ✅ 设置单用户每日返现上限
   - ✅ 记录完整的返现日志

### 限额提醒

根据您的商户配置：

```
单笔限额: 0.10元 - 500元
用户单日: 20,000元
商户单日: 100,000元
```

**建议**：
- 设置砍价单笔返现不超过100元
- 监控接近限额时及时调整
- 预留10%安全余量

---

## 🆘 常见问题

### Q1: 返现失败怎么办？

**A**: 检查以下几点：
1. 用户是否有 openid
2. 用户是否已完成微信实名认证
3. 商户账户余额是否充足
4. 返现金额是否在限额内
5. 查看云函数日志中的错误信息

### Q2: 如何查看返现记录？

**A**: 
```
方式1：商户平台
产品中心 → 商家转账到零钱 → 转账记录

方式2：数据库查询
SELECT * FROM kanjia 
WHERE cashback_status = 1 
ORDER BY cashback_time DESC
```

### Q3: 定时任务不执行怎么办？

**A**: 
1. 检查触发器是否启用
2. 查看云函数日志
3. 确认 Cron 表达式正确
4. 手动测试云函数是否正常

### Q4: 用户没收到返现通知？

**A**: 
- 返现到账后，微信会自动发送通知
- 用户在"微信支付-账单"中可以查看
- 建议在小程序内也显示返现记录

---

## 📞 技术支持

### 官方渠道

- **客服热线**: 95017
- **在线客服**: 商户平台右下角
- **开发者社区**: https://developers.weixin.qq.com/community/pay

### 文档资源

- `商家转账V3配置指南.md` - 详细配置文档
- `砍价返现逻辑修改说明.md` - 业务逻辑说明
- `快速开始指南.md` - 快速上手指南

---

## ✨ 恭喜！

您的商家转账功能已配置完成！现在只需：

1. ✅ 上传云函数（5分钟）
2. ✅ 测试转账（10分钟）
3. ✅ 配置定时任务（5分钟）

**总计约20分钟**即可上线！🚀

祝您使用愉快！有任何问题随时查看文档或联系技术支持。

---

**配置完成时间**: 2026-01-29 09:56:37  
**文档版本**: v1.0  
**下一步**: 上传云函数并测试
