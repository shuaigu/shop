# ğŸ’° å•†å®¶è½¬è´¦æµ‹è¯•éƒ¨ç½²è¯´æ˜

## âœ… å·²å®Œæˆçš„é…ç½®

### 1. é…ç½®æ–‡ä»¶
**ä½ç½®**: `wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-config.js`

```javascript
âœ… appid: wxf7ee79349bd957b8
âœ… mchid: 1545803671
âœ… serial_no: 7282272EC446E827251B9FBAC2757DE1897026D3
âœ… apiv3_key: lishuai4323811lishuai4323811lish (32ä½)
âœ… private_key: å·²é…ç½®å®Œæ•´ç§é’¥ (1708å­—ç¬¦)
âœ… platform_cert: å·²é…ç½®å¹³å°è¯ä¹¦
âœ… transfer_scene_id: 1001 (åˆ†é”€è¿”ä½£åœºæ™¯)
```

### 2. æ ¸å¿ƒæ–‡ä»¶æ¸…å•
- âœ… `cashback-config.js` - é…ç½®æ–‡ä»¶
- âœ… `cashback-handler-v3.js` - V3 APIå¤„ç†å™¨
- âœ… `index.obj.js` - äº‘å‡½æ•°å…¥å£ï¼ˆå·²æ·»åŠ testCashbackTransferæ–¹æ³•ï¼‰
- âœ… `pages/article/testCashback.vue` - æµ‹è¯•é¡µé¢
- âœ… `pages.json` - å·²æ³¨å†Œæµ‹è¯•é¡µé¢è·¯ç”±

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ äº‘å‡½æ•°

1. æ‰“å¼€ HBuilderX
2. æ‰¾åˆ°é¡¹ç›®ï¼š`wx2/uniCloud-aliyun/cloudfunctions/articleWx`
3. å³é”®ç‚¹å‡» `articleWx` æ–‡ä»¶å¤¹
4. é€‰æ‹© **"ä¸Šä¼ éƒ¨ç½²"** â†’ **"ä¸Šä¼ éƒ¨ç½²äº‘å‡½æ•°ï¼ˆäº‘ç«¯å®‰è£…ä¾èµ–ï¼‰"**
5. ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

ä¸Šä¼ æˆåŠŸåä¼šæ˜¾ç¤ºï¼š
```
âœ… äº‘å‡½æ•° articleWx ä¸Šä¼ æˆåŠŸ
âœ… ä¾èµ–å®‰è£…æˆåŠŸ
```

### ç¬¬äºŒæ­¥ï¼šè¿è¡Œå°ç¨‹åº

1. åœ¨ HBuilderX ä¸­ç‚¹å‡» **"è¿è¡Œ"** â†’ **"è¿è¡Œåˆ°å°ç¨‹åºæ¨¡æ‹Ÿå™¨"** â†’ **"å¾®ä¿¡å¼€å‘è€…å·¥å…·"**
2. ç­‰å¾…ç¼–è¯‘å®Œæˆ
3. ç¡®ä¿å·²ç™»å½•ï¼ˆæµ‹è¯•éœ€è¦è·å–ç”¨æˆ·çš„openidï¼‰

### ç¬¬ä¸‰æ­¥ï¼šè®¿é—®æµ‹è¯•é¡µé¢

æœ‰ä¸¤ç§æ–¹å¼è®¿é—®æµ‹è¯•é¡µé¢ï¼š

#### æ–¹å¼ä¸€ï¼šç›´æ¥è·³è½¬ï¼ˆæ¨èæµ‹è¯•æ—¶ä½¿ç”¨ï¼‰
åœ¨ä»»æ„é¡µé¢çš„å¼€å‘è€…å·¥å…·æ§åˆ¶å°è¾“å…¥ï¼š
```javascript
uni.navigateTo({
  url: '/pages/article/testCashback'
})
```

#### æ–¹å¼äºŒï¼šæ·»åŠ æµ‹è¯•å…¥å£ï¼ˆå¯é€‰ï¼‰
åœ¨ `pages/my/my.vue`ï¼ˆä¸ªäººä¸­å¿ƒï¼‰æ·»åŠ ä¸€ä¸ªæµ‹è¯•æŒ‰é’®ï¼š
```vue
<button @click="goTest">ğŸ’° è½¬è´¦æµ‹è¯•</button>

// methodsä¸­æ·»åŠ 
goTest() {
  uni.navigateTo({
    url: '/pages/article/testCashback'
  })
}
```

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### 1. è¿›å…¥æµ‹è¯•é¡µé¢
- æ ‡é¢˜ï¼š**ğŸ’° å•†å®¶è½¬è´¦æµ‹è¯•**
- ç•Œé¢åŒ…å«ï¼š
  - è½¬è´¦é‡‘é¢è¾“å…¥æ¡†ï¼ˆé»˜è®¤0.3å…ƒï¼‰
  - è½¬è´¦å¤‡æ³¨è¾“å…¥æ¡†ï¼ˆé»˜è®¤"æµ‹è¯•è½¬è´¦"ï¼‰
  - æµ‹è¯•è½¬è´¦æŒ‰é’®

### 2. è¾“å…¥æµ‹è¯•å‚æ•°
```
è½¬è´¦é‡‘é¢ï¼š0.3  (å»ºè®®å…ˆç”¨å°é¢æµ‹è¯•)
è½¬è´¦å¤‡æ³¨ï¼šæµ‹è¯•è½¬è´¦
```

**é‡‘é¢é™åˆ¶**ï¼š
- âœ… æœ€å°ï¼š0.10å…ƒ
- âœ… æœ€å¤§ï¼š500å…ƒ
- âœ… å•ç”¨æˆ·å•æ—¥æœ€é«˜ï¼š20,000å…ƒ
- âœ… å•†æˆ·å•æ—¥æœ€é«˜ï¼š100,000å…ƒ

### 3. ç‚¹å‡»"æµ‹è¯•è½¬è´¦"æŒ‰é’®

ç³»ç»Ÿä¼šï¼š
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. è·å–ç”¨æˆ·openid
3. è°ƒç”¨å¾®ä¿¡å•†å®¶è½¬è´¦V3 API
4. å®æ—¶æ˜¾ç¤ºæ—¥å¿—å’Œç»“æœ

### 4. æŸ¥çœ‹æµ‹è¯•ç»“æœ

#### æˆåŠŸç¤ºä¾‹ï¼š
```
âœ… è½¬è´¦æˆåŠŸï¼
{
  "transaction_id": "BATCH1738123456ABCDEF",
  "amount": 0.3,
  "process_time": "1250ms",
  "openid": "oABC123***"
}
```

ç”¨æˆ·å¾®ä¿¡ä¼šæ”¶åˆ°ï¼š
```
ã€å¾®ä¿¡æ”¯ä»˜ã€‘æ‚¨æ”¶åˆ°ä¸€ç¬”è½¬è´¦
é‡‘é¢ï¼šÂ¥0.30
å¤‡æ³¨ï¼šæµ‹è¯•è½¬è´¦
å•†æˆ·åç§°ï¼š[æ‚¨çš„å•†æˆ·åç§°]
```

#### å¤±è´¥ç¤ºä¾‹ï¼š
```
âŒ è½¬è´¦å¤±è´¥: PARAM_ERROR - å‚æ•°é”™è¯¯
```

---

## ğŸ“Š æŸ¥çœ‹è½¬è´¦è®°å½•

### æ–¹å¼ä¸€ï¼šå¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°
1. ç™»å½• https://pay.weixin.qq.com
2. ç‚¹å‡» **äº§å“ä¸­å¿ƒ** â†’ **å•†å®¶è½¬è´¦åˆ°é›¶é’±**
3. ç‚¹å‡» **è½¬è´¦è®°å½•**
4. æŸ¥çœ‹åˆšæ‰çš„æµ‹è¯•è½¬è´¦è®°å½•

### æ–¹å¼äºŒï¼šäº‘å‡½æ•°æ—¥å¿—
1. æ‰“å¼€ uniCloud Webæ§åˆ¶å°
2. è¿›å…¥ **äº‘å‡½æ•°** â†’ **articleWx** â†’ **æ—¥å¿—**
3. æŸ¥çœ‹è¯¦ç»†çš„è½¬è´¦æ—¥å¿—ï¼š
```
ğŸ§ª å¼€å§‹æµ‹è¯•è½¬è´¦: { amount: 0.3, desc: 'æµ‹è¯•è½¬è´¦' }
å½“å‰ç”¨æˆ·ID: user_xxx
ç”¨æˆ·openid: oABC123***
å•†å®¶è½¬è´¦è¯·æ±‚å‚æ•°ï¼ˆV3ï¼‰: { batch_no: 'BATCH...', ... }
âœ… å•†å®¶è½¬è´¦æˆåŠŸï¼ˆV3ï¼‰: { batch_id: '...', ... }
âœ… æµ‹è¯•è½¬è´¦æˆåŠŸ!
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. æç¤º"ç”¨æˆ·æœªç™»å½•"
**åŸå› **: æ²¡æœ‰ç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ
**è§£å†³**: é‡æ–°ç™»å½•å°ç¨‹åº

### 2. æç¤º"openidä¸å­˜åœ¨"
**åŸå› **: ç”¨æˆ·ä¿¡æ¯ä¸­æ²¡æœ‰openid
**è§£å†³**: 
- é‡æ–°æˆæƒç™»å½•
- æ£€æŸ¥ç™»å½•æ—¶æ˜¯å¦æˆåŠŸä¿å­˜äº† wx_openid

### 3. è½¬è´¦å¤±è´¥ï¼šSIGN_ERRORï¼ˆç­¾åé”™è¯¯ï¼‰
**åŸå› **: é…ç½®å‚æ•°é”™è¯¯
**æ£€æŸ¥**:
- serial_no æ˜¯å¦æ­£ç¡®
- private_key æ˜¯å¦å®Œæ•´
- apiv3_key æ˜¯å¦æ­£ç¡®ï¼ˆå¿…é¡»32ä½ï¼‰

### 4. è½¬è´¦å¤±è´¥ï¼šPARAM_ERRORï¼ˆå‚æ•°é”™è¯¯ï¼‰
**åŸå› **: è¯·æ±‚å‚æ•°ä¸ç¬¦åˆè¦æ±‚
**æ£€æŸ¥**:
- é‡‘é¢æ˜¯å¦åœ¨ 0.10-500 å…ƒä¹‹é—´
- transfer_scene_id æ˜¯å¦ä¸ºå·²å¼€é€šçš„åœºæ™¯ï¼ˆ1001ï¼‰

### 5. è½¬è´¦å¤±è´¥ï¼šACCOUNT_BALANCE_NOT_ENOUGHï¼ˆä½™é¢ä¸è¶³ï¼‰
**åŸå› **: å•†æˆ·è´¦æˆ·ä½™é¢ä¸è¶³
**è§£å†³**: ç™»å½•å•†æˆ·å¹³å°å……å€¼

### 6. è½¬è´¦å¤±è´¥ï¼šFREQUENCY_LIMITEDï¼ˆé¢‘ç‡è¶…é™ï¼‰
**åŸå› **: è¯·æ±‚å¤ªé¢‘ç¹
**è§£å†³**: ç­‰å¾…1-2åˆ†é’Ÿåå†è¯•

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—
```javascript
// äº‘å‡½æ•°ä¼šæ‰“å°è¯¦ç»†æ—¥å¿—
console.log('ğŸ§ª å¼€å§‹æµ‹è¯•è½¬è´¦:', { amount, desc })
console.log('å½“å‰ç”¨æˆ·ID:', userId)
console.log('ç”¨æˆ·openid:', openid)
console.log('å•†å®¶è½¬è´¦è¯·æ±‚å‚æ•°ï¼ˆV3ï¼‰:', requestData)
```

### 2. æŸ¥çœ‹å°ç¨‹åºæ§åˆ¶å°
æµ‹è¯•é¡µé¢ä¼šå®æ—¶æ˜¾ç¤ºæ—¥å¿—ï¼š
```
[14:30:00] å¼€å§‹æµ‹è¯•
[14:30:01] é‡‘é¢: 0.3
[14:30:01] è°ƒç”¨äº‘å‡½æ•°...
[14:30:03] è°ƒç”¨å®Œæˆ
```

### 3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
åœ¨å¼€å‘è€…å·¥å…·çš„ **Network** æ ‡ç­¾é¡µä¸­ï¼š
- æŸ¥çœ‹äº‘å‡½æ•°è°ƒç”¨è¯·æ±‚
- æŸ¥çœ‹å“åº”å†…å®¹

---

## ğŸ“‹ æµ‹è¯•æ¸…å•

### åŸºç¡€æµ‹è¯•
- [ ] å°é¢è½¬è´¦ï¼ˆ0.3å…ƒï¼‰
- [ ] ä¸­é¢è½¬è´¦ï¼ˆ10å…ƒï¼‰
- [ ] å¤§é¢è½¬è´¦ï¼ˆ100å…ƒï¼‰
- [ ] è¾¹ç•Œæµ‹è¯•ï¼ˆ0.1å…ƒ / 500å…ƒï¼‰

### å¼‚å¸¸æµ‹è¯•
- [ ] é‡‘é¢ä¸º0
- [ ] é‡‘é¢å°äº0.1å…ƒ
- [ ] é‡‘é¢è¶…è¿‡500å…ƒ
- [ ] æœªç™»å½•çŠ¶æ€
- [ ] æ— openidç”¨æˆ·

### æ€§èƒ½æµ‹è¯•
- [ ] æŸ¥çœ‹è½¬è´¦è€—æ—¶ï¼ˆé€šå¸¸1-2ç§’ï¼‰
- [ ] è¿ç»­è½¬è´¦æµ‹è¯•ï¼ˆé—´éš”5ç§’ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### æµ‹è¯•æˆåŠŸå
1. âœ… éªŒè¯é…ç½®æ­£ç¡®
2. âœ… APIè°ƒç”¨æ­£å¸¸
3. âœ… å¯ä»¥å¼€å§‹å®ç°ç ä»·è¿”ç°ä¸šåŠ¡é€»è¾‘

### é›†æˆåˆ°ç ä»·è¿”ç°
åœ¨ `processCashback` æ–¹æ³•ä¸­è°ƒç”¨ï¼š
```javascript
const cashbackHandler = new CashbackHandlerV3();
const result = await cashbackHandler.processCashback({
  bargain_record_id: record_id,
  user_id: user_id,
  openid: openid,
  amount: cashback_amount,
  desc: 'ç ä»·è¿”ç°'
});
```

### å®šæ—¶ä»»åŠ¡é…ç½®
åˆ›å»ºå®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†å¾…è¿”ç°è®°å½•ï¼š
```javascript
// æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
exports.main = async (event, context) => {
  const cashbackHandler = new CashbackHandlerV3();
  return await cashbackHandler.processPendingCashbacks();
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¾®ä¿¡æ”¯ä»˜ç›¸å…³
- å®¢æœçƒ­çº¿ï¼š95017
- å•†æˆ·å¹³å°ï¼šhttps://pay.weixin.qq.com
- åœ¨çº¿å®¢æœï¼šå•†æˆ·å¹³å°å³ä¸‹è§’

### APIæ–‡æ¡£
- V3è½¬è´¦APIï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter4_3_1.shtml
- ç­¾åéªŒç­¾ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml
- å¹³å°è¯ä¹¦ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay5_1.shtml

---

## ğŸ“ æ›´æ–°è®°å½•

### 2026-01-29
- âœ… å®ŒæˆV3 APIé…ç½®
- âœ… å®ç°è½¬è´¦å¤„ç†å™¨
- âœ… åˆ›å»ºæµ‹è¯•é¡µé¢
- âœ… æ·»åŠ æµ‹è¯•æ–¹æ³•
- âœ… å®Œæˆéƒ¨ç½²è¯´æ˜

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸ‰**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚
