# 砍价返现功能 - 完整实施方案

## 📋 项目概述

将传统的"砍价降价"模式升级为"原价购买+砍价返现"模式。

### 业务流程对比

| 原模式 | 新模式 |
|--------|--------|
| 1. 发起砍价 | 1. **原价购买** |
| 2. 好友帮砍 → 降价 | 2. 成为小组长 |
| 3. 砍到一定金额 → 买断支付剩余金额 | 3. 分享给好友帮砍 |
| - | 4. **每砍一刀，返现给小组长** |
| - | 5. 最多返现到原价（免费得） |

---

## ✅ 实施状态

### 🎉 已完成（100%）

#### 1. 代码开发（✅ 完成）

- ✅ 数据库Schema修改
  - `kanjia` 表：添加返现字段
  - `buyout_orders` 表：添加返现追踪
  
- ✅ 核心业务逻辑
  - 砍价改为返现
  - 订单改为原价购买
  - 支付回调更新
  
- ✅ 前端显示优化
  - "已砍" → "已返现"
  - "当前价格" → "剩余可返现"
  - 所有相关文案更新

#### 2. 返现功能（✅ 完成）

- ✅ V3 API 集成
  - `cashback-handler-v3.js`（推荐使用）
  - `cashback-handler.js`（V2备用）
  
- ✅ 自动配置工具
  - `setupCashback.js`（已运行成功）
  - 自动提取证书信息
  - 自动获取平台证书

#### 3. 配置完成（✅ 完成）

- ✅ 商户配置
  ```
  小程序APPID: wxf7ee79349bd957b8
  商户号: 1545803671
  证书序列号: 7282272EC446E827251B9FBAC2757DE1897026D3
  APIv3密钥: 已配置
  商户私钥: 已配置
  平台证书: 已获取
  ```

- ✅ 配置文件生成
  ```
  cashback-config.js（已生成）
  ```

#### 4. 文档完善（✅ 完成）

- 📖 `砍价返现逻辑修改说明.md` - 主文档
- 📖 `商家转账V3配置指南.md` - V3配置详解
- 📖 `企业付款到零钱配置指南.md` - V2参考
- 📖 `快速开始指南.md` - 快速上手
- 📖 `配置完成说明.md` - 下一步指引
- 📖 本文档 - 项目总览

---

## 🚀 部署步骤（约20分钟）

### 第1步：上传云函数（5分钟）

上传以下文件到 uniCloud：

```
wx2/uniCloud-aliyun/cloudfunctions/articleWx/
├── index.obj.js                ✅ 已修改
├── cashback-handler-v3.js      ✅ 已更新  
├── cashback-config.js          🆕 新增（重要！）
└── package.json
```

**操作**：
1. 打开 HBuilderX
2. 右键 `articleWx` 文件夹
3. 选择"上传部署"

### 第2步：测试转账（10分钟）

#### 准备工作
- [ ] 确保测试用户已购买
- [ ] 确保用户有 openid
- [ ] 确保商户账户有余额
- [ ] 确保用户已实名认证

#### 测试方法
```javascript
// uniCloud控制台
const articleWx = uniCloud.importObject('articleWx');
const result = await articleWx.processCashback('record_id', 'user_id');
console.log(result);
```

### 第3步：配置定时任务（5分钟）

创建云函数 `batchCashback`：

```javascript
exports.main = async (event, context) => {
  const articleWx = uniCloud.importObject('articleWx');
  return await articleWx.batchProcessCashbacks();
};
```

配置触发器：
```
Cron: 0 * * * * * *（每分钟）
```

---

## 📂 文件清单

### 修改的文件（5个）

| 文件 | 状态 | 说明 |
|------|------|------|
| `uniCloud-aliyun/database/kanjia.schema.json` | ✅ 已修改 | 添加返现字段 |
| `uniCloud-aliyun/database/buyout_orders.schema.json` | ✅ 已修改 | 添加返现追踪 |
| `uniCloud-aliyun/cloudfunctions/articleWx/index.obj.js` | ✅ 已修改 | 核心逻辑 |
| `uni_modules/uni-pay/.../recharge.js` | ✅ 已修改 | 支付回调 |
| `components/dianzan/dianzan.vue` | ✅ 已修改 | 前端显示 |

### 新增的文件（8个）

| 文件 | 状态 | 说明 |
|------|------|------|
| `cashback-handler.js` | ✅ 已创建 | V2返现处理器（备用） |
| `cashback-handler-v3.js` | ✅ 已创建 | V3返现处理器（推荐） |
| `cashback-config.js` | ✅ 已生成 | 配置文件（重要！） |
| `setupCashback.js` | ✅ 已创建 | 配置脚本 |
| `砍价返现逻辑修改说明.md` | ✅ 已创建 | 主文档 |
| `商家转账V3配置指南.md` | ✅ 已创建 | V3配置 |
| `企业付款到零钱配置指南.md` | ✅ 已创建 | V2参考 |
| `快速开始指南.md` | ✅ 已创建 | 快速上手 |
| `配置完成说明.md` | ✅ 已创建 | 下一步指引 |
| 本文档 | ✅ 已创建 | 项目总览 |

---

## 🔍 功能特性

### 用户端

- ✅ 先购买后返现，风险更低
- ✅ 可以无限接近免费（最多返现到原价）
- ✅ 返现直接到微信零钱，可立即使用
- ✅ 分享激励更强，传播更广

### 商家端

- ✅ 提前收款，资金更安全
- ✅ 激励用户分享，增加传播
- ✅ 用户粘性更强，复购率更高
- ✅ 自动化返现，无需人工干预

### 技术优势

- ✅ 使用微信V3 API，更稳定安全
- ✅ 异步返现，响应速度快
- ✅ 完善的错误处理和重试机制
- ✅ 详细的日志和监控

---

## 💰 限额说明

根据您的商户配置：

| 限额类型 | 额度 |
|----------|------|
| 单笔最小 | 0.10元 |
| 单笔最大 | 500元 |
| 用户单日 | 20,000元 |
| 商户单日 | 100,000元 |
| 免密额度 | 100元 |

---

## 📊 数据结构

### kanjia 表（砍价记录）

新增字段：
- `cashback_amount` - 本次返现金额
- `cashback_status` - 返现状态（0待返现，1已返现，2失败）
- `cashback_time` - 返现时间
- `transaction_id` - 转账单号
- `cashback_error` - 失败原因

### buyout_orders 表（订单）

新增字段：
- `original_price` - 原价
- `total_cashback` - 累计返现
- `cashback_limit` - 返现上限
- `is_cashback_complete` - 是否达上限

---

## 🔧 技术支持

### 文档查询

1. **快速上手** → `快速开始指南.md`
2. **详细配置** → `商家转账V3配置指南.md`
3. **业务逻辑** → `砍价返现逻辑修改说明.md`
4. **部署步骤** → `配置完成说明.md`

### 问题排查

| 问题 | 查看文档 |
|------|----------|
| 如何配置？ | `商家转账V3配置指南.md` |
| 返现失败？ | `配置完成说明.md` 常见问题 |
| 业务逻辑？ | `砍价返现逻辑修改说明.md` |
| 快速测试？ | `快速开始指南.md` |

### 官方支持

- **客服热线**: 95017
- **在线客服**: 商户平台
- **开发者社区**: developers.weixin.qq.com

---

## ⚠️ 安全提醒

### 配置文件

- ❗ `cashback-config.js` 包含敏感信息
- ❗ 不要提交到 Git 仓库
- ❗ 建议添加到 `.gitignore`

### API密钥

- ✅ 定期更换（建议3-6个月）
- ✅ 证书到期前及时更新
- ✅ 发现泄露立即更换

### 风控监控

- ✅ 监控异常返现行为
- ✅ 设置单用户每日上限
- ✅ 记录完整日志

---

## 📈 监控建议

### 关键指标

1. **返现成功率** - 目标 > 95%
2. **平均处理时间** - 目标 < 3秒
3. **每日返现总额** - 监控是否接近限额
4. **失败原因分布** - 及时优化

### 日志查询

```javascript
// 查看待返现
SELECT * FROM kanjia 
WHERE cashback_status = 0 AND cashback_amount > 0;

// 查看返现统计
SELECT 
  DATE(cashback_time) as date,
  COUNT(*) as count,
  SUM(cashback_amount) as total
FROM kanjia
WHERE cashback_status = 1
GROUP BY DATE(cashback_time);
```

---

## 🎯 核心优势总结

### 为什么选择这个方案？

1. **业务模式升级**
   - 从"砍价降价"到"原价购买+返现"
   - 商家提前回款，风险更低
   - 用户激励更强，传播更广

2. **技术方案先进**
   - 使用微信V3 API（官方推荐）
   - 完整的错误处理和重试
   - 自动化程度高

3. **实施成本低**
   - 代码已全部完成
   - 配置已自动生成
   - 文档详细完善
   - 20分钟即可上线

4. **可维护性强**
   - 代码结构清晰
   - 文档完整详细
   - 易于调试和监控

---

## 🎉 恭喜！

### 项目完成度：100%

✅ 业务逻辑设计  
✅ 数据库设计  
✅ 代码开发  
✅ 返现功能集成  
✅ 自动配置工具  
✅ 配置完成  
✅ 文档编写  

### 现在只需：

1. ⏱️ 上传云函数（5分钟）
2. ⏱️ 测试转账（10分钟）
3. ⏱️ 配置定时任务（5分钟）

**总计：20分钟上线！** 🚀

---

## 📞 获取帮助

有任何问题？

1. 📖 查看对应的文档文件
2. 🔍 搜索文档中的常见问题
3. 📞 联系微信支付技术支持
4. 💬 在开发者社区提问

---

**项目完成时间**: 2026-01-29  
**文档版本**: v1.0  
**下一步**: 查看《配置完成说明.md》开始部署

**祝您使用愉快！** 🎊
