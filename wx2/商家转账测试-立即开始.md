# 🚀 商家转账测试 - 立即开始

## ✅ 准备工作（已完成）

- ✅ 配置文件：`cashback-config.js`（已配置完成）
- ✅ 转账处理器：`cashback-handler-v3.js`（V3 API）
- ✅ 云函数接口：`testCashbackTransfer` 方法
- ✅ 测试页面：`pages/article/testCashback.vue`（全新UI）

---

## 📦 第一步：上传云函数

### 在 HBuilderX 中：

1. 找到目录：`wx2/uniCloud-aliyun/cloudfunctions/articleWx`
2. **右键点击** `articleWx` 文件夹
3. 选择：**"上传部署"** → **"上传部署云函数（云端安装依赖）"**
4. 等待提示：**"上传成功"**

⏱️ 预计耗时：1-2分钟

---

## 🏃 第二步：运行小程序

### 在 HBuilderX 中：

1. 点击菜单：**"运行"** → **"运行到小程序模拟器"** → **"微信开发者工具"**
2. 等待编译完成
3. 确保已登录小程序

---

## 📱 第三步：访问测试页面

### 方式一：控制台跳转（推荐）

在微信开发者工具的 **Console** 标签页中输入：

```javascript
uni.navigateTo({
  url: '/pages/article/testCashback'
})
```

### 方式二：手动添加入口

在个人中心页面添加一个按钮：

```vue
<button @click="goTest">💰 转账测试</button>

<script>
export default {
  methods: {
    goTest() {
      uni.navigateTo({
        url: '/pages/article/testCashback'
      })
    }
  }
}
</script>
```

---

## 🧪 第四步：执行测试

### 页面功能说明：

#### 1. **用户信息区域**（顶部紫色卡片）
- 自动显示当前登录用户信息
- 包含：用户ID、昵称、OpenID
- 如果未显示，点击"刷新用户信息"

#### 2. **转账参数区域**
- **用户ID**：自动获取，也可手动输入（用于测试其他用户）
- **转账金额**：默认 0.3 元（建议首次测试用小额）
  - 最小：0.10 元
  - 最大：500 元
  - 免密：100 元以下
- **转账备注**：默认"砍价返现测试"

#### 3. **操作按钮**
点击 **"🚀 开始测试转账"** 按钮

#### 4. **结果显示**
- **成功**：绿色卡片，显示批次单号、金额、耗时等
- **失败**：红色卡片，显示错误信息

#### 5. **执行日志**
黑色卡片，显示详细的执行过程

---

## 📊 测试示例

### 成功示例：

```
✅ 转账成功

批次单号: BATCH1738123456ABCDEF
转账金额: ¥0.30
处理耗时: 1250ms
用户OpenID: oABC123***

请查看微信是否收到转账通知
```

**微信通知：**
```
【微信支付】您收到一笔转账
金额：¥0.30
备注：砍价返现测试
商户名称：[您的商户名称]
```

### 失败示例：

```
❌ 转账失败

错误信息: 用户openid不存在，请重新授权登录
错误代码: -1

请查看下方日志了解详情
```

---

## 🔍 常见问题

### 1. 提示"用户ID不能为空"

**原因**：未登录或用户信息未保存

**解决**：
1. 返回首页重新登录
2. 登录后重新进入测试页面
3. 或手动输入用户ID进行测试

---

### 2. 提示"用户信息不存在"

**原因**：数据库中找不到该用户

**检查**：
- 用户ID是否正确
- 用户是否已注册

---

### 3. 提示"openid不存在"

**原因**：用户未授权或授权信息过期

**解决**：
1. 退出登录
2. 重新登录并授权
3. 确保授权时勾选了获取用户信息

---

### 4. 转账失败：SIGN_ERROR

**原因**：签名错误，配置参数不正确

**检查**：
- `serial_no` 是否正确
- `private_key` 是否完整
- `apiv3_key` 是否正确（32位）

---

### 5. 转账失败：PARAM_ERROR

**原因**：请求参数错误

**检查**：
- 金额是否在 0.10-500 元之间
- `transfer_scene_id` 是否为 1001

---

### 6. 转账失败：ACCOUNT_BALANCE_NOT_ENOUGH

**原因**：商户账户余额不足

**解决**：登录微信支付商户平台充值

---

## 📋 测试清单

### 基础功能测试

- [ ] 小额转账（0.3元）✅ 推荐首次测试
- [ ] 中等金额（10元）
- [ ] 较大金额（100元）
- [ ] 边界值测试（0.1元）
- [ ] 边界值测试（500元）

### 异常处理测试

- [ ] 金额为 0
- [ ] 金额小于 0.1 元
- [ ] 金额大于 500 元
- [ ] 用户ID为空
- [ ] 用户ID不存在
- [ ] openid 不存在

### 性能测试

- [ ] 查看转账耗时（通常 1-2 秒）
- [ ] 连续转账测试（间隔 5 秒）

---

## 📍 查看转账记录

### 方式一：微信支付商户平台

1. 登录：https://pay.weixin.qq.com
2. 进入：**产品中心** → **商家转账到零钱**
3. 点击：**转账记录**
4. 查看刚才的测试记录

### 方式二：uniCloud 控制台日志

1. 打开：uniCloud Web 控制台
2. 进入：**云函数** → **articleWx** → **日志**
3. 查看详细执行日志

---

## 🎯 测试步骤总结

```
1. 上传云函数 → articleWx（1-2分钟）
   ↓
2. 运行小程序 → 微信开发者工具
   ↓
3. 登录小程序 → 确保有用户信息
   ↓
4. 访问测试页面 → /pages/article/testCashback
   ↓
5. 查看用户信息 → 顶部紫色卡片
   ↓
6. 输入转账金额 → 0.3（建议）
   ↓
7. 点击测试按钮 → 开始测试转账
   ↓
8. 查看结果 → 成功/失败信息
   ↓
9. 检查微信 → 是否收到转账通知
   ↓
10. 查看日志 → 了解详细执行过程
```

---

## 💡 高级功能

### 手动输入用户ID测试

如果需要测试转账给其他用户：

1. 在"用户ID"输入框中，手动输入目标用户的 `_id`
2. 输入转账金额
3. 点击测试按钮
4. 该用户的微信会收到转账

### 批量测试

在控制台中批量调用：

```javascript
// 测试多个金额
const amounts = [0.3, 1, 5, 10, 50]
for (const amt of amounts) {
  await api.testCashbackTransfer({
    user_id: 'xxx',
    amount: amt,
    desc: `批量测试-${amt}元`
  })
  await new Promise(r => setTimeout(r, 5000)) // 间隔5秒
}
```

---

## 📞 技术支持

### 微信支付相关
- 客服热线：**95017**
- 商户平台：https://pay.weixin.qq.com
- 在线客服：商户平台右下角

### API 文档
- V3 转账 API：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter4_3_1.shtml
- 签名验签：https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml

---

## ✨ 新版测试页面特性

### 界面优化
- ✅ 清晰的卡片式布局
- ✅ 渐变色主题
- ✅ 成功/失败状态可视化
- ✅ 实时日志显示

### 功能增强
- ✅ 自动获取用户信息
- ✅ 支持手动输入用户ID
- ✅ 详细的参数验证
- ✅ 完整的错误提示
- ✅ 执行日志记录
- ✅ 使用说明内置

### 用户体验
- ✅ 一键刷新用户信息
- ✅ 实时状态反馈
- ✅ 清晰的成功/失败提示
- ✅ 详细的日志输出

---

## 🎉 开始测试吧！

现在你已经拥有：
- ✅ 完整的配置文件
- ✅ V3 API 转账处理器
- ✅ 云函数测试接口
- ✅ 精美的测试页面
- ✅ 详细的使用文档

**只需 3 步**：
1. 上传云函数
2. 运行小程序
3. 点击测试按钮

祝测试成功！💰🎉
