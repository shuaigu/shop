# 买断功能支付集成完成

## 修改内容总结

### 1. 前端修改 (`articleDetail.vue`)

#### 修改的函数：
- **`handleBuyout`**: 简化为只处理前置检查和确认弹窗
- **新增 `processBuyoutPayment`**: 完整的支付流程处理
  - 创建买断订单
  - 获取用户 openid
  - 创建支付订单
  - 调起微信支付
  - 支付成功后完成买断

### 2. 云函数修改 (`articleWx/index.obj.js`)

#### 新增方法：
1. **`createBuyoutOrder`**: 创建买断订单（支付前）
   - 验证用户权限
   - 生成订单号
   - 保存订单到数据库
   - 返回订单信息

2. **`completeBuyout`**: 完成买断（支付成功后）
   - 验证订单状态
   - 创建买断记录
   - 更新文章状态
   - 更新用户积分
   - 标记订单完成

### 3. 数据库修改

#### 新增数据表：
- **`buyout_orders`**: 买断订单表
  - `order_no`: 订单号（唯一）
  - `article_id`: 文章ID
  - `user_id`: 买断用户ID
  - `buyout_price`: 买断价格
  - `status`: 订单状态（0-待支付，1-已支付，2-已取消）
  - `user_info`: 用户信息（昵称、头像）
  - `create_time`, `update_time`, `complete_time`: 时间戳

## 支付流程

```
用户点击"直接买断"按钮
    ↓
1. 前置检查（登录状态、小组状态等）
    ↓
2. 显示确认弹窗（显示买断价格）
    ↓
3. 用户确认支付
    ↓
4. 调用 createBuyoutOrder 创建订单
    ↓
5. 获取用户 openid（缓存或通过 uni.login 获取）
    ↓
6. 调用 uni-pay-co.createOrder 创建支付订单
    ↓
7. 调起 uni.requestPayment 发起微信支付
    ↓
8. 用户完成支付
    ↓
9. 支付成功回调
    ↓
10. 调用 completeBuyout 完成买断
    ↓
11. 更新砍价记录、文章状态、用户积分
    ↓
12. 显示成功提示，刷新页面数据
```

## 测试步骤

### 前置条件：
1. 确保已配置 uni-pay 支付功能
2. 确保微信支付商户已配置完成
3. 用户需要先发起砍价活动

### 测试流程：

1. **发起砍价**
   - 用户进入文章详情页
   - 点击"帮砍一刀"按钮
   - 成为砍价发起人

2. **查看买断功能**
   - 确认页面显示"买断价：¥XX.XX"
   - 确认显示"直接买断"按钮
   - 点击右上角"调试"按钮查看状态（可选）

3. **发起买断支付**
   - 点击"直接买断"按钮
   - 确认弹窗显示正确的买断价格
   - 点击"确认支付"

4. **完成支付**
   - 等待支付页面加载
   - 使用微信支付完成付款
   - 等待支付结果

5. **验证结果**
   - 支付成功后应显示"买断成功"提示
   - 页面应刷新显示最新状态
   - 砍价活动应标记为完成
   - 用户应获得积分奖励

### 异常情况测试：

1. **取消支付**
   - 在支付页面点击取消
   - 应显示"已取消支付"提示
   - 订单保持待支付状态

2. **支付失败**
   - 余额不足等情况
   - 应显示"支付失败"提示
   - 订单保持待支付状态

3. **重复买断**
   - 支付成功后再次点击买断
   - 应提示"您的砍价小组已完成或已买断"

## 调试说明

### 控制台日志关键点：

1. **创建订单**
   ```
   创建买断订单: {...}
   买断订单创建成功: BUYOUT...
   ```

2. **获取 openid**
   ```
   从缓存获取的openid: ...
   或
   获取openid成功: ...
   ```

3. **创建支付订单**
   ```
   支付参数: {...}
   createOrder 返回结果: {...}
   ```

4. **支付完成**
   ```
   支付成功，开始完成买断...
   完成买断: {...}
   买断完成: {...}
   ```

### 常见问题：

1. **找不到 uni-pay-co**
   - 检查 uni-pay 插件是否已安装
   - 检查云函数是否已上传

2. **获取 openid 失败**
   - 检查小程序 AppID 配置
   - 检查是否在真机上测试（开发工具可能无法获取）

3. **支付参数错误**
   - 检查 total_fee 是否为整数（单位：分）
   - 检查商户号配置是否正确

4. **支付成功但订单未完成**
   - 检查 completeBuyout 云函数日志
   - 检查数据库权限配置

## 数据库部署

上传新的 schema 文件到云端：
1. 打开 HBuilderX
2. 右键 `uniCloud-aliyun/database/buyout_orders.schema.json`
3. 选择"上传 DB Schema"
4. 等待部署完成

## 云函数部署

重新上传云函数：
1. 右键 `uniCloud-aliyun/cloudfunctions/articleWx`
2. 选择"上传部署"
3. 等待部署完成

## 注意事项

1. **金额单位**：
   - 前端显示和传递使用"元"（小数）
   - uni-pay 支付使用"分"（整数）
   - 需要在创建支付订单时进行转换：`Math.round(price * 100)`

2. **订单状态**：
   - 0: 待支付（订单已创建，等待支付）
   - 1: 已支付（支付成功，买断完成）
   - 2: 已取消（订单被取消）

3. **幂等性**：
   - completeBuyout 方法会检查订单状态
   - 防止重复完成买断

4. **积分奖励**：
   - 买断成功后奖励积分 = 买断价格的整数部分
   - 例如：买断价 95.98元，奖励 95 积分

## 测试环境要求

- 小程序正式环境或体验版（开发版不支持支付）
- 已开通微信支付商户号
- uni-pay 配置完整
- 真机测试（模拟器不支持微信支付）
