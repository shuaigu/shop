# ğŸ”§ å•†å®¶è½¬è´¦æµ‹è¯• - é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹æµ‹è¯•å‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

### 1. é…ç½®æ–‡ä»¶æ£€æŸ¥

**æ–‡ä»¶ä½ç½®**: `wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-config.js`

```javascript
âœ… appid: 'wxf7ee79349bd957b8'
âœ… mchid: '1545803671'
âœ… serial_no: '7282272EC446E827251B9FBAC2757DE1897026D3'
âœ… apiv3_key: 'lishuai4323811lishuai4323811lish' (32ä½)
âœ… private_key: å·²é…ç½®å®Œæ•´ (1708å­—ç¬¦)
âœ… platform_cert: å·²é…ç½®å®Œæ•´
âœ… transfer_scene_id: '1001'
```

**æ£€æŸ¥æ–¹å¼**ï¼š
```bash
# åœ¨äº‘å‡½æ•°ç›®å½•æ‰§è¡Œ
cat cashback-config.js | grep "appid"
cat cashback-config.js | grep "mchid"
```

---

### 2. äº‘å‡½æ•°æ£€æŸ¥

**å¿…éœ€æ–‡ä»¶**ï¼š
- âœ… `cashback-config.js` - é…ç½®æ–‡ä»¶
- âœ… `cashback-handler-v3.js` - V3å¤„ç†å™¨
- âœ… `index.obj.js` - äº‘å‡½æ•°å…¥å£ï¼ˆå«testCashbackTransferæ–¹æ³•ï¼‰

**ä¸Šä¼ çŠ¶æ€**ï¼š
- âœ… æœ€è¿‘ä¸€æ¬¡ä¸Šä¼ æ—¶é—´
- âœ… äº‘ç«¯ç‰ˆæœ¬æ˜¯å¦æœ€æ–°

---

### 3. æµ‹è¯•é¡µé¢æ£€æŸ¥

**æ–‡ä»¶ä½ç½®**: `wx2/pages/article/testCashback.vue`

**è·¯ç”±é…ç½®**: `pages.json` ä¸­å·²æ³¨å†Œ
```json
{
  "path": "pages/article/testCashback",
  "style": {
    "navigationBarTitleText": "è½¬è´¦æµ‹è¯•"
  }
}
```

---

## ğŸ› å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: é¡µé¢æç¤º"ç”¨æˆ·IDä¸èƒ½ä¸ºç©º"

#### ç—‡çŠ¶
```
âŒ ç”¨æˆ·IDä¸èƒ½ä¸ºç©º

è¯·å…ˆç™»å½•æˆ–æ‰‹åŠ¨è¾“å…¥ç”¨æˆ·ID
```

#### åŸå› åˆ†æ
1. ç”¨æˆ·æœªç™»å½•
2. æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ userInfo
3. userInfo ä¸­æ²¡æœ‰ _id å­—æ®µ

#### è§£å†³æ­¥éª¤

**æ­¥éª¤1ï¼šæ£€æŸ¥æ˜¯å¦ç™»å½•**
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
const userInfo = uni.getStorageSync('userInfo')
console.log('userInfo:', userInfo)
```

**æ­¥éª¤2ï¼šé‡æ–°ç™»å½•**
1. é€€å‡ºå½“å‰ç™»å½•
2. è¿”å›ç™»å½•é¡µ
3. é‡æ–°ç™»å½•å°ç¨‹åº

**æ­¥éª¤3ï¼šæ‰‹åŠ¨è®¾ç½®ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰**
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
uni.setStorageSync('userInfo', {
  _id: 'ä½ çš„ç”¨æˆ·ID',
  nickName: 'æµ‹è¯•ç”¨æˆ·'
})
```

**æ­¥éª¤4ï¼šåˆ·æ–°æµ‹è¯•é¡µé¢**
```javascript
// ç‚¹å‡»é¡µé¢ä¸Šçš„"åˆ·æ–°ç”¨æˆ·ä¿¡æ¯"æŒ‰é’®
// æˆ–é‡æ–°è¿›å…¥é¡µé¢
```

---

### é—®é¢˜ 2: æç¤º"ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨"

#### ç—‡çŠ¶
```
âŒ è½¬è´¦å¤±è´¥
é”™è¯¯ä¿¡æ¯: ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨
```

#### åŸå› åˆ†æ
æ•°æ®åº“ `uni-id-users` è¡¨ä¸­æ‰¾ä¸åˆ°è¯¥ç”¨æˆ·ID

#### è§£å†³æ­¥éª¤

**æ­¥éª¤1ï¼šéªŒè¯ç”¨æˆ·ID**
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
const db = uniCloud.database()
const res = await db.collection('uni-id-users')
  .doc('ä½ çš„ç”¨æˆ·ID')
  .get()
console.log('ç”¨æˆ·ä¿¡æ¯:', res)
```

**æ­¥éª¤2ï¼šæ£€æŸ¥IDæ ¼å¼**
- ç”¨æˆ·IDåº”è¯¥æ˜¯ç±»ä¼¼ï¼š`6pRa3N8My24kap8C-l3qD8C-tOD61rrWI` çš„æ ¼å¼
- ä¸æ˜¯ uidï¼ˆå¦‚ `67d0b5993f1a473bba2a16789`ï¼‰

**æ­¥éª¤3ï¼šä½¿ç”¨æ­£ç¡®çš„_id**
åœ¨æµ‹è¯•é¡µé¢æ‰‹åŠ¨è¾“å…¥æ­£ç¡®çš„ç”¨æˆ· `_id`

---

### é—®é¢˜ 3: æç¤º"openidä¸å­˜åœ¨"

#### ç—‡çŠ¶
```
âŒ è½¬è´¦å¤±è´¥
é”™è¯¯ä¿¡æ¯: ç”¨æˆ·openidä¸å­˜åœ¨ï¼Œè¯·é‡æ–°æˆæƒç™»å½•
```

#### åŸå› åˆ†æ
1. ç”¨æˆ·è®°å½•ä¸­æ²¡æœ‰ `wx_openid` å­—æ®µ
2. ç”¨æˆ·æœªè¿›è¡Œå¾®ä¿¡æˆæƒç™»å½•
3. æˆæƒä¿¡æ¯å·²è¿‡æœŸ

#### è§£å†³æ­¥éª¤

**æ­¥éª¤1ï¼šæ£€æŸ¥ç”¨æˆ·çš„openid**
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
const db = uniCloud.database()
const res = await db.collection('uni-id-users')
  .doc('ä½ çš„ç”¨æˆ·ID')
  .field({ wx_openid: true, nickname: true })
  .get()
console.log('ç”¨æˆ·openid:', res.data[0].wx_openid)
```

**æ­¥éª¤2ï¼šé‡æ–°æˆæƒç™»å½•**
1. é€€å‡ºç™»å½•
2. æ¸…é™¤ç¼“å­˜ï¼š`uni.clearStorageSync()`
3. é‡æ–°ç™»å½•å¹¶æˆæƒè·å–ç”¨æˆ·ä¿¡æ¯

**æ­¥éª¤3ï¼šæµ‹è¯•å…¶ä»–å·²æœ‰openidçš„ç”¨æˆ·**
æ‰¾ä¸€ä¸ªç¡®å®šæœ‰ openid çš„ç”¨æˆ·è¿›è¡Œæµ‹è¯•

---

### é—®é¢˜ 4: è½¬è´¦å¤±è´¥ - SIGN_ERROR

#### ç—‡çŠ¶
```
âŒ è½¬è´¦å¤±è´¥
é”™è¯¯ä¿¡æ¯: ç­¾åé”™è¯¯
```

#### åŸå› åˆ†æ
å¾®ä¿¡æ”¯ä»˜APIç­¾åéªŒè¯å¤±è´¥

#### è§£å†³æ­¥éª¤

**æ£€æŸ¥é…ç½®å‚æ•°**ï¼š

1. **è¯ä¹¦åºåˆ—å· (serial_no)**
```bash
# æŸ¥çœ‹è¯ä¹¦åºåˆ—å·
openssl x509 -in apiclient_cert.pem -noout -serial
# è¾“å‡º: serial=7282272EC446E827251B9FBAC2757DE1897026D3
```

2. **ç§é’¥ (private_key)**
```bash
# æŸ¥çœ‹ç§é’¥å†…å®¹
cat apiclient_key.pem
# å¿…é¡»åŒ…å«å®Œæ•´çš„ BEGIN å’Œ END æ ‡è®°
```

3. **APIv3å¯†é’¥ (apiv3_key)**
- å¿…é¡»æ˜¯32ä½å­—ç¬¦ä¸²
- å½“å‰é…ç½®: `lishuai4323811lishuai4323811lish`

**é‡æ–°ä¸Šä¼ äº‘å‡½æ•°**ï¼š
ç¡®ä¿é…ç½®æ–‡ä»¶çš„ä¿®æ”¹å·²ä¸Šä¼ åˆ°äº‘ç«¯

---

### é—®é¢˜ 5: è½¬è´¦å¤±è´¥ - PARAM_ERROR

#### ç—‡çŠ¶
```
âŒ è½¬è´¦å¤±è´¥
é”™è¯¯ä¿¡æ¯: å‚æ•°é”™è¯¯
```

#### åŸå› åˆ†æ
è¯·æ±‚å‚æ•°ä¸ç¬¦åˆå¾®ä¿¡æ”¯ä»˜è¦æ±‚

#### æ£€æŸ¥é¡¹ç›®

1. **é‡‘é¢èŒƒå›´**
   - æœ€å°ï¼š0.10 å…ƒï¼ˆ10åˆ†ï¼‰
   - æœ€å¤§ï¼š500 å…ƒï¼ˆ50000åˆ†ï¼‰

2. **åœºæ™¯ID**
   - å¿…é¡»ä½¿ç”¨å·²å¼€é€šçš„åœºæ™¯
   - å½“å‰é…ç½®ï¼š`1001`ï¼ˆåˆ†é”€è¿”ä½£ï¼‰

3. **openidæ ¼å¼**
   - å¿…é¡»æ˜¯æœ‰æ•ˆçš„å¾®ä¿¡openid
   - æ ¼å¼ï¼šä»¥ `o` å¼€å¤´çš„å­—ç¬¦ä¸²

---

### é—®é¢˜ 6: è½¬è´¦å¤±è´¥ - ä½™é¢ä¸è¶³

#### ç—‡çŠ¶
```
âŒ è½¬è´¦å¤±è´¥
é”™è¯¯ä¿¡æ¯: ACCOUNT_BALANCE_NOT_ENOUGH
```

#### è§£å†³æ–¹æ¡ˆ
1. ç™»å½•å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°
2. æŸ¥çœ‹è´¦æˆ·ä½™é¢
3. å……å€¼å•†æˆ·è´¦æˆ·

---

### é—®é¢˜ 7: äº‘å‡½æ•°è°ƒç”¨è¶…æ—¶

#### ç—‡çŠ¶
```
âŒ ç³»ç»Ÿå¼‚å¸¸
é”™è¯¯ä¿¡æ¯: timeout
```

#### åŸå› åˆ†æ
1. ç½‘ç»œè¿æ¥é—®é¢˜
2. äº‘å‡½æ•°æ‰§è¡Œæ—¶é—´è¿‡é•¿
3. å¾®ä¿¡æ”¯ä»˜APIå“åº”æ…¢

#### è§£å†³æ­¥éª¤

**æ£€æŸ¥ç½‘ç»œè¿æ¥**ï¼š
```javascript
// æµ‹è¯•ç½‘ç»œ
uni.request({
  url: 'https://api.mch.weixin.qq.com',
  success: (res) => {
    console.log('ç½‘ç»œæ­£å¸¸')
  },
  fail: (err) => {
    console.log('ç½‘ç»œå¼‚å¸¸:', err)
  }
})
```

**æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—**ï¼š
åœ¨ uniCloud æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—

---

## ğŸ“Š è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**å‰ç«¯æ—¥å¿—**ï¼š
æµ‹è¯•é¡µé¢ä¼šæ˜¾ç¤ºå®Œæ•´çš„æ‰§è¡Œæ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·IDè·å–è¿‡ç¨‹
- å‚æ•°éªŒè¯ç»“æœ
- äº‘å‡½æ•°è°ƒç”¨è¿‡ç¨‹
- è¿”å›ç»“æœè¯¦æƒ…

**äº‘å‡½æ•°æ—¥å¿—**ï¼š
```javascript
// åœ¨ cashback-handler-v3.js ä¸­æ·»åŠ æ—¥å¿—
console.log('è½¬è´¦è¯·æ±‚å‚æ•°:', requestData)
console.log('å¾®ä¿¡APIå“åº”:', response)
```

---

### 2. æµ‹è¯•å¾®ä¿¡APIè¿é€šæ€§

åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–¹æ³•ï¼š

```javascript
// åœ¨ index.obj.js ä¸­æ·»åŠ 
async testWechatApi() {
  try {
    const { CashbackHandlerV3 } = require('./cashback-handler-v3.js')
    const handler = new CashbackHandlerV3()
    
    console.log('é…ç½®ä¿¡æ¯:', {
      mchid: handler.config.mchid,
      serial_no: handler.config.serial_no,
      appid: handler.config.appid
    })
    
    return {
      errCode: 0,
      errMsg: 'é…ç½®åŠ è½½æˆåŠŸ',
      config: {
        mchid: handler.config.mchid,
        appid: handler.config.appid
      }
    }
  } catch (err) {
    return {
      errCode: -1,
      errMsg: err.message
    }
  }
}
```

è°ƒç”¨æµ‹è¯•ï¼š
```javascript
const api = uniCloud.importObject('articleWx')
const res = await api.testWechatApi()
console.log(res)
```

---

### 3. åˆ†æ­¥æµ‹è¯•

**ç¬¬1æ­¥ï¼šæµ‹è¯•é…ç½®åŠ è½½**
```javascript
// æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
const config = require('./cashback-config.js')
console.log('é…ç½®:', config)
```

**ç¬¬2æ­¥ï¼šæµ‹è¯•ç”¨æˆ·æŸ¥è¯¢**
```javascript
// æ£€æŸ¥æ˜¯å¦èƒ½æŸ¥åˆ°ç”¨æˆ·
const db = uniCloud.database()
const res = await db.collection('uni-id-users')
  .doc('ç”¨æˆ·ID')
  .field({ wx_openid: true })
  .get()
console.log('ç”¨æˆ·openid:', res.data[0].wx_openid)
```

**ç¬¬3æ­¥ï¼šæµ‹è¯•è½¬è´¦**
```javascript
// è°ƒç”¨è½¬è´¦æ¥å£
const api = uniCloud.importObject('articleWx')
const res = await api.testCashbackTransfer({
  user_id: 'ç”¨æˆ·ID',
  amount: 0.3,
  desc: 'æµ‹è¯•'
})
console.log('ç»“æœ:', res)
```

---

## ğŸ¯ æµ‹è¯•æˆåŠŸæ ‡å‡†

### å‰ç«¯æ˜¾ç¤º

```
âœ… è½¬è´¦æˆåŠŸ

æ‰¹æ¬¡å•å·: BATCH1738123456ABCDEF
è½¬è´¦é‡‘é¢: Â¥0.30
å¤„ç†è€—æ—¶: 1250ms
ç”¨æˆ·OpenID: oABC123***

è¯·æŸ¥çœ‹å¾®ä¿¡æ˜¯å¦æ”¶åˆ°è½¬è´¦é€šçŸ¥
```

### äº‘å‡½æ•°æ—¥å¿—

```
ğŸ§ª å¼€å§‹æµ‹è¯•è½¬è´¦: { user_id: 'xxx', amount: 0.3, desc: 'æµ‹è¯•' }
å½“å‰ç”¨æˆ·ID: xxx
ç”¨æˆ·openid: oABC123xxx
å•†å®¶è½¬è´¦è¯·æ±‚å‚æ•°ï¼ˆV3ï¼‰: { batch_no: 'BATCH...', ... }
âœ… å•†å®¶è½¬è´¦æˆåŠŸï¼ˆV3ï¼‰: { batch_id: 'xxx', ... }
âœ… æµ‹è¯•è½¬è´¦æˆåŠŸ!
```

### å¾®ä¿¡é€šçŸ¥

```
ã€å¾®ä¿¡æ”¯ä»˜ã€‘æ‚¨æ”¶åˆ°ä¸€ç¬”è½¬è´¦
é‡‘é¢ï¼šÂ¥0.30
å¤‡æ³¨ï¼šç ä»·è¿”ç°æµ‹è¯•
å•†æˆ·åç§°ï¼š[æ‚¨çš„å•†æˆ·åç§°]
```

### å•†æˆ·å¹³å°è®°å½•

åœ¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°å¯ä»¥æŸ¥çœ‹åˆ°è½¬è´¦è®°å½•

---

## ğŸ“ å¯»æ±‚å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. **æ”¶é›†ä¿¡æ¯**ï¼š
   - å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
   - å‰ç«¯æ—¥å¿—æˆªå›¾
   - äº‘å‡½æ•°æ—¥å¿—æˆªå›¾
   - é…ç½®å‚æ•°ï¼ˆè„±æ•ï¼‰

2. **è”ç³»æ”¯æŒ**ï¼š
   - å¾®ä¿¡æ”¯ä»˜å®¢æœï¼š95017
   - å•†æˆ·å¹³å°å·¥å•ç³»ç»Ÿ

3. **æŸ¥é˜…æ–‡æ¡£**ï¼š
   - å¾®ä¿¡æ”¯ä»˜å®˜æ–¹æ–‡æ¡£
   - uniCloud å®˜æ–¹æ–‡æ¡£

---

## âœ… æ’æŸ¥æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ£€æŸ¥é…ç½®æ–‡ä»¶ â†’ æœ‰é—®é¢˜ â†’ ä¿®æ”¹é…ç½® â†’ é‡æ–°ä¸Šä¼ 
  â†“ æ²¡é—®é¢˜
æ£€æŸ¥ç”¨æˆ·ç™»å½• â†’ æœªç™»å½• â†’ é‡æ–°ç™»å½•
  â†“ å·²ç™»å½•
æ£€æŸ¥ç”¨æˆ·ID â†’ æ— ID â†’ åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
  â†“ æœ‰ID
æ£€æŸ¥openid â†’ æ— openid â†’ é‡æ–°æˆæƒ
  â†“ æœ‰openid
æ‰§è¡Œè½¬è´¦æµ‹è¯•
  â†“
æˆåŠŸ â†’ å®Œæˆ âœ…
  â†“ å¤±è´¥
æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
  â†“
æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†
  â†“
é‡æ–°æµ‹è¯•
```

---

ç¥ä½ æµ‹è¯•é¡ºåˆ©ï¼ğŸ’ª
