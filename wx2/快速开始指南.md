# 砍价返现功能 - 快速开始指南

## 🎯 5分钟快速了解

### 新旧业务对比

```
原业务：砍价降价 → 买断支付
新业务：原价购买 → 分享砍价 → 商家返现
```

### 核心变化

1. **用户必须先原价购买**（不是砍价后买断）
2. **购买后成为小组长**（可以邀请好友帮砍）
3. **每砍一刀，小组长获得返现**（通过微信转账到零钱）
4. **最多返现到原价**（相当于免费得）

---

## 📂 项目文件结构

```
wx2/
├── uniCloud-aliyun/
│   ├── database/
│   │   ├── kanjia.schema.json                    ✅ 已修改（添加返现字段）
│   │   └── buyout_orders.schema.json             ✅ 已修改（添加返现追踪）
│   └── cloudfunctions/
│       └── articleWx/
│           ├── index.obj.js                       ✅ 已修改（核心逻辑）
│           ├── cashback-handler.js                ⚠️  V2版本（备用）
│           └── cashback-handler-v3.js             ⭐ V3版本（推荐）
├── uni_modules/uni-pay/
│   └── uniCloud/cloudfunctions/uni-pay-co/
│       └── notify/recharge.js                     ✅ 已修改（支付回调）
├── components/
│   └── dianzan/dianzan.vue                        ✅ 已修改（前端显示）
└── 文档/
    ├── 砍价返现逻辑修改说明.md                      📖 主文档
    ├── 商家转账V3配置指南.md                        📖 V3配置（推荐）
    ├── 企业付款到零钱配置指南.md                    📖 V2配置（备用）
    └── 快速开始指南.md                              📖 本文档
```

---

## 🚀 30分钟完成部署

### 阶段一：代码已就绪（✅ 已完成）

代码修改已全部完成，包括：
- ✅ 数据库Schema
- ✅ 云函数逻辑
- ✅ 支付回调
- ✅ 前端显示

### 阶段二：配置微信转账（⏱️ 需要30分钟）

#### 步骤1：开通功能（5分钟）

1. 登录：https://pay.weixin.qq.com
2. 产品中心 → 商家转账到零钱
3. 点击"申请开通"（如果显示"已开通"则跳过）

#### 步骤2：获取配置信息（10分钟）

需要获取5个配置参数：

| 参数 | 获取位置 | 示例 |
|------|----------|------|
| mchid | 账户中心 → 商户信息 | 1234567890 |
| serial_no | 证书文件或商户平台 | 1A2B3C... |
| apiv3_key | 账户中心 → API安全 | 32位字符串 |
| private_key | apiclient_key.pem | -----BEGIN... |
| platform_cert | API获取 | -----BEGIN... |

**详细步骤**：参考《商家转账V3配置指南.md》第三章

#### 步骤3：配置代码（5分钟）

打开 `cashback-handler-v3.js`，填写配置：

```javascript
constructor() {
  this.config = {
    appid: 'wxf7ee79349bd957b8',      // ← 填写你的
    mchid: '1545803671',         // ← 填写你的
    serial_no: '你的证书序列号',  // ← 填写你的
    apiv3_key: 'lishuai4323811lishuai4323811lish',  // ← 填写你的（32位）
    private_key: `你的完整私钥`,  // ← 填写你的
  };
  
  this.platform_cert = `你的平台证书`; // ← 填写你的
}
```

#### 步骤4：测试转账（5分钟）

```javascript
// 在uniCloud控制台测试
const articleWx = uniCloud.importObject('articleWx');

// 测试返现
const result = await articleWx.processCashback(
  'test_record_id',
  'test_user_id'
);

console.log(result);
```

#### 步骤5：配置定时任务（5分钟）

创建定时任务，每分钟执行：

```javascript
// 云函数：batchCashback
exports.main = async (event, context) => {
  const articleWx = uniCloud.importObject('articleWx');
  return await articleWx.batchProcessCashbacks();
};
```

设置定时触发器：`0 * * * * * *`（每分钟）

---

## 🎮 功能测试流程

### 测试场景1：完整流程测试

```
1. 用户A原价购买（100元）
   ↓ 检查：订单状态 status = 1
   
2. 用户B帮用户A砍价（返现5元）
   ↓ 检查：创建砍价记录，cashback_amount = 5, cashback_status = 0
   
3. 定时任务执行
   ↓ 检查：用户A微信零钱收到5元
   
4. 检查数据库
   ↓ cashback_status = 1, transaction_id 已填写
```

### 测试场景2：边界测试

```
测试1：未购买用户砍价
预期：提示"小组长还未购买，无法获得返现"

测试2：返现达到上限
预期：提示"返现已达上限"

测试3：重复砍价
预期：提示"您已经帮TA砍过价了"

测试4：自己帮自己砍
预期：提示"不能帮自己砍价"
```

---

## 💡 重要提示

### ⚠️ 必须配置的内容

1. **微信转账配置**（否则无法返现）
   - 商户号、证书、密钥等5个参数
   
2. **定时任务**（否则返现不会自动处理）
   - 每分钟执行一次批量返现

3. **用户openid**（否则无法转账）
   - 确保用户登录时保存openid

### ✅ 推荐配置

- **使用V3 API**：新版API更稳定、更安全
- **异步返现**：不影响砍价响应速度
- **监控日志**：及时发现返现失败

### 📊 额度限制（根据您的配置）

```
单笔返现：0.10元 - 500元
用户单日：最多20,000元
商户单日：最多100,000元
```

---

## 🔧 常见问题

### Q1: 代码修改完了，下一步做什么？

**A**: 配置微信转账功能（参考《商家转账V3配置指南.md》）

### Q2: 返现什么时候到账？

**A**: 异步返现模式下，1-5分钟到账（取决于定时任务执行频率）

### Q3: 用户没收到返现怎么办？

**A**: 检查以下几点：
1. 数据库中 cashback_status 的状态
2. 云函数日志中的错误信息
3. 用户是否已完成微信实名认证
4. 商户账户余额是否充足

### Q4: 可以立即返现吗？

**A**: 可以。在 `bargain` 方法中取消注释同步返现代码。但不推荐，会影响砍价响应速度。

### Q5: V2和V3有什么区别？

**A**: 
- V2是旧版API，即将废弃
- V3是新版API，官方推荐
- 建议使用V3

---

## 📞 获取帮助

### 查看文档

1. **主文档**：`砍价返现逻辑修改说明.md`
   - 详细的业务逻辑说明
   - 代码修改清单
   - 测试建议

2. **V3配置**：`商家转账V3配置指南.md` ⭐ 推荐
   - 完整的配置步骤
   - API使用说明
   - 常见错误处理

3. **V2配置**：`企业付款到零钱配置指南.md`（备用）

### 技术支持

- 微信支付客服：95017
- 在线客服：商户平台右下角
- 开发者社区：https://developers.weixin.qq.com/community/pay

---

## ✨ 功能特性

### 对用户的好处

- ✅ 先购买后返现，风险更低
- ✅ 可以无限接近免费（最多返现到原价）
- ✅ 返现直接到微信零钱，可立即使用

### 对商家的好处

- ✅ 提前收款，资金更安全
- ✅ 激励用户分享，传播更广
- ✅ 用户粘性更强，复购率更高

### 技术优势

- ✅ 使用最新V3 API，更稳定
- ✅ 异步返现，响应速度快
- ✅ 完善的错误处理和重试机制

---

## 🎉 恭喜！

如果您看到这里，说明您已经了解了砍价返现功能的全貌。

现在只需要：
1. ✅ 配置微信转账（30分钟）
2. ✅ 测试功能（10分钟）
3. ✅ 部署上线（5分钟）

**预计总时长：45分钟**

准备好了吗？开始配置吧！👉 《商家转账V3配置指南.md》

---

**文档版本**：v1.0  
**更新时间**：2026-01-29  
**下一步**：查看《商家转账V3配置指南.md》
