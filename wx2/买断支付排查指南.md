# 买断支付无法调起问题排查指南

## 当前修改

已添加详细的调试日志，每个步骤都会在控制台输出详细信息，帮助定位问题。

### 日志标识说明：
- `✅` = 成功
- `❌` = 失败
- `⚠️` = 警告

## 排查步骤

### 1. 查看控制台日志

点击买断按钮后，在微信开发者工具的控制台查看日志输出，按顺序检查：

#### 步骤0: 买断按钮点击
```
=== 开始买断支付流程 ===
{sharerId, articleId, userId, buyoutPrice}
```

#### 步骤1: 创建订单
```
步骤1: 开始创建买断订单...
步骤1完成: 订单创建结果 {errCode, data}
✅ 买断订单创建成功: {order_no, buyout_id, amount}
```
**如果这一步失败：**
- 检查云函数 `createBuyoutOrder` 是否已部署
- 检查数据库表 `buyout_orders` 是否已创建
- 查看云函数日志中的错误信息

#### 步骤2: 创建 uni-pay 实例
```
步骤2: 创建 uni-pay-co 实例...
✅ uni-pay-co 实例创建成功
```
**如果这一步失败：**
- 检查 uni-pay 插件是否已安装
- 检查 uni-pay-co 云对象是否已部署
- 在 HBuilderX 中查看 `uniCloud/cloudfunctions/uni-pay-co`

#### 步骤3: 获取 openid
```
步骤3: 开始获取用户 openid...
从缓存获取的openid: xxx 或 (空)
```
如果缓存没有：
```
缓存中没有openid，开始通过 uni.login 获取...
✅ 获取到登录code: xxx
开始调用 uniPayCo.getOpenid...
getOpenid返回结果: {errCode, openid}
✅ 获取openid成功: xxx
```
**如果这一步失败：**
- 检查小程序 AppID 是否配置正确
- 检查是否在真机上测试（开发工具可能无法获取 openid）
- 检查 uni-pay 配置文件中的微信支付配置
- 清空缓存后重试：`uni.removeStorageSync('wx_openid')`

#### 步骤4: 创建支付订单
```
步骤4: 开始创建支付订单...
支付参数: {provider, total_fee, order_no, ...}
开始调用 uniPayCo.createOrder...
createOrder 返回结果: {errCode, order}
✅ 步骤4完成，实际支付参数: {timeStamp, nonceStr, package, ...}
```
**如果这一步失败：**
- 检查微信支付商户号是否配置正确
- 检查商户密钥是否正确
- 检查商户号是否已开通 JSAPI 支付
- 查看 uni-pay-co 云函数日志

#### 步骤5: 调起微信支付
```
步骤5: 准备调起微信支付...
调用 uni.requestPayment，参数: {...}
```
**如果这一步失败或无反应：**
- 检查是否在真机上测试（模拟器不支持支付）
- 检查小程序版本是否为体验版或正式版（开发版不支持支付）
- 检查支付参数格式是否正确
- 检查微信商户号是否与小程序绑定

## 测试模式使用

如果想跳过实际支付，测试后续流程：

1. 打开 `articleDetail.vue`
2. 找到第 301 行左右的代码：
   ```javascript
   const TEST_MODE_SKIP_PAYMENT = false
   ```
3. 改为：
   ```javascript
   const TEST_MODE_SKIP_PAYMENT = true
   ```
4. 保存并重新编译
5. 点击买断按钮会弹出"测试模式"提示
6. 点击"模拟支付成功"直接完成买断

**注意：** 测试完成后务必改回 `false`！

## 常见问题及解决方案

### 问题1: 点击买断后无任何反应
**可能原因：**
- 未通过前置检查（登录状态、小组状态等）
- JavaScript 错误导致代码中断

**解决方案：**
1. 打开控制台查看是否有错误信息
2. 检查 `handleBuyout` 函数的前置检查日志
3. 确认用户已登录且有砍价小组

### 问题2: "创建订单失败"
**可能原因：**
- 云函数未部署
- 数据库表未创建
- 权限配置问题

**解决方案：**
1. 部署云函数：右键 `articleWx` → 上传部署
2. 部署数据库：右键 `buyout_orders.schema.json` → 上传 DB Schema
3. 检查云函数日志查看详细错误

### 问题3: "获取openid失败"
**可能原因：**
- 小程序配置问题
- uni-pay 配置不完整
- 在开发工具上测试

**解决方案：**
1. 确保在真机上测试
2. 检查 manifest.json 中的微信小程序配置
3. 检查 uni-pay 配置文件：
   ```
   uniCloud/cloudfunctions/uni-pay-co/config.json
   ```

### 问题4: "创建支付订单失败"
**可能原因：**
- 商户号配置错误
- 商户密钥错误
- 商户号未开通 JSAPI

**解决方案：**
1. 登录微信支付商户平台检查配置
2. 确认商户号与小程序已绑定
3. 检查 API 密钥是否正确

### 问题5: 调起支付无反应
**可能原因：**
- 在开发版测试
- 在模拟器测试
- 支付参数格式错误

**解决方案：**
1. 上传为体验版或正式版
2. 在真机上测试
3. 检查控制台日志中的支付参数

## 调试命令

### 清空缓存
```javascript
// 在控制台执行
uni.removeStorageSync('wx_openid')
uni.removeStorageSync('current_sharer_id')
```

### 查看当前用户信息
```javascript
// 在控制台执行
console.log('用户信息:', userStore.userInfo)
console.log('砍价小组:', userOwnGroup.value)
console.log('买断价格:', computedBuyoutPrice.value)
```

### 测试云函数
```javascript
// 在控制台执行
const articleApi = uniCloud.importObject('articleWx', { customUI: true })
articleApi.createBuyoutOrder(
  'article_id',
  'user_id',
  95.98,
  {nickName: '测试', avatarUrl: ''},
  'user_id'
).then(res => console.log(res))
```

## 完整日志示例（正常流程）

```
=== 开始买断支付流程 === {sharerId: "xxx", articleId: "xxx", userId: "xxx", buyoutPrice: 95.98}
步骤1: 开始创建买断订单...
步骤1完成: 订单创建结果 {errCode: 0, data: {order_no: "BUYOUT...", buyout_id: "xxx", amount: 95.98}}
✅ 买断订单创建成功: {order_no: "BUYOUT...", buyout_id: "xxx", amount: 95.98}
步骤2: 创建 uni-pay-co 实例...
✅ uni-pay-co 实例创建成功
步骤3: 开始获取用户 openid...
从缓存获取的openid: oxxx...
✅ 使用缓存的openid
✅ 步骤3完成，openid已获取
步骤4: 开始创建支付订单...
支付参数: {provider: "wxpay", total_fee: 9598, order_no: "BUYOUT...", ...}
开始调用 uniPayCo.createOrder...
createOrder 返回结果: {errCode: 0, order: {...}}
✅ 步骤4完成，实际支付参数: {timeStamp: "...", nonceStr: "...", package: "...", ...}
步骤5: 准备调起微信支付...
调用 uni.requestPayment，参数: {provider: "wxpay", timeStamp: "...", ...}
[微信支付界面出现]
```

## 联系支持

如果按照以上步骤仍无法解决问题，请提供：
1. 完整的控制台日志
2. 云函数日志截图
3. 失败的具体步骤
4. 测试环境信息（真机/模拟器，开发版/体验版）

## 下一步

建议先启用测试模式（`TEST_MODE_SKIP_PAYMENT = true`），确认：
1. 订单创建流程正常
2. 完成买断流程正常
3. 数据更新正常

然后再排查支付相关问题。
