# æµ·æŠ¥å’Œè½¬å‘åŠ è½½é—®é¢˜ - å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

æ ¹æ®ä»£ç å®¡æŸ¥ï¼Œæµ·æŠ¥å’Œè½¬å‘åŠŸèƒ½æ— æ³•åŠ è½½çš„ä¸»è¦åŸå› ï¼š

### 1. æµ·æŠ¥ç”Ÿæˆå¤±è´¥çš„åŸå› 

#### âŒ å°ç¨‹åºç ç”Ÿæˆé—®é¢˜
- **Access Token å¤±æ•ˆ**: å¾®ä¿¡ access_token æœ‰æ•ˆæœŸ 2 å°æ—¶ï¼Œè¿‡æœŸåéœ€é‡æ–°è·å–
- **API è°ƒç”¨å¤±è´¥**: ç½‘ç»œè¶…æ—¶æˆ–å¾®ä¿¡ API è¿”å›é”™è¯¯
- **Buffer è½¬æ¢é—®é¢˜**: å“åº”æ•°æ®æ ¼å¼ä¸æ­£ç¡®å¯¼è‡´ base64 è½¬æ¢å¤±è´¥
- **Scene å‚æ•°è¶…é™**: scene å‚æ•°è¶…è¿‡ 32 å­—ç¬¦é™åˆ¶

#### âŒ Canvas ç»˜åˆ¶é—®é¢˜
- **Canvas èŠ‚ç‚¹è·å–å¤±è´¥**: åœ¨æŸäº›æƒ…å†µä¸‹ Canvas 2D èŠ‚ç‚¹æ— æ³•æ­£ç¡®è·å–
- **å›¾ç‰‡åŠ è½½è¶…æ—¶**: ç½‘ç»œæ…¢æˆ–å›¾ç‰‡æœåŠ¡å™¨å“åº”æ…¢å¯¼è‡´è¶…æ—¶ï¼ˆ8ç§’ï¼‰
- **å›¾ç‰‡ç¼“å­˜é—®é¢˜**: ä½¿ç”¨ç¼“å­˜çš„æ—§å›¾ç‰‡ï¼Œæ˜¾ç¤ºä¸æ­£ç¡®
- **å¤´åƒåŠ è½½å¤±è´¥**: ç”¨æˆ·å¤´åƒ URL å¤±æ•ˆæˆ–åŠ è½½è¶…æ—¶

#### âŒ èµ„æºåŠ è½½é—®é¢˜
- **ç½‘ç»œè¶…æ—¶**: ç§»åŠ¨ç½‘ç»œä¸ç¨³å®šå¯¼è‡´èµ„æºåŠ è½½å¤±è´¥
- **å¹¶å‘åŠ è½½**: å¤šå¼ å›¾ç‰‡åŒæ—¶åŠ è½½å¯¼è‡´èµ„æºç«äº‰
- **å†…å­˜ä¸è¶³**: å¤§å›¾ç‰‡åŠ è½½å¯¼è‡´å°ç¨‹åºå†…å­˜æº¢å‡º

### 2. è½¬å‘åŠŸèƒ½å¤±è´¥çš„åŸå› 

#### âŒ åˆ†äº«é…ç½®é—®é¢˜
- **äº‹ä»¶ç›‘å¬ä¸¢å¤±**: `uni.$emit('setShareInfo')` äº‹ä»¶æœªè¢«æ­£ç¡®ç›‘å¬
- **é¡µé¢æœªå®ç°å›è°ƒ**: è¯¦æƒ…é¡µç¼ºå°‘ `onShareAppMessage` æˆ– `onShareTimeline`
- **åˆ†äº«ä¿¡æ¯æœªæ›´æ–°**: ç‚¹å‡»åˆ†äº«æ—¶ä½¿ç”¨çš„æ˜¯æ—§æ•°æ®

#### âŒ Canvas æµ·æŠ¥ç”Ÿæˆå¤±è´¥
- **é™æ€äºŒç»´ç åŠ è½½å¤±è´¥**: é»˜è®¤äºŒç»´ç å›¾ç‰‡ URL æ— æ•ˆ
- **Canvas å¯¼å‡ºå¤±è´¥**: `canvasToTempFilePath` è°ƒç”¨å¤±è´¥

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¼˜åŒ–å°ç¨‹åºç ç”Ÿæˆï¼ˆäº‘å‡½æ•°ï¼‰

**æ–‡ä»¶**: `wx2/uniCloud-aliyun/cloudfunctions/getWxacode/index.obj.js`

**é—®é¢˜**:
1. Access Token æœªç¼“å­˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°è·å–
2. é”™è¯¯å¤„ç†ä¸å®Œå–„
3. Buffer ç±»å‹åˆ¤æ–­ä¸å‡†ç¡®

**ä¼˜åŒ–æ–¹æ¡ˆ**:

```javascript
'use strict';

const appId = 'wxf7ee79349bd957b8';
const appSecret = '725f689abdc2c51a36330a813c1b7215';

// âœ… æ–°å¢ï¼šç¼“å­˜ access_token
let cachedAccessToken = null;
let tokenExpireTime = 0;

/**
 * è·å–å°ç¨‹åºaccess_tokenï¼ˆå¸¦ç¼“å­˜ï¼‰
 */
async function getAccessToken() {
	try {
		// âœ… æ£€æŸ¥ç¼“å­˜ï¼ˆæå‰5åˆ†é’Ÿè¿‡æœŸï¼‰
		const now = Date.now();
		if (cachedAccessToken && now < tokenExpireTime - 5 * 60 * 1000) {
			console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„ access_token');
			return cachedAccessToken;
		}
		
		console.log('ğŸ”„ é‡æ–°è·å– access_token...');
		const res = await uniCloud.httpclient.request(
			`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appId}&secret=${appSecret}`,
			{
				method: 'GET',
				dataType: 'json',
				timeout: 10000 // âœ… å¢åŠ è¶…æ—¶æ—¶é—´
			}
		);
		
		if (res.data && res.data.access_token) {
			// âœ… ç¼“å­˜ tokenï¼ˆæœ‰æ•ˆæœŸ7200ç§’ï¼‰
			cachedAccessToken = res.data.access_token;
			tokenExpireTime = now + res.data.expires_in * 1000;
			console.log('âœ… access_token è·å–æˆåŠŸï¼Œæœ‰æ•ˆæœŸè‡³:', new Date(tokenExpireTime));
			return cachedAccessToken;
		} else {
			throw new Error(res.data?.errmsg || 'è·å–access_tokenå¤±è´¥');
		}
	} catch (err) {
		console.error('âŒ è·å–access_tokené”™è¯¯ï¼š', err);
		// âœ… æ¸…ç©ºç¼“å­˜
		cachedAccessToken = null;
		tokenExpireTime = 0;
		throw err;
	}
}

/**
 * ç”Ÿæˆå°ç¨‹åºç ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
 */
async function generateQRCode(params = {}, retryCount = 0) {
	const MAX_RETRY = 2; // æœ€å¤šé‡è¯•2æ¬¡
	
	try {
		const { scene, page = 'pages/index/index', width = 430 } = params;
		
		if (!scene) {
			throw new Error('sceneå‚æ•°ä¸èƒ½ä¸ºç©º');
		}
		
		// âœ… éªŒè¯ scene é•¿åº¦
		if (scene.length > 32) {
			throw new Error(`sceneå‚æ•°è¿‡é•¿: ${scene.length}/32 å­—ç¬¦`);
		}
		
		console.log(`ğŸ¯ ç”Ÿæˆå°ç¨‹åºç  (å°è¯• ${retryCount + 1}/${MAX_RETRY + 1})...`);
		console.log('   scene:', scene, `(${scene.length}å­—ç¬¦)`);
		console.log('   page:', page);
		console.log('   width:', width);
		
		// è·å–access_token
		const accessToken = await getAccessToken();
		
		// è°ƒç”¨å¾®ä¿¡æ¥å£ç”Ÿæˆå°ç¨‹åºç 
		const res = await uniCloud.httpclient.request(
			`https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=${accessToken}`,
			{
				method: 'POST',
				contentType: 'json',
				timeout: 15000, // âœ… å¢åŠ è¶…æ—¶æ—¶é—´åˆ°15ç§’
				data: {
					scene: scene,
					page: page,
					width: width,
					auto_color: false,
					line_color: {"r":0,"g":0,"b":0},
					is_hyaline: false
				}
			}
		);
		
		// âœ… ä¼˜åŒ–ï¼šæ£€æŸ¥å“åº”æ•°æ®
		if (!res.data) {
			throw new Error('å¾®ä¿¡APIæ— å“åº”æ•°æ®');
		}
		
		console.log('ğŸ“¦ æ”¶åˆ°å¾®ä¿¡å“åº”');
		console.log('   æ•°æ®ç±»å‹:', typeof res.data);
		console.log('   æ˜¯Buffer?', Buffer.isBuffer(res.data));
		console.log('   æ•°æ®é•¿åº¦:', res.data.length);
		
		// âœ… æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯å“åº”ï¼ˆJSONæ ¼å¼ï¼‰
		if (typeof res.data === 'object' && !Buffer.isBuffer(res.data)) {
			if (res.data.errcode) {
				console.error('âŒ å¾®ä¿¡APIè¿”å›é”™è¯¯:', res.data);
				
				// âœ… ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ access_token å¤±æ•ˆï¼Œæ¸…ç©ºç¼“å­˜å¹¶é‡è¯•
				if (res.data.errcode === 40001 && retryCount < MAX_RETRY) {
					console.log('ğŸ”„ access_tokenå¤±æ•ˆï¼Œæ¸…ç©ºç¼“å­˜å¹¶é‡è¯•...');
					cachedAccessToken = null;
					tokenExpireTime = 0;
					return await generateQRCode(params, retryCount + 1);
				}
				
				throw new Error(`å¾®ä¿¡é”™è¯¯: ${res.data.errmsg} (code: ${res.data.errcode})`);
			}
		}
		
		// âœ… ç¡®ä¿res.dataæ˜¯Bufferç±»å‹
		let bufferData;
		if (Buffer.isBuffer(res.data)) {
			bufferData = res.data;
		} else if (typeof res.data === 'string') {
			bufferData = Buffer.from(res.data, 'latin1');
		} else {
			// âœ… å°è¯•ä»res.dataä¸­æå–buffer
			console.warn('âš ï¸ æ•°æ®ç±»å‹å¼‚å¸¸ï¼Œå°è¯•è½¬æ¢...');
			try {
				const jsonStr = JSON.stringify(res.data);
				// æ£€æŸ¥æ˜¯å¦æ˜¯é”™è¯¯ä¿¡æ¯
				const parsed = JSON.parse(jsonStr);
				if (parsed.errcode) {
					throw new Error(`å¾®ä¿¡APIé”™è¯¯: ${parsed.errmsg} (code: ${parsed.errcode})`);
				}
				bufferData = Buffer.from(jsonStr, 'utf8');
			} catch (parseErr) {
				throw new Error('æ— æ³•è§£æå“åº”æ•°æ®');
			}
		}
		
		// âœ… éªŒè¯æ˜¯å¦æ˜¯PNGæ ¼å¼ï¼ˆé­”æ³•æ•°å­—: 89 50 4E 47ï¼‰
		const isPNG = bufferData.length > 4 && 
			bufferData[0] === 0x89 && 
			bufferData[1] === 0x50 && 
			bufferData[2] === 0x4E && 
			bufferData[3] === 0x47;
		
		if (!isPNG) {
			console.error('âŒ è¿”å›çš„æ•°æ®ä¸æ˜¯PNGæ ¼å¼');
			console.error('   å‰4å­—èŠ‚:', Array.from(bufferData.slice(0, 4)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
			
			// âœ… å°è¯•è§£æä¸ºJSONé”™è¯¯ä¿¡æ¯
			try {
				const text = bufferData.toString('utf8', 0, Math.min(500, bufferData.length));
				console.error('   å“åº”å†…å®¹:', text);
				const jsonData = JSON.parse(text);
				if (jsonData.errcode) {
					throw new Error(`å¾®ä¿¡APIé”™è¯¯: ${jsonData.errmsg} (code: ${jsonData.errcode})`);
				}
			} catch (parseErr) {
				// è§£æå¤±è´¥ï¼Œç»§ç»­æŠ›å‡ºåŸé”™è¯¯
			}
			
			throw new Error('è¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼');
		}
		
		// âœ… è½¬æ¢ä¸ºbase64
		const base64Image = bufferData.toString('base64');
		console.log('âœ… å°ç¨‹åºç ç”ŸæˆæˆåŠŸ');
		console.log('   å›¾ç‰‡å¤§å°:', (bufferData.length / 1024).toFixed(2), 'KB');
		console.log('   base64é•¿åº¦:', base64Image.length);
		
		return {
			errCode: 0,
			errMsg: 'success',
			qrcodeBase64: `data:image/png;base64,${base64Image}`
		};
		
	} catch (err) {
		console.error('âŒ ç”Ÿæˆå°ç¨‹åºç é”™è¯¯ï¼š', err);
		
		// âœ… ç½‘ç»œé”™è¯¯æ—¶é‡è¯•
		if (retryCount < MAX_RETRY && (
			err.message.includes('timeout') || 
			err.message.includes('ECONNRESET') ||
			err.message.includes('ETIMEDOUT')
		)) {
			console.log(`ğŸ”„ ç½‘ç»œé”™è¯¯ï¼Œ${1 + retryCount} ç§’åé‡è¯•...`);
			await new Promise(resolve => setTimeout(resolve, (1 + retryCount) * 1000));
			return await generateQRCode(params, retryCount + 1);
		}
		
		return {
			errCode: -1,
			errMsg: err.message || 'ç”Ÿæˆå¤±è´¥',
			error: {
				name: err.name,
				message: err.message,
				stack: err.stack
			}
		};
	}
}

module.exports = {
	_before: function() {
		// é€šç”¨é¢„å¤„ç†å™¨
	},
	
	/**
	 * ç”Ÿæˆæ–‡ç« å°ç¨‹åºç 
	 */
	async generateArticleQRCode(params = {}) {
		const { article_id } = params;
		
		if (!article_id) {
			return {
				errCode: -1,
				errMsg: 'article_idä¸èƒ½ä¸ºç©º'
			};
		}
		
		console.log('ğŸ“ å¼€å§‹ç”Ÿæˆæ–‡ç« å°ç¨‹åºç ');
		console.log('  - article_id:', article_id);
		
		// æ„å»ºsceneå‚æ•°
		const scene = `a=${article_id}`;
		
		console.log('ğŸ¯ sceneå€¼:', scene, `(${scene.length}/32å­—ç¬¦)`);
		
		return await generateQRCode({
			scene,
			page: 'pages/article/articleDetail',
			width: 280
		});
	},
	
	/**
	 * âœ… æ–°å¢ï¼šæ¸…é™¤ç¼“å­˜æ–¹æ³•ï¼ˆç”¨äºè°ƒè¯•ï¼‰
	 */
	async clearCache() {
		cachedAccessToken = null;
		tokenExpireTime = 0;
		console.log('âœ… access_token ç¼“å­˜å·²æ¸…é™¤');
		return {
			errCode: 0,
			errMsg: 'ç¼“å­˜å·²æ¸…é™¤'
		};
	}
};
```

---

### æ–¹æ¡ˆäºŒï¼šä¼˜åŒ–æµ·æŠ¥ç»„ä»¶å®¹é”™æ€§

**æ–‡ä»¶**: `wx2/components/article-poster/article-poster.vue`

**ä¸»è¦ä¼˜åŒ–**:
1. å¢åŠ åŠ è½½è¶…æ—¶å¤„ç†
2. æ·»åŠ ç¦»çº¿æ¨¡å¼ï¼ˆæ— å°ç¨‹åºç ä¹Ÿèƒ½ç”Ÿæˆï¼‰
3. ä¼˜åŒ–å›¾ç‰‡åŠ è½½ç­–ç•¥
4. æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

**å…³é”®ä¿®æ”¹ç‚¹**:

```vue
<script setup>
// ... çœç•¥å…¶ä»–ä»£ç  ...

// ç”Ÿæˆæµ·æŠ¥ï¼ˆæ”¯æŒé™é»˜æ¨¡å¼ï¼‰
const generatePoster = async (silent = false) => {
	if (isGenerating.value) {
		console.warn('âš ï¸ æµ·æŠ¥ç”Ÿæˆä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
		return;
	}
	
	isGenerating.value = true;
	
	// âœ… å¢åŠ ç”Ÿæˆè¶…æ—¶ä¿æŠ¤ï¼ˆ30ç§’ï¼‰
	const timeoutId = setTimeout(() => {
		if (isGenerating.value) {
			console.error('âŒ æµ·æŠ¥ç”Ÿæˆè¶…æ—¶ï¼ˆ30ç§’ï¼‰');
			isGenerating.value = false;
			if (!silent) {
				uni.hideLoading();
				uni.showToast({
					title: 'ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•',
					icon: 'none'
				});
			}
		}
	}, 30000);
	
	try {
		// æ¸…ç©ºç¼“å­˜
		qrcodeBase64.value = '';
		posterPath.value = '';
		console.log('ğŸ—‘ï¸ å·²æ¸…ç©ºæµ·æŠ¥ç¼“å­˜');
		
		if (!silent) {
			uni.showLoading({
				title: 'ç”Ÿæˆæµ·æŠ¥ä¸­...',
				mask: true
			});
		}
		
		// âœ… ä¼˜åŒ–ï¼šå¹¶è¡Œæ‰§è¡Œå°ç¨‹åºç ç”Ÿæˆå’Œ Canvas å‡†å¤‡
		console.log('ğŸš€ å¼€å§‹å¹¶è¡Œä»»åŠ¡...');
		
		// ä»»åŠ¡1: ç”Ÿæˆå°ç¨‹åºç ï¼ˆå¸¦è¶…æ—¶ï¼‰
		const qrcodePromise = Promise.race([
			generateArticleQRCode(),
			new Promise((resolve) => {
				setTimeout(() => {
					console.warn('âš ï¸ å°ç¨‹åºç ç”Ÿæˆè¶…æ—¶ï¼ˆ10ç§’ï¼‰ï¼Œç»§ç»­ç”Ÿæˆæµ·æŠ¥');
					resolve(null);
				}, 10000); // 10ç§’è¶…æ—¶
			})
		]);
		
		// ä»»åŠ¡2: å‡†å¤‡ Canvas èŠ‚ç‚¹
		const canvasPromise = prepareCanvas();
		
		// ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡å®Œæˆ
		const [qrcodeResult, canvas] = await Promise.all([qrcodePromise, canvasPromise]);
		
		console.log('âœ… å¹¶è¡Œä»»åŠ¡å®Œæˆ');
		console.log('   å°ç¨‹åºç :', qrcodeBase64.value ? 'âœ…' : 'âŒ');
		console.log('   Canvas:', canvas ? 'âœ…' : 'âŒ');
		
		if (!canvas) {
			throw new Error('Canvas åˆå§‹åŒ–å¤±è´¥');
		}
		
		// ç»˜åˆ¶æµ·æŠ¥ï¼ˆå³ä½¿æ²¡æœ‰å°ç¨‹åºç ä¹Ÿç»§ç»­ï¼‰
		await drawPoster(canvas, silent);
		
		// âœ… æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
		clearTimeout(timeoutId);
		
	} catch (err) {
		console.error('âŒ ç”Ÿæˆæµ·æŠ¥å¤±è´¥:', err);
		clearTimeout(timeoutId);
		
		if (!silent) {
			uni.hideLoading();
			uni.showToast({
				title: 'ç”Ÿæˆå¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'),
				icon: 'none',
				duration: 3000
			});
		}
	} finally {
		isGenerating.value = false;
	}
};

// âœ… æ–°å¢ï¼šå‡†å¤‡ Canvas èŠ‚ç‚¹ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
const prepareCanvas = () => {
	return new Promise((resolve, reject) => {
		// #ifdef MP-WEIXIN
		const query = uni.createSelectorQuery();
		query.select('#article-poster-canvas')
			.fields({ node: true, size: true })
			.exec((res) => {
				if (!res[0] || !res[0].node) {
					console.warn('âš ï¸ CanvasèŠ‚ç‚¹æœªæ‰¾åˆ°ï¼Œå°è¯•åˆ›å»ºç¦»å±Canvas');
					try {
						const canvas = wx.createOffscreenCanvas({ 
							type: '2d', 
							width: canvasWidth.value, 
							height: canvasHeight.value 
						});
						console.log('âœ… ç¦»å±Canvasåˆ›å»ºæˆåŠŸ');
						resolve(canvas);
					} catch (err) {
						console.error('âŒ ç¦»å±Canvasåˆ›å»ºå¤±è´¥:', err);
						reject(err);
					}
				} else {
					const canvas = res[0].node;
					canvas.width = canvasWidth.value;
					canvas.height = canvasHeight.value;
					console.log('âœ… CanvasèŠ‚ç‚¹è·å–æˆåŠŸ');
					resolve(canvas);
				}
			});
		// #endif
		
		// #ifndef MP-WEIXIN
		reject(new Error('ä»…æ”¯æŒå¾®ä¿¡å°ç¨‹åº'));
		// #endif
	});
};

// âœ… ä¼˜åŒ–ï¼šç”Ÿæˆå°ç¨‹åºç ï¼ˆå¢åŠ è¯¦ç»†æ—¥å¿—ï¼‰
const generateArticleQRCode = async () => {
	console.log('ğŸ“ å¼€å§‹ç”Ÿæˆå°ç¨‹åºç ...');
	console.log('   æ–‡ç« ID:', props.articleId);
	
	try {
		const startTime = Date.now();
		const wxacodeApi = uniCloud.importObject('getWxacode', { 
			customUI: true,
			// âœ… å¢åŠ è¶…æ—¶æ—¶é—´
			timeout: 15000
		});
		
		const res = await wxacodeApi.generateArticleQRCode({
			article_id: props.articleId
		});
		
		const elapsed = Date.now() - startTime;
		console.log(`â±ï¸ äº‘å‡½æ•°è°ƒç”¨è€—æ—¶: ${elapsed}ms`);
		
		if (res.errCode === 0 && res.qrcodeBase64) {
			qrcodeBase64.value = res.qrcodeBase64;
			console.log('âœ… å°ç¨‹åºç ç”ŸæˆæˆåŠŸ');
			console.log('   base64é•¿åº¦:', res.qrcodeBase64.length);
			return res.qrcodeBase64;
		} else {
			console.error('âŒ å°ç¨‹åºç ç”Ÿæˆå¤±è´¥:', res.errMsg);
			console.error('   é”™è¯¯è¯¦æƒ…:', res.error);
			return null;
		}
	} catch (err) {
		console.error('âŒ è°ƒç”¨äº‘å‡½æ•°å¤±è´¥:', err);
		console.error('   é”™è¯¯ç±»å‹:', err.name);
		console.error('   é”™è¯¯ä¿¡æ¯:', err.message);
		return null;
	}
};

// ... çœç•¥å…¶ä»–ä»£ç  ...
</script>
```

---

### æ–¹æ¡ˆä¸‰ï¼šä¼˜åŒ–è½¬å‘ç»„ä»¶

**æ–‡ä»¶**: `wx2/components/fenxiang-zujian/fenxiang-zujian.vue`

**å…³é”®ä¼˜åŒ–**:

```javascript
// ç”Ÿæˆåˆ†äº«æµ·æŠ¥
generateSharePoster() {
	// âœ… å¢åŠ ç”ŸæˆçŠ¶æ€æ£€æŸ¥
	if (this.isGeneratingPoster) {
		console.warn('âš ï¸ æµ·æŠ¥ç”Ÿæˆä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');
		return;
	}
	
	this.isGeneratingPoster = true;
	
	uni.showLoading({
		title: 'ç”Ÿæˆæµ·æŠ¥ä¸­...'
	});
	
	// âœ… å¢åŠ è¶…æ—¶ä¿æŠ¤
	const timeoutId = setTimeout(() => {
		if (this.isGeneratingPoster) {
			console.error('âŒ æµ·æŠ¥ç”Ÿæˆè¶…æ—¶');
			this.isGeneratingPoster = false;
			uni.hideLoading();
			uni.showToast({
				title: 'ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•',
				icon: 'none'
			});
		}
	}, 25000); // 25ç§’è¶…æ—¶
	
	// ... å…¶ä½™ä»£ç ä¿æŒä¸å˜ ...
	
	// è®°å¾—åœ¨æˆåŠŸæˆ–å¤±è´¥æ—¶æ¸…é™¤è¶…æ—¶å’ŒçŠ¶æ€
	// clearTimeout(timeoutId);
	// this.isGeneratingPoster = false;
},
```

---

## ğŸ¯ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: ä¸Šä¼ ä¼˜åŒ–åçš„äº‘å‡½æ•° â­â­â­

```
1. å³é”®: uniCloud-aliyun/cloudfunctions/getWxacode
2. é€‰æ‹©: ä¸Šä¼ éƒ¨ç½²
3. ç­‰å¾…ä¸Šä¼ å®Œæˆ
4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤éƒ¨ç½²æˆåŠŸ
```

### æ­¥éª¤2: æ›´æ–°å‰ç«¯ç»„ä»¶

```
1. æ›´æ–° article-poster ç»„ä»¶
2. æ›´æ–° fenxiang-zujian ç»„ä»¶
3. ä¿å­˜å¹¶é‡æ–°ç¼–è¯‘
```

### æ­¥éª¤3: æ¸…é™¤å°ç¨‹åºç¼“å­˜

```
1. å¾®ä¿¡å¼€å‘è€…å·¥å…· > å·¥å…· > æ¸…é™¤ç¼“å­˜
2. åˆ é™¤å°ç¨‹åº > é‡æ–°æ‰«ç è¿›å…¥
3. æµ‹è¯•æµ·æŠ¥ç”Ÿæˆå’Œåˆ†äº«åŠŸèƒ½
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1: æµ·æŠ¥ç”Ÿæˆ

```
1. è¿›å…¥æ–‡ç« è¯¦æƒ…é¡µ
2. ç‚¹å‡»åº•éƒ¨"æµ·æŠ¥"æŒ‰é’®
3. è§‚å¯ŸåŠ è½½è¿‡ç¨‹ï¼ˆåº”åœ¨15ç§’å†…å®Œæˆï¼‰
4. æ£€æŸ¥ç”Ÿæˆçš„æµ·æŠ¥æ˜¯å¦å®Œæ•´
5. æ£€æŸ¥å°ç¨‹åºç æ˜¯å¦æ˜¾ç¤º
6. é•¿æŒ‰ä¿å­˜åˆ°ç›¸å†Œ
```

**é¢„æœŸç»“æœ**:
- âœ… 15ç§’å†…ç”ŸæˆæˆåŠŸ
- âœ… æµ·æŠ¥åŒ…å«æ‰€æœ‰å…ƒç´ ï¼ˆæ ‡é¢˜ã€å›¾ç‰‡ã€å°ç¨‹åºç ï¼‰
- âœ… å°ç¨‹åºç æ¸…æ™°å¯æ‰«æ
- âœ… ä¿å­˜ç›¸å†ŒæˆåŠŸ

### æµ‹è¯•2: è½¬å‘åŠŸèƒ½

```
1. è¿›å…¥æ–‡ç« è¯¦æƒ…é¡µ
2. ç‚¹å‡»å³ä¸Šè§’"..."èœå•
3. é€‰æ‹©"è½¬å‘"
4. æ£€æŸ¥åˆ†äº«å¡ç‰‡æ˜¯å¦æ­£å¸¸
5. å‘é€ç»™æœ‹å‹ï¼Œæ£€æŸ¥æ¥æ”¶æ•ˆæœ
```

**é¢„æœŸç»“æœ**:
- âœ… åˆ†äº«å¡ç‰‡æ˜¾ç¤ºæ­£å¸¸
- âœ… æ ‡é¢˜ã€å°é¢å›¾æ­£ç¡®
- âœ… å¥½å‹ç‚¹å‡»å¯æ­£å¸¸æ‰“å¼€

### æµ‹è¯•3: åˆ†äº«æµ·æŠ¥

```
1. è¿›å…¥æ–‡ç« è¯¦æƒ…é¡µ
2. ç‚¹å‡»"åˆ†äº«"æŒ‰é’®
3. é€‰æ‹©"ç”Ÿæˆæµ·æŠ¥"
4. è§‚å¯Ÿç”Ÿæˆè¿‡ç¨‹
5. ä¿å­˜å¹¶åˆ†äº«
```

**é¢„æœŸç»“æœ**:
- âœ… 20ç§’å†…ç”ŸæˆæˆåŠŸ
- âœ… æµ·æŠ¥å…ƒç´ å®Œæ•´
- âœ… ä¿å­˜æˆåŠŸ

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Access Token ç¼“å­˜
- âœ… å·²å®ç°äº‘å‡½æ•°çº§åˆ«ç¼“å­˜
- â±ï¸ å‡å°‘ API è°ƒç”¨ï¼ŒèŠ‚çœ 500-1000ms

### 2. å›¾ç‰‡é¢„åŠ è½½
```javascript
// åœ¨æ–‡ç« è¯¦æƒ…é¡µåŠ è½½æ—¶é¢„åŠ è½½å›¾ç‰‡
onLoad() {
	// é¢„åŠ è½½æ–‡ç« å°é¢å›¾
	if (this.article.images && this.article.images.length > 0) {
		this.article.images.forEach(img => {
			const image = new Image();
			image.src = fixImageUrl(img.url);
		});
	}
}
```

### 3. æµ·æŠ¥é™é»˜ç”Ÿæˆ
```javascript
// æ–‡ç« è¯¦æƒ…é¡µåŠ è½½å3ç§’ï¼Œé™é»˜ç”Ÿæˆæµ·æŠ¥
onReady() {
	setTimeout(() => {
		uni.$emit('generatePoster', { silent: true });
	}, 3000);
}
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å°ç¨‹åºç ä¸€ç›´ç”Ÿæˆå¤±è´¥
**åŸå› **: access_token è¿‡æœŸæˆ– appId/appSecret é…ç½®é”™è¯¯
**è§£å†³**: 
1. æ£€æŸ¥ `getWxacode/index.obj.js` ä¸­çš„ appId å’Œ appSecret
2. è°ƒç”¨ `clearCache()` æ–¹æ³•æ¸…é™¤ç¼“å­˜
3. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

### Q2: æµ·æŠ¥ç”Ÿæˆå¾ˆæ…¢ï¼ˆè¶…è¿‡15ç§’ï¼‰
**åŸå› **: ç½‘ç»œæ…¢æˆ–å›¾ç‰‡åŠ è½½æ…¢
**è§£å†³**:
1. ä½¿ç”¨å‹ç¼©åçš„å›¾ç‰‡ï¼ˆcompressedURLï¼‰
2. å‡å°‘å›¾ç‰‡æ•°é‡ï¼ˆæœ€å¤š8å¼ ï¼‰
3. å¯ç”¨å›¾ç‰‡é¢„åŠ è½½

### Q3: è½¬å‘æ—¶æ²¡æœ‰å°é¢å›¾
**åŸå› **: åˆ†äº«é…ç½®ä¸­ imageUrl æœªè®¾ç½®æˆ–æ ¼å¼é”™è¯¯
**è§£å†³**:
1. æ£€æŸ¥ `onShareAppMessage` è¿”å›çš„ imageUrl
2. ä½¿ç”¨å®Œæ•´çš„ https:// URL
3. å›¾ç‰‡å°ºå¯¸å»ºè®® 5:4 æ¯”ä¾‹

### Q4: éƒ¨åˆ†ç”¨æˆ·æµ·æŠ¥æ— æ³•ç”Ÿæˆ
**åŸå› **: å°ç¨‹åºç‰ˆæœ¬è¿‡ä½æˆ–æƒé™é—®é¢˜
**è§£å†³**:
1. æç¤ºç”¨æˆ·æ›´æ–°å¾®ä¿¡åˆ°æœ€æ–°ç‰ˆæœ¬
2. æ£€æŸ¥ç›¸å†Œæƒé™è®¾ç½®
3. ä½¿ç”¨ç¦»å± Canvas é™çº§æ–¹æ¡ˆ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å‰ç«¯æ—¥å¿—**
   - å¾®ä¿¡å¼€å‘è€…å·¥å…·æ§åˆ¶å°å®Œæ•´æ—¥å¿—
   - æœç´¢å…³é”®è¯ï¼š`ç”Ÿæˆæµ·æŠ¥`ã€`å°ç¨‹åºç `

2. **äº‘å‡½æ•°æ—¥å¿—**
   - uniCloud æ§åˆ¶å° > äº‘å‡½æ•°æ—¥å¿—
   - æœç´¢å…³é”®è¯ï¼š`generateArticleQRCode`

3. **é”™è¯¯æˆªå›¾**
   - é”™è¯¯æç¤ºæˆªå›¾
   - ç”Ÿæˆå¤±è´¥çš„æµ·æŠ¥æˆªå›¾

4. **æµ‹è¯•ç¯å¢ƒ**
   - å¾®ä¿¡ç‰ˆæœ¬
   - æ‰‹æœºå‹å·å’Œç³»ç»Ÿç‰ˆæœ¬
   - ç½‘ç»œç¯å¢ƒï¼ˆWiFi / 4G / 5Gï¼‰

---

**ä¿®å¤å®Œæˆåè¯·è¿›è¡Œå®Œæ•´æµ‹è¯•ï¼** ğŸš€
