# 砍价返现逻辑修改说明

## 一、业务逻辑变更概述

### 原逻辑：
1. 用户发起砍价活动
2. 好友帮忙砍价，价格逐步降低
3. 砍到一定金额后可以买断（支付剩余金额）

### 新逻辑：
1. 用户先**原价购买**商品
2. 购买成功后成为**小组长**
3. 小组长分享给好友帮忙砍价
4. 每砍一刀，**小组长获得返现**（通过微信商家打款）
5. 累计返现最多达到原价（相当于全额返还）

---

## 二、主要修改内容

### 1. 数据库Schema修改

#### 1.1 kanjia表（砍价记录表）新增字段：
```json
{
  "cashback_amount": "本次返现金额（元）",
  "cashback_status": "返现状态：0-待返现，1-已返现，2-返现失败",
  "cashback_time": "返现时间",
  "transaction_id": "企业付款交易单号",
  "cashback_error": "返现失败原因"
}
```

**文件位置**：`wx2/uniCloud-aliyun/database/kanjia.schema.json`

#### 1.2 buyout_orders表（订单表）新增字段：
```json
{
  "original_price": "原价（元）",
  "total_cashback": "累计已返现金额（元）",
  "cashback_limit": "返现上限（元），通常等于原价",
  "is_cashback_complete": "返现是否已达上限"
}
```

**文件位置**：`wx2/uniCloud-aliyun/database/buyout_orders.schema.json`

---

### 2. 云函数修改

#### 2.1 砍价逻辑修改（bargain方法）
**文件位置**：`wx2/uniCloud-aliyun/cloudfunctions/articleWx/index.obj.js`

**主要变化**：
- ✅ 必须先购买才能获得返现
- ✅ 检查订单是否已支付（status: 1）
- ✅ 检查返现是否已达上限
- ✅ 计算返现金额（保持原砍价模式：固定/随机/递减/百分比）
- ✅ 限制返现金额不超过剩余可返现额度
- ✅ 更新订单的累计返现金额
- ✅ 创建砍价记录，标记为待返现状态（cashback_status: 0）

**关键代码**（第1336-1644行）：
```javascript
// 检查发起人是否已购买
const orderRes = await buyoutOrderCollection
  .where({
    article_id: article_id,
    user_id: actualInitiatorId,
    status: 1  // 必须是已支付状态
  })
  .get();

if (!orderRes.data || orderRes.data.length === 0) {
  return {
    errCode: -1,
    errMsg: '小组长还未购买，无法获得返现'
  };
}
```

#### 2.2 订单创建修改（createBuyoutOrder方法）
**主要变化**：
- ✅ 改为原价购买订单（不是买断订单）
- ✅ 任何人都可以购买（不限制为小组长）
- ✅ 每人只能购买一次
- ✅ 初始化返现相关字段（total_cashback: 0, cashback_limit: 原价）

**关键代码**（第2283-2415行）：
```javascript
const orderData = {
  order_no: orderNo,
  article_id: article_id,
  user_id: user_id,
  buyout_price: originalPrice, // 原价
  original_price: originalPrice,
  total_cashback: 0, // 初始为0
  cashback_limit: originalPrice, // 返现上限等于原价
  is_cashback_complete: false,
  status: 0, // 待支付
  // ...
};
```

#### 2.3 支付完成修改（completeBuyout方法）
**主要变化**：
- ✅ 不再创建买断记录到kanjia表
- ✅ 不再下架文章
- ✅ 只更新订单状态为已支付
- ✅ 用户成为小组长，可以开始分享砍价获得返现

**关键代码**（第2407-2511行）：
```javascript
// 更新订单状态为已支付
await buyoutOrderCollection.doc(order._id).update({
  status: 1,
  update_time: now,
  complete_time: now
});

console.log('🎉 原价购买完成，用户成为小组长，可以开始分享砍价获得返现');
```

#### 2.4 支付回调修改
**文件位置**：`wx2/uni_modules/uni-pay/uniCloud/cloudfunctions/uni-pay-co/notify/recharge.js`

**主要变化**：
- ✅ 不创建买断记录
- ✅ 不下架文章
- ✅ 只更新订单状态为已支付

**关键代码**（第28-151行）：
```javascript
// 更新购买订单状态为已支付
await db.collection('buyout_orders').doc(buyoutOrder._id).update({
  status: 1,
  update_time: now,
  complete_time: now
});

console.log('🎉 用户已成为小组长，可以开始分享砍价获得返现！');
```

---

### 3. 企业付款到零钱功能

#### 3.1 新增返现处理模块
**文件位置**：`wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-handler.js`

**功能**：
- ✅ 处理单次砍价返现
- ✅ 批量处理待返现记录
- ✅ 调用微信企业付款API
- ✅ 更新返现状态

**核心方法**：
```javascript
class CashbackHandler {
  // 处理单次返现
  async processCashback(params) { ... }
  
  // 调用微信企业付款API
  async transferToBalance(params) { ... }
  
  // 批量处理待返现记录
  async processPendingCashbacks() { ... }
}
```

#### 3.2 云函数新增方法
**文件位置**：`wx2/uniCloud-aliyun/cloudfunctions/articleWx/index.obj.js`

新增两个方法：
1. **processCashback(bargain_record_id, user_id)**：处理单次返现
2. **batchProcessCashbacks()**：批量处理待返现记录

**调用方式**：
```javascript
// 方式1：立即返现（在bargain方法中，目前注释掉了）
await this.processCashback(newRecordId, actualInitiatorId);

// 方式2：批量返现（通过定时任务调用）
await articleApi.batchProcessCashbacks();
```

---

### 4. 前端显示修改

#### 4.1 组件修改
**文件位置**：`wx2/components/dianzan/dianzan.vue`

**主要变化**：
- ✅ "已砍" → "已返现"（第50行）
- ✅ "当前价格" → "剩余: ¥XX"（第64行）
- ✅ 飘红动画："-¥XX" → "+¥XX"（第93行）
- ✅ "买断"按钮 → "立即购买"按钮（第75行）
- ✅ 按钮显示逻辑：未购买显示"立即购买"，已购买显示"分享砍价"
- ✅ 提示文字：
  - "砍价已完成" → "返现已达上限"（第709行）
  - "砍掉¥XX" → "小组长返现¥XX"（第886行）
  - "这是您自己的砍价活动" → "这是您自己的返现活动"（第738行）

**显示效果对比**：

| 原显示 | 新显示 |
|--------|--------|
| 原价: ¥100<br>已砍: ¥30 | 原价: ¥100<br>已返现: ¥30 |
| ¥70（剩余价格） | 剩余: ¥70（剩余可返现） |
| 砍掉¥5 | 小组长返现¥5 |
| 买断 | 立即购买 |

---

## 三、返现处理方案

### ⚠️ 重要：微信支付API版本选择

微信支付提供两个版本的转账API：

| API版本 | 名称 | 状态 | 推荐度 |
|---------|------|------|--------|
| V2 | 企业付款到零钱 | ⚠️ 即将废弃 | ❌ 不推荐 |
| V3 | 商家转账到零钱 | ✅ 官方推荐 | ⭐⭐⭐⭐⭐ 强烈推荐 |

**建议**：使用 **V3 商家转账到零钱** API

详细配置请查看：
- **V3配置文档**：`商家转账V3配置指南.md` ⭐ 推荐
- **V2配置文档**：`企业付款到零钱配置指南.md`（仅供参考）

### 方案A：同步返现（立即返现）
**优点**：用户体验好，砍价成功立即到账  
**缺点**：影响砍价响应速度，高并发时可能超时

**实现方式**：
在 `bargain` 方法中取消注释以下代码：
```javascript
try {
  console.log('开始立即处理返现...');
  await this.processCashback(newRecordId, actualInitiatorId);
} catch (cashbackErr) {
  console.error('立即返现失败，将通过定时任务重试:', cashbackErr);
}
```

### 方案B：异步返现（⭐ 强烈推荐）
**优点**：不影响砍价响应速度，系统稳定性高  
**缺点**：返现有延迟（通常1-5分钟）

**实现方式**：
创建定时任务，每分钟调用一次：
```javascript
// uniCloud定时任务
exports.main = async (event, context) => {
  const articleWx = uniCloud.importObject('articleWx');
  const result = await articleWx.batchProcessCashbacks();
  console.log('批量返现处理结果:', result);
  return result;
};
```

---

## 四、微信转账API配置

### 推荐：使用V3商家转账API

详细配置步骤请查看：**《商家转账V3配置指南.md》**

**快速配置步骤**：
1. 获取商户号、证书序列号、APIv3密钥
2. 获取平台证书
3. 配置 `cashback-handler-v3.js`
4. 测试转账

**关键配置信息**：
```javascript
{
  mchid: '商户号',
  serial_no: '证书序列号',
  apiv3_key: 'APIv3密钥（32位）',
  private_key: '商户私钥（完整内容）',
  transfer_scene_id: '1001' // 转账场景ID
}
```

### 备选：V2企业付款（不推荐）

### 4.1 需要的配置信息
在 `cashback-handler.js` 中配置以下信息：

```javascript
this.config = {
  appid: 'wx_your_appid',        // 小程序APPID
  mch_id: 'your_mch_id',         // 商户号
  api_key: 'your_api_key',       // API密钥
  cert_path: '/path/to/cert',    // API证书路径
  key_path: '/path/to/key'       // API证书密钥路径
};
```

### 4.2 企业付款API说明
- **接口地址**：`https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers`
- **证书要求**：需要商户API证书（apiclient_cert.pem 和 apiclient_key.pem）
- **金额单位**：分（需要将元转换为分）
- **限制**：
  - 每日限额：100万元
  - 单次最小金额：0.3元
  - 单次最大金额：2000元

### 4.3 用户openid获取
返现需要用户的微信openid，确保在用户登录时保存openid到数据库：
```javascript
// uni-id-users 表的 wx_openid 字段
await db.collection('uni-id-users').doc(user_id).update({
  wx_openid: [openid]  // 数组格式
});
```

---

## 五、测试建议

### 5.1 功能测试
1. **购买流程测试**
   - ✅ 测试原价购买订单创建
   - ✅ 测试支付成功后订单状态更新
   - ✅ 测试购买后成为小组长

2. **砍价流程测试**
   - ✅ 测试未购买用户砍价（应提示"小组长还未购买"）
   - ✅ 测试已购买用户砍价（应成功）
   - ✅ 测试返现金额计算
   - ✅ 测试返现上限限制

3. **返现流程测试**
   - ✅ 测试待返现记录创建（cashback_status: 0）
   - ✅ 测试返现成功状态更新（cashback_status: 1）
   - ✅ 测试返现失败处理（cashback_status: 2）

4. **边界测试**
   - ✅ 测试累计返现达到上限
   - ✅ 测试重复购买限制
   - ✅ 测试重复砍价限制

### 5.2 数据验证
```javascript
// 验证订单数据
db.collection('buyout_orders').doc(order_id).get();
// 检查：total_cashback, cashback_limit, is_cashback_complete

// 验证砍价记录数据
db.collection('kanjia').where({ initiator_id: user_id }).get();
// 检查：cashback_amount, cashback_status, transaction_id
```

---

## 六、注意事项

### 6.1 重要提示
1. ⚠️ **企业付款功能需要配置**：在 `cashback-handler.js` 中配置商户信息和证书
2. ⚠️ **建议使用异步返现**：避免影响砍价响应速度
3. ⚠️ **确保用户有openid**：返现需要用户的微信openid
4. ⚠️ **金额单位转换**：微信API使用分，代码中使用元，需要转换
5. ⚠️ **返现限额**：注意微信企业付款的每日限额和单笔限额

### 6.2 兼容性考虑
- ✅ 保留了 `current_price` 字段（表示剩余可返现金额），保持向下兼容
- ✅ 保留了 `bargain_amount` 字段（现在表示返现金额），含义略有变化
- ✅ 前端显示文字已更新，但数据结构兼容旧版本

### 6.3 安全建议
- ✅ 验证支付金额与订单金额一致（防止篡改）
- ✅ 防止重复购买（每人只能购买一次）
- ✅ 防止重复砍价（每人只能帮同一小组长砍一次）
- ✅ 防止返现金额超过上限

---

## 七、部署步骤

### 7.1 数据库更新
1. 备份现有数据库
2. 更新数据库Schema（会自动添加新字段）
3. 对现有数据执行迁移（如有需要）

### 7.2 云函数部署
1. 上传云函数代码
2. 配置企业付款参数（在 `cashback-handler.js` 中）
3. 测试云函数调用

### 7.3 前端部署
1. 更新前端组件
2. 测试界面显示
3. 测试完整流程

### 7.4 定时任务配置（如使用异步返现）
1. 创建uniCloud定时任务
2. 设置每分钟执行一次
3. 调用 `batchProcessCashbacks` 方法

---

## 八、文件修改清单

### 修改的文件：
1. ✅ `wx2/uniCloud-aliyun/database/kanjia.schema.json`
2. ✅ `wx2/uniCloud-aliyun/database/buyout_orders.schema.json`
3. ✅ `wx2/uniCloud-aliyun/cloudfunctions/articleWx/index.obj.js`
4. ✅ `wx2/uni_modules/uni-pay/uniCloud/cloudfunctions/uni-pay-co/notify/recharge.js`
5. ✅ `wx2/components/dianzan/dianzan.vue`

### 新增的文件：
1. ✅ `wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-handler.js`（V2版本，备用）
2. ✅ `wx2/uniCloud-aliyun/cloudfunctions/articleWx/cashback-handler-v3.js`（⭐ V3版本，推荐）
3. ✅ `砍价返现逻辑修改说明.md`（本文档）
4. ✅ `企业付款到零钱配置指南.md`（V2配置文档）
5. ✅ `商家转账V3配置指南.md`（⭐ V3配置文档，推荐）

---

## 九、常见问题

### Q1: 返现失败怎么办？
**A**: 返现失败会标记为 `cashback_status: 2`，定时任务会自动重试。可以手动调用 `processCashback` 方法重新处理。

### Q2: 如何查看待返现的记录？
**A**: 
```javascript
db.collection('kanjia')
  .where({ cashback_status: 0 })
  .get();
```

### Q3: 返现到账需要多久？
**A**: 
- 同步返现：立即（3-5秒）
- 异步返现：1-5分钟（取决于定时任务执行频率）

### Q4: 用户没有openid怎么办？
**A**: 返现会失败并记录错误信息。需要确保用户登录时获取并保存openid。

### Q5: 企业付款API证书如何获取？
**A**: 登录微信商户平台 → 账户中心 → API安全 → 下载证书

---

## 十、后续优化建议

1. **返现通知**：
   - 发送模板消息通知用户返现到账
   - 在小程序内显示返现记录

2. **返现记录查询**：
   - 添加用户查看返现记录的页面
   - 显示返现明细和状态

3. **返现统计**：
   - 统计每日返现总额
   - 统计返现成功率
   - 监控返现失败原因

4. **风控机制**：
   - 检测异常砍价行为
   - 限制单用户每日返现上限
   - 添加黑名单机制

5. **性能优化**：
   - 批量返现时使用队列
   - 添加返现缓存机制
   - 优化数据库查询

---

**修改完成时间**：2026-01-29  
**修改人**：AI Assistant  
**版本**：v1.0
