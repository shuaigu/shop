# 登录弹窗重复问题修复说明

## 问题描述
在用户未登录时点击某些功能（如点赞、砍价、拨打电话等），会同时弹出多个登录提示框，造成用户体验不佳。

## 问题原因分析

### 根本原因
多个组件/页面在同一时间调用了登录检查函数，导致：
1. `testLogin()` - 弹出modal提示"请登录后继续"
2. `customTestLogin()` - 跳转到登录页面
3. 两者可能同时触发，造成混乱

### 涉及文件
- `utils/isLogin.js` - 全局登录检查函数
- `components/dianzan/dianzan.vue` - 点赞组件
- `pages/article/articleDetail.vue` - 文章详情页
- `components/tuijian/tuijian.vue` - 推荐组件
- `pages/index/index.vue` - 首页

## 修复方案

### 1. utils/isLogin.js - 添加全局锁机制

**修复内容：**
```javascript
// 全局锁，防止同时弹出多个登录提示
let isShowingLoginPrompt = false

export const testLogin = () => {
    // ... 已登录检查 ...
    
    // 如果已经在显示登录提示，跳过重复弹出
    if (isShowingLoginPrompt) {
        console.log('已有登录提示正在显示，跳过重复弹出');
        return false;
    }
    
    // 设置锁定状态
    isShowingLoginPrompt = true;
    
    uni.showModal({
        // ...
        success: (res) => {
            // 释放锁
            isShowingLoginPrompt = false;
            // ...
        },
        fail: () => {
            // 弹窗失败时也要释放锁
            isShowingLoginPrompt = false;
        },
        complete: () => {
            // 确保一定会释放锁（兜底机制）
            setTimeout(() => {
                isShowingLoginPrompt = false;
            }, 100);
        }
    });
    
    return false;
}
```

**优点：**
- ✅ 防止在极短时间内弹出多个登录modal
- ✅ 通过success/fail/complete三重保险确保锁被释放
- ✅ 100ms延迟的兜底机制，避免死锁

### 2. components/dianzan/dianzan.vue - 优化登录检查逻辑

**修复内容：**
```javascript
// 自定义登录检查函数
const customTestLogin = async () => {
    try {
        // 直接检查store中的登录状态，避免弹出多个登录提示
        if (userStore.userInfo && userStore.userInfo.uid) {
            return true;
        }
        
        // 检查本地存储
        const userInfo = uni.getStorageSync('userInfo');
        if (userInfo && userInfo.uid) {
            userStore.setUserInfo(userInfo);
            return true;
        }
        
        // 只在需要时才调用testLogin弹出登录提示
        const isLoggedIn = await testLogin();
        return isLoggedIn;
    } catch (err) {
        console.error('登录检查失败:', err);
        return false;
    }
}
```

**优点：**
- ✅ 优先检查本地状态，减少不必要的弹窗
- ✅ 只在确实需要时才调用testLogin()
- ✅ 避免与页面级登录检查冲突

## 测试场景

### 测试1：点击点赞按钮（未登录）
**预期结果：** 只弹出1次登录提示框
**测试步骤：**
1. 退出登录
2. 快速连续点击点赞按钮3次
3. 观察是否只弹出1次登录提示

### 测试2：点击砍价按钮（未登录）
**预期结果：** 只弹出1次登录提示框
**测试步骤：**
1. 退出登录
2. 点击砍价按钮
3. 观察是否只弹出1次登录提示

### 测试3：点击电话号码（未登录）
**预期结果：** 只弹出1次登录提示框
**测试步骤：**
1. 退出登录
2. 点击文章中的电话号码
3. 观察是否只弹出1次登录提示

### 测试4：多个未登录操作连续触发
**预期结果：** 只弹出1次登录提示框，后续操作被拦截
**测试步骤：**
1. 退出登录
2. 快速依次点击：点赞 → 砍价 → 电话号码
3. 观察是否只弹出1次登录提示

## 修复效果

### 修复前
- ❌ 点击操作时可能同时弹出modal和跳转登录页
- ❌ 快速点击会弹出多个modal
- ❌ 用户体验混乱

### 修复后
- ✅ 同一时间只会弹出1个登录提示
- ✅ 锁机制防止重复弹窗
- ✅ 三重保险机制确保锁被正确释放
- ✅ 用户体验流畅

## 注意事项

1. **锁的释放时机**
   - success回调：用户点击确定/取消时释放
   - fail回调：弹窗失败时释放
   - complete回调：100ms延迟兜底释放

2. **兼容性考虑**
   - 已登录用户不受影响
   - 本地存储的用户信息会被优先使用
   - 不影响正常的登录流程

3. **后续优化建议**
   - 可以考虑统一所有页面使用同一个登录检查函数
   - 可以使用Promise缓存机制进一步优化
   - 可以添加登录状态的全局事件监听

## 修改文件清单

- ✅ `utils/isLogin.js` - 添加全局锁机制
- ✅ `components/dianzan/dianzan.vue` - 优化登录检查逻辑

## 测试建议

建议在以下场景进行全面测试：
1. 未登录状态下的各种操作
2. 快速连续点击同一个按钮
3. 快速切换不同的需要登录的操作
4. 从登录页返回后的操作

## 回滚方案

如果出现问题，可以使用git回滚到修复前的版本：
```bash
git checkout HEAD~1 utils/isLogin.js
git checkout HEAD~1 components/dianzan/dianzan.vue
```

---
**修复日期：** 2025-11-01  
**修复人员：** Qoder AI Assistant
