# ç ä»·è¿”ç°åŠŸèƒ½é›†æˆè¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å•†å®¶è½¬è´¦è¿”ç°åŠŸèƒ½å·²å®Œå…¨é›†æˆåˆ°ç ä»·æµç¨‹ä¸­ã€‚å½“å¥½å‹å¸®å¿™ç ä»·æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç»™åˆ†äº«ç”¨æˆ·ï¼ˆå°ç»„é•¿ï¼‰è¿›è¡Œå¾®ä¿¡è½¬è´¦è¿”ç°ã€‚

## å·¥ä½œæµç¨‹

### 1. ç”¨æˆ·è´­ä¹°å•†å“
- ç”¨æˆ·ä»¥åŸä»·è´­ä¹°å•†å“ï¼Œæˆä¸ºå°ç»„é•¿
- ç³»ç»Ÿåœ¨ `buyout_orders` è¡¨ä¸­åˆ›å»ºè®¢å•è®°å½•
- è®¢å•åŒ…å«è¿”ç°ä¸Šé™ï¼ˆç­‰äºè´­ä¹°ä»·æ ¼ï¼‰

### 2. å¥½å‹å¸®ç è§¦å‘è¿”ç°
å½“å¥½å‹ç‚¹å‡»"å¸®ç ä¸€åˆ€"æŒ‰é’®æ—¶ï¼š

```javascript
// ä½ç½®ï¼šuniCloud-aliyun/cloudfunctions/articleWx/index.obj.js
// æ–¹æ³•ï¼šbargain (ç¬¬1337-1657è¡Œ)

// 1. éªŒè¯å¥½å‹èº«ä»½ï¼ˆä¸èƒ½è‡ªå·±å¸®è‡ªå·±ç ï¼‰
if (user_id === initiator_id) {
    return { errCode: -1, errMsg: 'ä¸èƒ½å¸®è‡ªå·±ç ä»·ï¼Œè¯·åˆ†äº«ç»™å¥½å‹å¸®å¿™ï¼' }
}

// 2. æ£€æŸ¥å°ç»„é•¿æ˜¯å¦å·²è´­ä¹°
const orderRes = await buyoutOrderCollection.where({
    article_id: article_id,
    user_id: actualInitiatorId,
    status: 1  // å¿…é¡»æ˜¯å·²æ”¯ä»˜çŠ¶æ€
}).get()

// 3. è®¡ç®—è¿”ç°é‡‘é¢ï¼ˆæ ¹æ®ç ä»·æ¨¡å¼ï¼‰
// - å›ºå®šé‡‘é¢æ¨¡å¼ï¼šå›ºå®šé‡‘é¢
// - éšæœºé‡‘é¢æ¨¡å¼ï¼šéšæœºåŒºé—´
// - ç™¾åˆ†æ¯”æ¨¡å¼ï¼šåŸºäºåŸä»·ç™¾åˆ†æ¯”
// - é€’å‡æ¨¡å¼ï¼šéšç ä»·æ¬¡æ•°é€’å‡

// 4. åˆ›å»ºç ä»·è®°å½•
await this.bargainRecordCollection.add({
    article_id,
    initiator_id: actualInitiatorId,
    user_id: user_id,
    bargain_amount: actualCashbackAmount,
    cashback_amount: actualCashbackAmount,
    cashback_status: 0, // 0-å¾…è¿”ç°ï¼Œ1-å·²è¿”ç°ï¼Œ2-è¿”ç°å¤±è´¥
    // ... å…¶ä»–å­—æ®µ
})

// 5. ğŸ”¥ ç«‹å³è§¦å‘è¿”ç°ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å“åº”ï¼‰
this.processCashback(newRecordId, actualInitiatorId)
    .then(result => {
        if (result.errCode === 0) {
            console.log('âœ… ç«‹å³è¿”ç°æˆåŠŸï¼å°ç»„é•¿å·²æ”¶åˆ° Â¥' + actualCashbackAmount)
        } else {
            console.log('âš ï¸ ç«‹å³è¿”ç°å¤±è´¥ï¼Œå°†é€šè¿‡å®šæ—¶ä»»åŠ¡é‡è¯•:', result.errMsg)
        }
    })
```

### 3. è¿”ç°å¤„ç†æµç¨‹

```javascript
// ä½ç½®ï¼šuniCloud-aliyun/cloudfunctions/articleWx/index.obj.js
// æ–¹æ³•ï¼šprocessCashback (ç¬¬2561-2641è¡Œ)

async processCashback(bargain_record_id, user_id) {
    // 1. æŸ¥è¯¢ç ä»·è®°å½•
    const record = await this.bargainRecordCollection.doc(bargain_record_id).get()
    
    // 2. æ£€æŸ¥æ˜¯å¦å·²è¿”ç°ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    if (record.cashback_status === 1) {
        return { errCode: 0, errMsg: 'å·²è¿”ç°' }
    }
    
    // 3. è·å–ç”¨æˆ·openid
    const openid = await this.userCollection.doc(user_id)
        .field({ wx_openid: true })
        .get()
    
    // 4. è°ƒç”¨å¾®ä¿¡å•†å®¶è½¬è´¦APIï¼ˆV3ç‰ˆæœ¬ï¼‰
    const cashbackHandler = new CashbackHandlerV3()
    const result = await cashbackHandler.processCashback({
        bargain_record_id,
        user_id,
        openid,
        amount: record.cashback_amount,
        desc: 'ç ä»·è¿”ç°'
    })
    
    // 5. æ›´æ–°ç ä»·è®°å½•çŠ¶æ€
    // - æˆåŠŸï¼šcashback_status = 1, cashback_time = å½“å‰æ—¶é—´
    // - å¤±è´¥ï¼šcashback_status = 2, cashback_error = é”™è¯¯ä¿¡æ¯
}
```

### 4. å¾®ä¿¡è½¬è´¦å®ç°

```javascript
// ä½ç½®ï¼šuniCloud-aliyun/cloudfunctions/articleWx/cashback-handler-v3.js
// ç±»ï¼šCashbackHandlerV3

class CashbackHandlerV3 {
    // ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜V3 API
    async transferToBalance(params) {
        // 1. æ„å»ºè¯·æ±‚å‚æ•°
        const requestData = {
            appid: this.config.appid,
            out_batch_no: 'æ‰¹æ¬¡å•å·',
            batch_name: 'ç ä»·è¿”ç°',
            total_amount: amount, // é‡‘é¢ï¼ˆåˆ†ï¼‰
            total_num: 1,
            transfer_detail_list: [{
                out_detail_no: 'æ˜ç»†å•å·',
                transfer_amount: amount,
                transfer_remark: 'ç ä»·è¿”ç°',
                openid: openid
            }],
            transfer_scene_id: '1001' // åˆ†é”€è¿”ä½£åœºæ™¯
        }
        
        // 2. V3ç­¾åè®¤è¯
        // 3. è°ƒç”¨å¾®ä¿¡è½¬è´¦æ¥å£
        // 4. å¤„ç†å“åº”ç»“æœ
    }
}
```

## é…ç½®è¯´æ˜

### 1. å¾®ä¿¡æ”¯ä»˜é…ç½®
é…ç½®æ–‡ä»¶ï¼š`uniCloud-aliyun/cloudfunctions/articleWx/cashback-config.js`

```javascript
module.exports = {
    appid: 'wx06e0cxxxxxxxx',           // å°ç¨‹åºappid
    mchid: '1690xxxxxx',                 // å•†æˆ·å·
    serial_no: '5CA2xxxxxx',             // è¯ä¹¦åºåˆ—å·
    apiv3_key: '9E0FBxxxxxxxx',          // APIv3å¯†é’¥
    private_key: '-----BEGIN PRIVATE KEY-----...', // å•†æˆ·ç§é’¥
    platform_cert: '-----BEGIN CERTIFICATE-----...', // å¹³å°è¯ä¹¦
    transfer_scene_id: '1001'            // è½¬è´¦åœºæ™¯IDï¼ˆåˆ†é”€è¿”ä½£ï¼‰
}
```

### 2. è¿”ç°é™åˆ¶
- **å•ç¬”é‡‘é¢**ï¼š0.10å…ƒ ~ 500å…ƒ
- **å…å¯†é‡‘é¢**ï¼šä½äº100å…ƒå…å¯†è½¬è´¦
- **è¿”ç°ä¸Šé™**ï¼šä¸è¶…è¿‡è´­ä¹°ä»·æ ¼
- **é˜²åˆ·æœºåˆ¶**ï¼š
  - æ¯äººåªèƒ½å¸®åŒä¸€å‘èµ·äººç ä¸€æ¬¡
  - ç ä»·é—´éš”è‡³å°‘3ç§’
  - ä¸èƒ½è‡ªå·±å¸®è‡ªå·±ç ä»·

## å‰ç«¯ç”¨æˆ·ä½“éªŒ

### 1. ç ä»·æˆåŠŸæç¤º
å¥½å‹å¸®ç æˆåŠŸåï¼Œå‰ç«¯ä¼šæ˜¾ç¤ºï¼š

```vue
<!-- ä½ç½®ï¼šcomponents/dianzan/dianzan.vue (ç¬¬883-890è¡Œ) -->
uni.showToast({
    title: `è¿”ç°æˆåŠŸÂ¥${result.bargain_amount.toFixed(2)}`,
    image: '/static/images/ç ä»·3.png',
    duration: 4000
})
```

### 2. è¿”ç°åˆ°è´¦
- âœ… **ç«‹å³åˆ°è´¦**ï¼šç ä»·æˆåŠŸåï¼Œå°ç»„é•¿å¾®ä¿¡é›¶é’±ç«‹å³æ”¶åˆ°è½¬è´¦
- âœ… **å¾®ä¿¡é€šçŸ¥**ï¼šå¾®ä¿¡ä¼šå‘é€è½¬è´¦åˆ°è´¦é€šçŸ¥
- âœ… **è®°å½•å¯æŸ¥**ï¼šåœ¨å¾®ä¿¡"æœåŠ¡é€šçŸ¥"ä¸­å¯æŸ¥çœ‹è½¬è´¦è¯¦æƒ…

## å®¹é”™æœºåˆ¶

### 1. è¿”ç°å¤±è´¥é‡è¯•
å¦‚æœè¿”ç°å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ã€ä½™é¢ä¸è¶³ç­‰ï¼‰ï¼Œç³»ç»Ÿä¼šï¼š
- ä¿æŒç ä»·è®°å½•çŠ¶æ€ä¸º"å¾…è¿”ç°"ï¼ˆcashback_status = 0ï¼‰
- é€šè¿‡å®šæ—¶ä»»åŠ¡è‡ªåŠ¨é‡è¯•
- æœ€å¤šé‡è¯•50æ¡å¾…è¿”ç°è®°å½•

```javascript
// æ‰¹é‡å¤„ç†å¾…è¿”ç°è®°å½•
async batchProcessCashbacks() {
    const cashbackHandler = new CashbackHandlerV3()
    const result = await cashbackHandler.processPendingCashbacks()
}
```

### 2. æ•°æ®åº“è®°å½•
æ¯æ¬¡è¿”ç°éƒ½ä¼šåœ¨ `kanjia` è¡¨ä¸­è®°å½•ï¼š

```javascript
{
    _id: 'è®°å½•ID',
    article_id: 'æ–‡ç« ID',
    initiator_id: 'å°ç»„é•¿ID',
    user_id: 'å¸®ç ç”¨æˆ·ID',
    bargain_amount: 10.00,           // æœ¬æ¬¡ç ä»·é‡‘é¢
    cashback_amount: 10.00,          // æœ¬æ¬¡è¿”ç°é‡‘é¢
    cashback_status: 1,              // 0-å¾…è¿”ç°ï¼Œ1-å·²è¿”ç°ï¼Œ2-å¤±è´¥
    cashback_time: 1234567890,       // è¿”ç°æ—¶é—´
    transaction_id: 'wx2021xxx',     // å¾®ä¿¡è½¬è´¦å•å·
    create_time: 1234567890
}
```

## æµ‹è¯•åŠŸèƒ½

### æµ‹è¯•é¡µé¢
ä½ç½®ï¼š`pages/article/testCashback.vue`

åŠŸèƒ½ï¼š
- æ‰‹åŠ¨è¾“å…¥ç”¨æˆ·IDå’Œé‡‘é¢
- æµ‹è¯•è¿”ç°æµç¨‹
- æŸ¥çœ‹äº‘å‡½æ•°å‡ºå£IP
- æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

### ä½¿ç”¨æ–¹æ³•
```javascript
// è·³è½¬åˆ°æµ‹è¯•é¡µé¢
uni.navigateTo({
    url: '/pages/article/testCashback'
})
```

## ç›‘æ§ä¸æ—¥å¿—

### å…³é”®æ—¥å¿—ä½ç½®

1. **ç ä»·è§¦å‘**
```
ç ä»·è¿”ç°æ“ä½œå‚æ•°: { article_id, user_id, initiator_id, bargainStep, initialPrice }
```

2. **è¿”ç°è§¦å‘**
```
ğŸ’° è§¦å‘ç«‹å³è¿”ç°ï¼Œå°ç»„é•¿å°†ç«‹å³æ”¶åˆ°å¾®ä¿¡è½¬è´¦...
âœ… ç«‹å³è¿”ç°æˆåŠŸï¼å°ç»„é•¿å·²æ”¶åˆ° Â¥10.00
```

3. **è¿”ç°å¤„ç†**
```
å¼€å§‹å¤„ç†è¿”ç°ï¼ˆV3 APIï¼‰: { bargain_record_id, user_id, openid, amount }
âœ… å•†å®¶è½¬è´¦æˆåŠŸï¼ˆV3ï¼‰: { batch_id, out_batch_no, create_time }
```

## å¸¸è§é—®é¢˜

### Q1: è¿”ç°æ²¡æœ‰åˆ°è´¦ï¼Ÿ
**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç»‘å®šäº†openidï¼ˆå¿…é¡»æˆæƒå¾®ä¿¡ç™»å½•ï¼‰
2. æŸ¥çœ‹ `kanjia` è¡¨ä¸­ `cashback_status` å­—æ®µï¼š
   - 0ï¼šå¾…è¿”ç°ï¼ˆç­‰å¾…é‡è¯•ï¼‰
   - 1ï¼šå·²è¿”ç°
   - 2ï¼šè¿”ç°å¤±è´¥ï¼ˆæŸ¥çœ‹ `cashback_error` å­—æ®µï¼‰
3. æ£€æŸ¥å•†æˆ·ä½™é¢æ˜¯å¦å……è¶³
4. æ£€æŸ¥å•†æˆ·å·æ˜¯å¦æœ‰è½¬è´¦æƒé™

### Q2: å¦‚ä½•æŸ¥çœ‹è¿”ç°è®°å½•ï¼Ÿ
```javascript
// æŸ¥è¯¢æŸä¸ªå°ç»„é•¿çš„è¿”ç°è®°å½•
db.collection('kanjia')
  .where({
      initiator_id: 'å°ç»„é•¿ID',
      cashback_status: 1 // åªçœ‹å·²è¿”ç°çš„
  })
  .get()
```

### Q3: å¦‚ä½•é‡æ–°è§¦å‘è¿”ç°ï¼Ÿ
```javascript
// è°ƒç”¨äº‘å‡½æ•°æ‰‹åŠ¨å¤„ç†
await articleApi.processCashback(
    'bargain_record_id', // ç ä»·è®°å½•ID
    'user_id'            // å°ç»„é•¿ID
)
```

## ä¼˜åŒ–å»ºè®®

### å·²å®Œæˆ âœ…
- [x] é›†æˆå•†å®¶è½¬è´¦APIï¼ˆV3ç‰ˆæœ¬ï¼‰
- [x] å¼‚æ­¥è¿”ç°ï¼Œä¸é˜»å¡ç ä»·å“åº”
- [x] å¤±è´¥é‡è¯•æœºåˆ¶
- [x] é˜²åˆ·æœºåˆ¶
- [x] ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆæç¤ºæ–‡æ¡ˆç»Ÿä¸€ï¼‰

### å¾…ä¼˜åŒ– ğŸ’¡
- [ ] è¿”ç°è®°å½•æŸ¥è¯¢é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰
- [ ] è¿”ç°å¤±è´¥é€šçŸ¥ï¼ˆå¾®ä¿¡æœåŠ¡é€šçŸ¥ï¼‰
- [ ] è¿”ç°ç»Ÿè®¡æŠ¥è¡¨
- [ ] æ‰¹é‡è¿”ç°å®šæ—¶ä»»åŠ¡é…ç½®

## æ€»ç»“

âœ… **å•†å®¶è½¬è´¦è¿”ç°åŠŸèƒ½å·²å®Œå…¨é›†æˆ**ï¼Œæ— éœ€é¢å¤–å¼€å‘ï¼

**æ ¸å¿ƒæµç¨‹**ï¼š
```
å¥½å‹å¸®ç  â†’ åˆ›å»ºç ä»·è®°å½• â†’ å¼‚æ­¥è§¦å‘è¿”ç° â†’ å¾®ä¿¡è½¬è´¦ â†’ é›¶é’±åˆ°è´¦
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- ğŸš€ å¼‚æ­¥å¤„ç†ï¼Œå“åº”é€Ÿåº¦å¿«
- ğŸ”’ å¤šé‡é˜²åˆ·æœºåˆ¶
- ğŸ”„ è‡ªåŠ¨å¤±è´¥é‡è¯•
- ğŸ’° å®æ—¶åˆ°è´¦ä½“éªŒ
- ğŸ“Š å®Œæ•´æ•°æ®è®°å½•

---

**æ›´æ–°æ—¶é—´**ï¼š2026-01-31  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
