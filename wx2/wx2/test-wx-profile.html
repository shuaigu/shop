<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å¾®ä¿¡ä¿¡æ¯è·å–åŠŸèƒ½</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .user-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .info-label {
            width: 120px;
            font-weight: bold;
            color: #666;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: 2px solid #ddd;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #52c41a, #389e0d);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .log {
            background-color: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .result {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ¯ æµ‹è¯•å¾®ä¿¡ä¿¡æ¯è·å–åŠŸèƒ½</h1>
        <p style="text-align: center; color: #666;">
            æ¨¡æ‹Ÿå¾®ä¿¡ç‚¹å‡»æ›´æ”¹å¤´åƒã€ç‚¹å‡»æ›´æ”¹æ˜µç§°çš„æ–¹å¼è¿›è¡Œè·å–
        </p>
        
        <div class="user-info">
            <div class="info-item">
                <span class="info-label">å½“å‰å¤´åƒï¼š</span>
                <img id="currentAvatar" src="/static/images/default.png" alt="å¤´åƒ" class="avatar">
            </div>
            <div class="info-item">
                <span class="info-label">å½“å‰æ˜µç§°ï¼š</span>
                <span id="currentNickname">æµ‹è¯•ç”¨æˆ·</span>
            </div>
            <div class="info-item">
                <span class="info-label">å¾®ä¿¡çŠ¶æ€ï¼š</span>
                <span id="wxStatus">å·²ç»‘å®šå¾®ä¿¡</span>
            </div>
        </div>
        
        <button id="testBtn" class="btn" onclick="testWxProfileUpdate()">
            ğŸ”„ æ¨¡æ‹Ÿè·å–å¾®ä¿¡ä¿¡æ¯
        </button>
        
        <button class="btn" onclick="resetUserInfo()" style="background: #f5222d;">
            ğŸ”§ é‡ç½®ç”¨æˆ·ä¿¡æ¯
        </button>
        
        <div id="result" class="result" style="display: none;"></div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        let testUserData = {
            _id: 'test_user_123',
            nickName: 'æµ‹è¯•ç”¨æˆ·',
            avatarUrl: '/static/images/default.png',
            openid_wx: 'test_openid_123',
            session_key: 'test_session_key'
        };

        // æ—¥å¿—åŠŸèƒ½
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¨¡æ‹Ÿäº‘å‡½æ•°çš„ getMockWxUserInfo æ–¹æ³•
        function getMockWxUserInfo(userData) {
            log('=== æ¨¡æ‹Ÿå¾®ä¿¡å¤´åƒæ˜µç§°å¡«å†™ç»„ä»¶æ“ä½œ ===');
            log(`å½“å‰ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(userData)}`);
            
            // æ¨¡æ‹Ÿå¾®ä¿¡å¤´åƒæ˜µç§°å¡«å†™ç»„ä»¶çš„è¡Œä¸º
            // 1. æ¨¡æ‹Ÿç‚¹å‡»å¤´åƒæ›´æ”¹æ“ä½œ
            const simulateAvatarChange = () => {
                const mockAvatars = [
                    'https://thirdwx.qlogo.cn/mmopen/avatar1.jpg',
                    'https://thirdwx.qlogo.cn/mmopen/avatar2.jpg', 
                    'https://thirdwx.qlogo.cn/mmopen/avatar3.jpg',
                    'https://wx.qlogo.cn/mmopen/mock_avatar_' + Date.now() + '.jpg'
                ];
                const randomAvatar = mockAvatars[Math.floor(Math.random() * mockAvatars.length)];
                log(`æ¨¡æ‹Ÿç‚¹å‡»å¤´åƒæ›´æ”¹æ“ä½œï¼Œæ–°å¤´åƒ: ${randomAvatar}`);
                return randomAvatar;
            };
            
            // 2. æ¨¡æ‹Ÿç‚¹å‡»æ˜µç§°æ›´æ”¹æ“ä½œ
            const simulateNicknameChange = () => {
                const mockNicknames = [
                    'å¾®ä¿¡æ˜µç§°_' + Math.random().toString(36).substr(2, 4),
                    'WXç”¨æˆ·_' + Date.now().toString().slice(-4),
                    userData.nickName && userData.nickName.includes('å¾®ä¿¡') ? userData.nickName : 'å¾®ä¿¡_' + userData.nickName,
                    'æ–°å¾®ä¿¡æ˜µç§°'
                ];
                const randomNickname = mockNicknames[Math.floor(Math.random() * mockNicknames.length)];
                log(`æ¨¡æ‹Ÿç‚¹å‡»æ˜µç§°æ›´æ”¹æ“ä½œï¼Œæ–°æ˜µç§°: ${randomNickname}`);
                return randomNickname;
            };
            
            // æ¨¡æ‹Ÿå¾®ä¿¡ç”¨æˆ·æ“ä½œè¡Œä¸º
            let mockResult = {};
            
            // å¦‚æœç”¨æˆ·å·²æœ‰å®Œæ•´ä¿¡æ¯ï¼Œæ¨¡æ‹Ÿæœ‰ä¸€å®šæ¦‚ç‡çš„æ›´æ–°
            if (userData.nickName && userData.avatarUrl) {
                log('ç”¨æˆ·å·²æœ‰å®Œæ•´ä¿¡æ¯ï¼Œæ¨¡æ‹Ÿå¯èƒ½çš„æ›´æ–°æ“ä½œ...');
                
                // 60% æ¦‚ç‡ä¿æŒåŸä¿¡æ¯ï¼ˆç”¨æˆ·æ²¡æœ‰è¿›è¡Œæ›´æ”¹æ“ä½œï¼‰
                if (Math.random() < 0.6) {
                    log('æ¨¡æ‹Ÿç»“æœï¼šç”¨æˆ·æœªè¿›è¡Œæ›´æ”¹æ“ä½œï¼Œä¿æŒåŸä¿¡æ¯');
                    mockResult = {
                        nickName: userData.nickName,
                        avatarUrl: userData.avatarUrl
                    };
                }
                // 25% æ¦‚ç‡åªæ›´æ”¹å¤´åƒ
                else if (Math.random() < 0.85) {
                    log('æ¨¡æ‹Ÿç»“æœï¼šç”¨æˆ·ç‚¹å‡»æ›´æ”¹äº†å¤´åƒ');
                    mockResult = {
                        nickName: userData.nickName,
                        avatarUrl: simulateAvatarChange()
                    };
                }
                // 10% æ¦‚ç‡åªæ›´æ”¹æ˜µç§°
                else if (Math.random() < 0.95) {
                    log('æ¨¡æ‹Ÿç»“æœï¼šç”¨æˆ·ç‚¹å‡»æ›´æ”¹äº†æ˜µç§°');
                    mockResult = {
                        nickName: simulateNicknameChange(),
                        avatarUrl: userData.avatarUrl
                    };
                }
                // 5% æ¦‚ç‡ä¸¤è€…éƒ½æ›´æ”¹
                else {
                    log('æ¨¡æ‹Ÿç»“æœï¼šç”¨æˆ·ç‚¹å‡»æ›´æ”¹äº†å¤´åƒå’Œæ˜µç§°');
                    mockResult = {
                        nickName: simulateNicknameChange(),
                        avatarUrl: simulateAvatarChange()
                    };
                }
            } else {
                // å¦‚æœç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡è®¾ç½®
                log('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ¨¡æ‹Ÿé¦–æ¬¡é€šè¿‡å¾®ä¿¡è®¾ç½®å¤´åƒæ˜µç§°...');
                mockResult = {
                    nickName: simulateNicknameChange(),
                    avatarUrl: simulateAvatarChange()
                };
            }
            
            log('=== æ¨¡æ‹Ÿå¾®ä¿¡æ“ä½œå®Œæˆ ===');
            log(`æœ€ç»ˆæ¨¡æ‹Ÿç»“æœ: ${JSON.stringify(mockResult)}`);
            return mockResult;
        }

        // æµ‹è¯•å¾®ä¿¡ä¿¡æ¯æ›´æ–°
        async function testWxProfileUpdate() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ è·å–ä¸­...';
            
            log('ğŸš€ å¼€å§‹æµ‹è¯•å¾®ä¿¡ä¿¡æ¯è·å–åŠŸèƒ½...');
            
            try {
                // æ¨¡æ‹Ÿè·å–å¾®ä¿¡ä¿¡æ¯
                const wxResult = getMockWxUserInfo(testUserData);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
                const hasUpdate = 
                    (wxResult.nickName && wxResult.nickName !== testUserData.nickName) ||
                    (wxResult.avatarUrl && wxResult.avatarUrl !== testUserData.avatarUrl);
                
                log(`æ›´æ–°æ£€æŸ¥ç»“æœ: ${hasUpdate ? 'æœ‰æ›´æ–°' : 'æ— æ›´æ–°'}`);
                
                if (hasUpdate) {
                    // æ›´æ–°æµ‹è¯•æ•°æ®
                    if (wxResult.nickName !== testUserData.nickName) {
                        log(`æ˜µç§°æ›´æ–°: ${testUserData.nickName} -> ${wxResult.nickName}`);
                        testUserData.nickName = wxResult.nickName;
                    }
                    if (wxResult.avatarUrl !== testUserData.avatarUrl) {
                        log(`å¤´åƒæ›´æ–°: ${testUserData.avatarUrl} -> ${wxResult.avatarUrl}`);
                        testUserData.avatarUrl = wxResult.avatarUrl;
                    }
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    updateUI();
                    
                    showResult('âœ… æˆåŠŸè·å–å¹¶æ›´æ–°å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯', wxResult, 'success');
                } else {
                    showResult('â„¹ï¸ å½“å‰ä¿¡æ¯å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°', wxResult, 'info');
                }
                
            } catch (error) {
                log(`âŒ è·å–å¾®ä¿¡ä¿¡æ¯å¤±è´¥: ${error.message}`);
                showResult('âŒ è·å–å¾®ä¿¡ä¿¡æ¯å¤±è´¥', { error: error.message }, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ æ¨¡æ‹Ÿè·å–å¾®ä¿¡ä¿¡æ¯';
        }

        // é‡ç½®ç”¨æˆ·ä¿¡æ¯
        function resetUserInfo() {
            testUserData = {
                _id: 'test_user_123',
                nickName: 'æµ‹è¯•ç”¨æˆ·_' + Date.now().toString().slice(-4),
                avatarUrl: '/static/images/default.png',
                openid_wx: 'test_openid_123',
                session_key: 'test_session_key'
            };
            updateUI();
            document.getElementById('result').style.display = 'none';
            log('ğŸ”§ ç”¨æˆ·ä¿¡æ¯å·²é‡ç½®');
        }

        // æ›´æ–°UIæ˜¾ç¤º
        function updateUI() {
            document.getElementById('currentNickname').textContent = testUserData.nickName;
            document.getElementById('currentAvatar').src = testUserData.avatarUrl;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(message, data, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            let bgColor, borderColor;
            switch(type) {
                case 'success':
                    bgColor = '#f6ffed';
                    borderColor = '#b7eb8f';
                    break;
                case 'error':
                    bgColor = '#fff2f0';
                    borderColor = '#ffccc7';
                    break;
                default:
                    bgColor = '#e6f7ff';
                    borderColor = '#91d5ff';
            }
            
            resultDiv.style.backgroundColor = bgColor;
            resultDiv.style.borderColor = borderColor;
            resultDiv.innerHTML = `
                <h4>${message}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        // åˆå§‹åŒ–
        log('ğŸ¯ å¾®ä¿¡ä¿¡æ¯è·å–åŠŸèƒ½æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        log('ç‚¹å‡» "æ¨¡æ‹Ÿè·å–å¾®ä¿¡ä¿¡æ¯" æŒ‰é’®å¼€å§‹æµ‹è¯•');
        updateUI();
    </script>
</body>
</html>