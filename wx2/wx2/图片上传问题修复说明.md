# 图片上传问题修复说明

## 问题描述
用户在发布内容时无法上传图片。

## 问题原因分析

经过代码分析，发现以下潜在问题：

### 1. 小程序权限配置不完整
**问题位置**: `manifest.json`

**原问题**:
- 未声明 `chooseImage` 和 `chooseMedia` 权限
- 缺少相册和相机权限的描述信息

### 2. 错误处理不完善
**问题位置**: `pages/fabu/fabu.vue` - `chooseAndUploadImage` 方法

**原问题**:
- 选择图片失败时没有明确的权限引导
- 云函数调用失败时缺少详细错误提示
- 上传失败后用户无法快速重试

### 3. mediaType 参数兼容性问题
**问题位置**: `pages/fabu/fabu.vue` - `chooseImage` 调用

**原问题**:
- `mediaType` 参数在某些平台不支持，可能导致选择失败

## 修复内容

### 1. 完善小程序权限配置

**文件**: `manifest.json`

```json
"requiredPrivateInfos" : [ 
  "getLocation", 
  "chooseAddress", 
  "chooseLocation", 
  "chooseImage",      // 新增
  "chooseMedia"       // 新增
],
"permission" : {
  "scope.userLocation" : {
    "desc" : "发布文章获取位置"
  },
  "scope.writePhotosAlbum" : {    // 新增
    "desc" : "保存图片到相册"
  },
  "scope.album" : {                // 新增
    "desc" : "选择图片用于发布内容"
  },
  "scope.camera" : {               // 新增
    "desc" : "拍照用于发布内容"
  }
}
```

### 2. 改进图片选择逻辑

**文件**: `pages/fabu/fabu.vue` - `chooseAndUploadImage` 方法

**改进点**:

1. **添加权限检查和引导**
```javascript
const chooseRes = await uni.chooseImage({
  count: 9,
  sizeType: ['original'],
  sourceType: ['album', 'camera']
  // 移除了 mediaType 参数以提高兼容性
}).catch(err => {
  console.error('选择图片失败:', err)
  
  // 检查是否是权限问题
  if (err.errMsg && err.errMsg.includes('auth')) {
    uni.showModal({
      title: '需要相册权限',
      content: '请在小程序设置中开启相册权限，以便选择图片发布',
      showCancel: true,
      confirmText: '去设置',
      success: (res) => {
        if (res.confirm) {
          uni.openSetting()  // 打开设置页面
        }
      }
    })
  } else {
    uni.showToast({
      title: '选择图片失败: ' + (err.errMsg || '未知错误'),
      icon: 'none',
      duration: 3000
    })
  }
  throw err
})
```

2. **添加调试日志**
```javascript
console.log('=== 开始选择图片 ===')
console.log('选择了', chooseRes.tempFilePaths.length, '张图片')
console.log(`开始上传第 ${newIndex + 1} 张图片`)
console.log(`图片 ${newIndex + 1} 尺寸:`, imageInfo.width, 'x', imageInfo.height)
```

3. **改进云函数调用错误处理**
```javascript
const uploadOptions = await extStorageCo.getUploadFileOptions({
  cloudPath: `images/${userStore.userInfo.uid}/${Date.now()}-${newIndex}.jpg`,
  fileType: 'image',
  isOriginal: true,
  userNickName: userStore.userInfo.nickName,
  imageWidth: imageInfo.width,
  imageHeight: imageInfo.height
}).catch(err => {
  console.error('获取上传配置失败:', err)
  uni.showToast({
    title: '云存储配置失败: ' + (err.message || '请检查网络'),
    icon: 'none',
    duration: 3000
  })
  throw err
})
```

4. **改进上传失败提示**
```javascript
fail: (err) => {
  console.error("上传失败", err);
  
  // 显示详细错误信息和重试选项
  uni.showModal({
    title: '图片上传失败',
    content: `第${newIndex + 1}张图片上传失败：${err.errMsg || '未知错误'}

请检查：
1. 网络连接是否正常
2. 图片大小是否过大
3. 云存储配置是否正常`,
    showCancel: true,
    confirmText: '重试',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        // 重试上传
        chooseAndUploadImage()
      }
    }
  })
  
  imageList.value.splice(newIndex, 1);
  reject(err);
}
```

## 使用建议

### 开发环境测试步骤

1. **重新编译小程序**
   - 修改 manifest.json 后需要重新编译
   - 在微信开发者工具中重新预览

2. **检查权限**
   - 在小程序中依次进入：我的 -> 设置 -> 权限设置
   - 确保已授予相册和相机权限

3. **清除缓存测试**
   - 清除小程序缓存数据
   - 重新登录测试上传功能

### 生产环境部署

1. **更新云函数**
   - 确保 `fabuWx` 云函数已正确部署
   - 检查七牛云存储配置是否正确

2. **提交审核**
   - 修改权限配置后需要重新提交审核
   - 在审核说明中明确权限用途

## 常见问题排查

### 问题1: 仍然无法选择图片

**可能原因**:
- 用户未授予权限
- manifest.json 未生效

**解决方案**:
```bash
1. 删除小程序
2. 重新编译
3. 重新扫码进入
4. 首次使用时会提示授权
```

### 问题2: 上传到一半失败

**可能原因**:
- 网络不稳定
- 图片过大
- 七牛云配置错误

**解决方案**:
```javascript
// 检查云函数日志
console.log('上传配置:', uploadOptions)

// 检查图片大小
const fileSize = imageInfo.size || 0
if (fileSize > 10 * 1024 * 1024) {  // 10MB
  uni.showToast({
    title: '图片过大，请选择小于10MB的图片',
    icon: 'none'
  })
  return
}
```

### 问题3: 权限弹窗不显示

**可能原因**:
- 已经永久拒绝权限
- 权限配置未生效

**解决方案**:
```javascript
// 手动检查权限
uni.getSetting({
  success: (res) => {
    console.log('当前权限状态:', res.authSetting)
    
    if (!res.authSetting['scope.album']) {
      // 未授权，引导用户
      uni.showModal({
        title: '需要相册权限',
        content: '请授权相册权限后再上传图片',
        success: (res) => {
          if (res.confirm) {
            uni.openSetting()
          }
        }
      })
    }
  }
})
```

## 测试清单

- [ ] 首次使用时是否弹出权限授权
- [ ] 拒绝权限后是否有明确提示
- [ ] 选择图片后是否正常上传
- [ ] 上传进度是否正常显示
- [ ] 上传失败后是否有详细错误提示
- [ ] 点击重试是否正常工作
- [ ] 多张图片同时上传是否正常
- [ ] 网络断开时的错误提示是否友好

## 修复总结

本次修复主要解决了：
1. ✅ 小程序权限配置不完整
2. ✅ 错误提示不明确
3. ✅ 缺少权限引导
4. ✅ 缺少重试机制
5. ✅ 调试信息不足

修复后，用户在上传图片时将获得：
- 明确的权限授权引导
- 详细的错误提示信息
- 便捷的重试操作
- 完整的调试日志

---
**修复时间**: 2025-11-01
**修复文件**: 
- `manifest.json`
- `pages/fabu/fabu.vue`
