# 构建与部署指南

<cite>
**本文档引用文件**
- [manifest.json](file://manifest.json)
- [pages.json](file://pages.json)
- [package.json](file://package.json)
- [main.js](file://main.js)
- [config.js](file://uniCloud-aliyun/cloudfunctions/userWx/config.js)
- [config.js](file://uniCloud-aliyun/cloudfunctions/wxpay/config.js)
- [config.js](file://uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-pay/config.js)
- [getOpenid/index.js](file://uniCloud-aliyun/cloudfunctions/getOpenid/index.js)
- [domainConfig.js](file://utils/domainConfig.js)
- [database](file://uniCloud-aliyun/database)
</cite>

## 目录
1. [本地开发环境搭建](#本地开发环境搭建)
2. [云函数上传与云端数据库初始化](#云函数上传与云端数据库初始化)
3. [小程序 appId 绑定与自定义组件配置](#小程序-appid-绑定与自定义组件配置)
4. [多环境构建与发布流程](#多环境构建与发布流程)
5. [常见部署问题排查清单](#常见部署问题排查清单)

## 本地开发环境搭建

### HBuilderX 安装与配置
1. 访问 DCloud 官网下载并安装最新版 HBuilderX。
2. 打开 HBuilderX，通过菜单栏【文件】→【导入】→【从本地目录导入】选择项目根目录 ``。
3. 确保已启用 Vue 3 模式，在 `manifest.json` 中 `"vueVersion": "3"` 已正确配置。

### 项目依赖还原
项目使用 pnpm 进行包管理。在项目根目录执行以下命令：
```bash
pnpm install
```
核心依赖包括：
- `uview-plus`：UI 组件库
- `pinia-plugin-persistedstate`：状态持久化插件
- `axios`：HTTP 请求库
- `sortablejs`：拖拽排序功能

### 项目结构说明
- `components/`：通用自定义组件
- `pages/`：主页面路由
- `subPages/`：子包页面（后台管理、用户信息等）
- `uniCloud-aliyun/`：阿里云 UniCloud 配置
  - `cloudfunctions/`：云函数逻辑
  - `database/`：数据库集合 schema 定义
- `uni_modules/`：UniApp 插件模块
- `store/`：Pinia 状态管理
- `utils/`：工具函数（如域名修复、时间格式化）

**Section sources**
- [package.json](file://package.json#L1-L13)
- [main.js](file://main.js#L1-L70)
- [pages.json](file://pages.json#L1-L186)

## 云函数上传与云端数据库初始化

### 云函数上传步骤
1. 在 HBuilderX 中右键点击 `uniCloud-aliyun` 目录，选择【上传所有云函数】。
2. 或单独上传特定云函数，如 `userWx`、`wxpay` 等。
3. 确保云函数运行环境为 Node.js 14+，已在 HBuilderX 项目设置中配置。

### 云端数据库初始化
1. 在 HBuilderX 中打开【uniCloud 控制台】。
2. 导入 `uniCloud-aliyun/database/` 下的所有 `.schema.json` 文件以创建数据表集合。
   - 用户表：`user.schema.json`
   - 文章表：`articleList.schema.json`
   - 支付订单：`order.schema.json`
   - 反馈记录：`feedback.schema.json`
3. 设置各集合的权限规则（读写权限），建议生产环境关闭公开读写。

### 环境变量与敏感信息配置
所有敏感信息（如 AppSecret、支付密钥）应通过云函数配置文件管理，避免硬编码：

#### 微信登录配置
```js
// uniCloud-aliyun/cloudfunctions/userWx/config.js
module.exports = {
	app_id_wx: 'wxf7ee79349bd957b8',
	app_secret_wx: '725f689abdc2c51a36330a813c1b7215'
}
```

#### 支付相关配置
```js
// uniCloud-aliyun/cloudfunctions/wxpay/config.js
const config = {
	notifyUrl: 'https://fc-mp-4f80f767-c485-40d3-b143-9134b266a903.next.bspapp.com/wxpay-notify',
	appid: 'wxf7ee79349bd957b8',
	mch_id: '1545803671',
	partner_key: 'lishuai4323811lishuai4323811lish'
}
```

#### 支付中心统一配置
```js
// uni_modules/uni-config-center/.../uni-pay/config.js
"wxpay": {
	"mp": {
		"appId": "wxf7ee79349bd957b8",
		"secret": "725f689abdc2c51a36330a813c1b7215",
		"mchId": "1545803671",
		"key": "lishuai4323811lishuai4323811lish"
	}
}
```

> **注意**：以上密钥信息仅为示例，请确保实际部署时使用正式环境密钥，并开启云函数环境变量加密保护。

**Section sources**
- [config.js](file://uniCloud-aliyun/cloudfunctions/userWx/config.js#L1-L5)
- [config.js](file://uniCloud-aliyun/cloudfunctions/wxpay/config.js#L1-L9)
- [config.js](file://uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-pay/config.js#L1-L20)
- [getOpenid/index.js](file://uniCloud-aliyun/cloudfunctions/getOpenid/index.js#L1-L37)
- [database](file://uniCloud-aliyun/database)

## 小程序 appId 绑定与自定义组件配置

### 小程序 appId 绑定
在 `manifest.json` 中配置微信小程序 appId：
```json
"mp-weixin": {
	"appid": "wxf7ee79349bd957b8",
	"setting": {
		"urlCheck": false,
		"minified": true,
		"es6": true
	},
	"requiredPrivateInfos": [ "getLocation", "chooseAddress", "chooseLocation" ],
	"permission": {
		"scope.userLocation": {
			"desc": "发布文章获取位置"
		}
	}
}
```
确保该 appId 已在微信公众平台注册并通过审核。

### 自定义组件编译设置
本项目采用 easycom 模式自动引入组件，无需手动注册：

#### 全局组件自动扫描
```json
"easycom": {
	"autoscan": true,
	"custom": {
		"^uni-(.*)": "@/uni_modules/uni-$1/components/uni-$1/uni-$1.vue",
		"^u-(.*)": "@/uni_modules/uview-plus/components/u-$1/u-$1.vue"
	}
}
```
支持直接使用 `<uni-badge />` 或 `<u-button />` 而无需 import。

#### 特殊组件路径映射
部分非 easycom 规范组件需显式声明占位符：
```json
"componentPlaceholder": {
	"uni-icons": "/uni_modules/uni-icons/components/uni-icons/uni-icons",
	"manage-popup": "/components/manage-popup/manage-popup",
	"floatButton": "/components/floatButton/floatButton"
}
```

### 页面路由与 tabBar 配置
`pages.json` 定义了主页面和子包结构：
- 主包：`pages/` 包含首页、个人中心等高频访问页
- 子包：`subPages/` 包含后台管理等功能性页面，实现按需加载

tabBar 显示“信息”和“我的”两个标签页，图标路径位于 `static/tabBar/`。

**Section sources**
- [manifest.json](file://manifest.json#L1-L74)
- [pages.json](file://pages.json#L1-L186)

## 多环境构建与发布流程

### 不同环境构建命令
HBuilderX 提供图形化构建选项，也可通过 CLI 实现自动化：

| 环境 | 构建方式 | 说明 |
|------|----------|------|
| 开发环境 | 【运行】→【微信开发者工具】 | 实时预览，启用调试日志 |
| 测试环境 | 【发行】→【小程序-微信】→ 测试版 | 使用测试专用域名或代理 |
| 生产环境 | 【发行】→【小程序-微信】→ 正式版 | 压缩代码，关闭日志输出 |

### 构建前检查清单
1. ✅ 确认 `manifest.json` 中 appId 正确
2. ✅ 检查云函数配置文件中的密钥是否为生产环境密钥
3. ✅ 验证 `domainConfig.js` 中的图片域名是否指向正式 CDN
4. ✅ 关闭不必要的 console.log 输出
5. ✅ 更新版本号（versionName 和 versionCode）

### 发布流程
1. 在 HBuilderX 中完成最终构建。
2. 使用微信开发者工具打开生成的小程序代码目录。
3. 点击【上传】按钮，填写版本号和备注。
4. 登录微信公众平台，进入【版本管理】提交审核。
5. 审核通过后进行分阶段发布或全量发布。

**Section sources**
- [manifest.json](file://manifest.json#L1-L74)
- [domainConfig.js](file://utils/domainConfig.js#L1-L122)

## 常见部署问题排查清单

### 云函数超时（504 错误）
**现象**：调用云函数返回 `504 Gateway Timeout`  
**解决方案**：
1. 检查网络连接是否正常。
2. 查看云函数日志是否有死循环或阻塞操作。
3. 优化数据库查询，添加索引（如 `user.openid`）。
4. 分批处理大数据量任务，避免单次执行超过 5 秒。

### 数据库连接失败
**现象**：`uniCloud.database()` 报错或无法查询  
**解决方案**：
1. 确认 `uniCloud-aliyun` 是否已正确关联云端环境。
2. 检查集合名称拼写是否与 schema 文件一致。
3. 查看数据库权限策略是否允许当前用户读写。
4. 使用 `try-catch` 包裹数据库操作并打印错误详情。

### 图片加载失败或 400 错误
**原因分析**：URL 含有无效压缩参数导致七牛云拒绝服务  
**解决方案**：
使用 `fixImageUrl` 工具函数自动修复：
```js
import { fixImageUrl } from '@/utils/domainConfig'

const imgUrl = 'http://jingle350.cn/upload/image.jpg?imageMogr2/quality/80'
const fixedUrl = fixImageUrl(imgUrl) // 输出：http://jingle0350.cn/upload/image.jpg
```
该函数会自动替换错误域名并移除 `?imageMogr2` 类参数。

### 获取 OpenID 失败
**现象**：调用 `getOpenid` 返回错误码  
**排查步骤**：
1. 确认 `appid` 和 `appSecret` 正确无误。
2. 检查微信小程序是否被封禁或未上线。
3. 查看云函数日志中 HTTP 请求返回的具体 errcode。
4. 确保 `code` 参数由前端正确传递。

### 支付回调通知失败
**现象**：微信支付成功但未收到服务器通知  
**解决方案**：
1. 确认 `wxpay/config.js` 中 `notifyUrl` 可公网访问。
2. 检查 HTTPS 证书有效性。
3. 在云函数 `wxpay-notify` 中添加日志记录请求体。
4. 使用微信支付商户平台【API 调试工具】模拟通知。

**Section sources**
- [getOpenid/index.js](file://uniCloud-aliyun/cloudfunctions/getOpenid/index.js#L1-L37)
- [domainConfig.js](file://utils/domainConfig.js#L1-L122)
- [config.js](file://uniCloud-aliyun/cloudfunctions/wxpay/config.js#L1-L9)