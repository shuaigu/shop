# 文件上传流程

<cite>
**本文档引用文件**  
- [fabu.vue](file://pages/fabu/fabu.vue)
- [imageService/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/index.obj.js)
- [imageService/fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/fabuWx/index.obj.js)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js)
- [qiniuyun.vue](file://subPages/qiniuyun/qiniuyun.vue)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件分析](#核心组件分析)
3. [上传凭证生成机制](#上传凭证生成机制)
4. [前端直传流程](#前端直传流程)
5. [图文/视频发布协作流程](#图文视频发布协作流程)
6. [序列图：全链路上传时序](#序列图全链路上传时序)
7. [高级特性实现建议](#高级特性实现建议)
8. [异常处理与重试机制](#异常处理与重试机制)

## 简介
本文深入解析从客户端发起至七牛云完成上传的全链路流程。重点描述`imageService`云函数如何生成上传token与签名，`fabuWx`云函数在图文/视频发布时调用上传服务的协作关系。说明前端直传模式下的凭证获取、表单构建、进度监听及成功回调处理机制。结合序列图展示各环节时序关系，并提供异常中断重试、大文件分片上传等高级特性的实现建议。

## 核心组件分析

### imageService 云函数
负责生成封面图片和处理图像相关操作的核心服务。通过Canvas API动态绘制用户头像、昵称和文章图片，生成高质量封面图并上传至云存储。

**Section sources**
- [imageService/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/index.obj.js#L1-L194)

### fabuWx 云函数
处理图文/视频发布的主逻辑，包括分类管理、位置信息处理、媒体文件上传配置生成等功能。协调前端与云存储之间的交互流程。

**Section sources**
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L1-L710)

### 前端发布页面 (fabu.vue)
实现用户界面交互，包含内容输入、媒体选择、分类选择、位置获取等完整发布功能模块。

**Section sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L1-L3113)

## 上传凭证生成机制

### 图片上传配置生成
`getUploadFileOptions`方法根据文件类型生成相应的上传配置参数：

```mermaid
flowchart TD
Start([开始]) --> CheckFileType["检查文件类型"]
CheckFileType --> |图片| ProcessImage["处理图片类型"]
CheckFileType --> |视频| ProcessVideo["处理视频类型"]
ProcessImage --> GeneratePath["生成云存储路径"]
GeneratePath --> GetExtManager["获取extStorageManager实例"]
GetExtManager --> SetOps["设置持久化处理参数"]
SetOps --> ReturnConfig["返回上传配置"]
ProcessVideo --> GeneratePath
```

**Diagram sources**
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L100-L200)

### 水印参数动态调整
根据图片形状自动调整水印大小和位置：

```mermaid
flowchart TD
Start([开始]) --> GetDimensions["获取图片宽高"]
GetDimensions --> CalculateRatio["计算宽高比"]
CalculateRatio --> CheckRatio{"宽高比判断"}
CheckRatio --> |竖图 ratio < 0.8| SmallWatermark["使用较小水印"]
CheckRatio --> |横图 ratio > 1.2| LargeWatermark["使用较大水印"]
CheckRatio --> |正方形 0.8≤ratio≤1.2| MediumWatermark["使用中等水印"]
SmallWatermark --> ApplyParams["应用水印参数"]
LargeWatermark --> ApplyParams
MediumWatermark --> ApplyParams
ApplyParams --> End([结束])
```

**Diagram sources**
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L50-L100)

## 前端直传流程

### 凭证获取与表单构建
前端通过调用云函数获取上传所需的安全凭证和配置信息：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant CloudFunc as "云函数"
participant Qiniu as "七牛云"
Client->>CloudFunc : 调用getUploadFileOptions()
CloudFunc->>CloudFunc : 验证文件类型
CloudFunc->>CloudFunc : 生成云存储路径
CloudFunc->>CloudFunc : 构建持久化处理参数
CloudFunc-->>Client : 返回上传配置
Client->>Qiniu : 使用配置发起上传
Qiniu-->>Client : 返回上传结果
```

**Diagram sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L500-L600)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L80-L150)

### 进度监听与状态更新
实现上传进度的实时监控和UI反馈：

```mermaid
flowchart TD
Start([选择文件]) --> InitUpload["初始化上传任务"]
InitUpload --> CreateTask["创建uploadTask"]
CreateTask --> ListenProgress["监听onProgressUpdate事件"]
ListenProgress --> UpdateUI["更新进度条显示"]
UpdateUI --> CheckStatus{"上传完成？"}
CheckStatus --> |否| Continue["继续监听"]
CheckStatus --> |是| HandleResult["处理上传结果"]
HandleResult --> |成功| ShowSuccess["显示成功提示"]
HandleResult --> |失败| ShowError["显示错误信息"]
ShowSuccess --> End([完成])
ShowError --> End
```

**Diagram sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L520-L550)

## 图文视频发布协作流程

### 分类与位置信息处理
系统根据用户位置自动创建或匹配相应分类：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant ArticleAPI as "articleWx"
participant FabuCo as "fabuWx"
Client->>ArticleAPI : 获取位置信息
ArticleAPI-->>Client : 返回地址和区域
Client->>FabuCo : 调用processCategoryFromDistrict()
FabuCo->>FabuCo : 清理区域名称
FabuCo->>FabuCo : 查询是否存在同名分类
FabuCo-->>Client : 返回分类信息
Client->>Client : 更新UI显示
```

**Diagram sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L200-L300)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L300-L400)

### 封面图生成流程
利用Canvas技术动态生成文章封面：

```mermaid
flowchart TD
Start([开始]) --> CreateCanvas["创建Canvas实例"]
CreateCanvas --> DrawBackground["绘制背景色"]
DrawBackground --> LoadAvatar["加载用户头像"]
LoadAvatar --> ClipCircle["创建圆形裁剪路径"]
ClipCircle --> DrawAvatar["绘制头像"]
DrawAvatar --> WriteNickname["写入用户昵称"]
WriteNickname --> LoadArticleImages["加载文章图片"]
LoadArticleImages --> DrawImages["绘制图片缩略图"]
DrawImages --> AddWatermark["添加水印文字"]
AddWatermark --> ConvertBuffer["转换为图片Buffer"]
ConvertBuffer --> SaveTemp["保存到临时文件"]
SaveTemp --> UploadToCloud["上传至云存储"]
UploadToCloud --> DeleteTemp["删除临时文件"]
DeleteTemp --> ReturnFileID["返回文件ID"]
ReturnFileID --> End([结束])
```

**Diagram sources**
- [imageService/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/index.obj.js#L20-L190)

## 序列图全链路上传时序

```mermaid
sequenceDiagram
participant User as "用户"
participant Frontend as "前端(fabu.vue)"
participant ImageService as "imageService云函数"
participant FabuWx as "fabuWx云函数"
participant Qiniu as "七牛云"
User->>Frontend : 选择图片/视频
Frontend->>FabuWx : 调用getUploadFileOptions()
FabuWx->>FabuWx : 验证文件类型
FabuWx->>FabuWx : 生成云存储路径
FabuWx->>FabuWx : 构建处理参数
FabuWx-->>Frontend : 返回上传配置
Frontend->>Qiniu : 发起上传请求
Qiniu-->>Frontend : 返回上传结果
Frontend->>ImageService : 请求生成封面图
ImageService->>ImageService : 绘制封面内容
ImageService->>ImageService : 上传封面至云存储
ImageService-->>Frontend : 返回封面文件ID
Frontend->>User : 显示上传成功
```

**Diagram sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L1-L3113)
- [imageService/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/index.obj.js#L1-L194)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L1-L710)

## 高级特性实现建议

### 大文件分片上传
对于超过100MB的视频文件，建议采用分片上传策略：

```mermaid
flowchart TD
Start([开始]) --> CheckFileSize["检查文件大小"]
CheckFileSize --> |大于100MB| UseChunkUpload["启用分片上传"]
CheckFileSize --> |小于等于100MB| DirectUpload["直接上传"]
UseChunkUpload --> SplitFile["将文件分割成多个块"]
SplitFile --> UploadChunks["逐个上传分片"]
UploadChunks --> VerifyUpload["验证所有分片上传完成"]
VerifyUpload --> CombineChunks["在服务器端合并分片"]
CombineChunks --> GenerateFinalURL["生成最终文件URL"]
GenerateFinalURL --> End([完成])
DirectUpload --> StandardUpload["标准上传流程"]
StandardUpload --> End
```

### 断点续传机制
实现上传中断后的恢复功能：

```mermaid
flowchart TD
Start([开始]) --> CheckResume["检查是否有未完成上传"]
CheckResume --> |有记录| ResumeUpload["继续上次上传"]
CheckResume --> |无记录| NewUpload["新建上传任务"]
ResumeUpload --> GetUploadedChunks["获取已上传分片列表"]
GetUploadedChunks --> UploadRemaining["上传剩余分片"]
UploadRemaining --> CompleteUpload["完成上传"]
NewUpload --> InitNewTask["初始化新任务"]
InitNewTask --> UploadAllChunks["上传所有分片"]
UploadAllChunks --> CompleteUpload
CompleteUpload --> ClearRecord["清除上传记录"]
ClearRecord --> End([完成])
```

## 异常处理与重试机制

### 错误类型与处理策略
建立完善的错误分类和应对方案：

```mermaid
flowchart TD
Start([发生错误]) --> IdentifyError["识别错误类型"]
IdentifyError --> |网络错误| NetworkError["网络连接问题"]
IdentifyError --> |认证错误| AuthError["凭证无效"]
IdentifyError --> |文件错误| FileError["文件格式不支持"]
IdentifyError --> |服务器错误| ServerError["服务端异常"]
NetworkError --> RetryWithDelay["延迟后重试(最多3次)"]
AuthError --> RefreshToken["刷新凭证后重试"]
FileError --> NotifyUser["通知用户并终止"]
ServerError --> WaitAndRetry["等待后重试(最多2次)"]
RetryWithDelay --> CheckSuccess{"重试成功？"}
RefreshToken --> CheckSuccess
WaitAndRetry --> CheckSuccess
CheckSuccess --> |是| SuccessFlow["继续正常流程"]
CheckSuccess --> |否| FinalFail["标记为失败并记录日志"]
SuccessFlow --> End([完成])
FinalFail --> End
```

**Section sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L520-L580)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L600-L700)