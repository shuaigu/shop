# 第三方服务集成

<cite>
**本文档引用的文件**
- [domainConfig.js](file://utils/domainConfig.js)
- [qiniuyun.vue](file://subPages/qiniuyun/qiniuyun.vue)
- [imageService/fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/fabuWx/index.obj.js)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js)
- [wxpay/config.js](file://uniCloud-aliyun/cloudfunctions/wxpay/config.js)
- [uni-config-center/uni-pay/config.js](file://uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-pay/config.js)
- [wxpay-notify/config.json](file://uniCloud-aliyun/cloudfunctions/wxpay-notify/config.json)
- [wxpay.js](file://uni_modules/uni-pay/uniCloud/cloudfunctions/uni-pay-co/libs/wxpay.js)
</cite>

## 目录
1. [七牛云对象存储集成](#七牛云对象存储集成)
2. [微信支付系统对接](#微信支付系统对接)
3. [高德地图API应用](#高德地图api应用)
4. [外部服务端点统一管理](#外部服务端点统一管理)

## 七牛云对象存储集成

项目通过 `uniCloud.getExtStorageManager` 接口与七牛云进行集成，实现图片和视频的上传、处理与分发。上传凭证由云函数 `qiniuCloud.generateUploadToken` 动态生成，确保安全性。

上传时，系统根据文件类型（图片或视频）自动选择不同的处理策略。对于图片，会生成原图、压缩图和缩略图三种版本，并通过 `persistentOps` 参数配置七牛云的持久化处理任务。文件路径遵循 `{年}/{媒体类型}/{年月日}/{时间戳_随机字符}.{扩展名}` 的规则，如 `2025/tupian/20250405/1743823456789_abc123.jpg`，保证了文件的唯一性和可追溯性。

CDN加速通过指定 `domain: "https://aly22.jingle0350.cn"` 实现，所有从七牛云获取的资源均通过此域名访问，提升加载速度。在上传过程中，代码强制使用 HTTPS 协议，确保传输安全。

**Section sources**
- [qiniuyun.vue](file://subPages/qiniuyun/qiniuyun.vue#L731-L896)
- [imageService/fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/imageService/fabuWx/index.obj.js#L156-L301)
- [fabuWx/index.obj.js](file://uniCloud-aliyun/cloudfunctions/fabuWx/index.obj.js#L369-L449)

## 微信支付系统对接

微信支付的对接主要依赖于 `uni-pay` 模块。商户号 (`mch_id`) 和 API 密钥 (`partner_key`) 在 `uniCloud-aliyun/cloudfunctions/wxpay/config.js` 文件中进行配置，同时在 `uni-config-center` 的 `uni-pay/config.js` 中也进行了冗余配置以确保可靠性。

支付回调地址通过 `config.json` 文件中的 `httpTrigger.path` 定义为 `/wxpay-notify`，并映射到具体的公网 URL `https://fc-mp-.../wxpay-notify`。该地址是支付结果异步通知的入口，必须在微信商户平台精确配置。

安全性保障措施包括：
1.  **API密钥保护**：API密钥不暴露在前端代码中，仅存在于云端配置。
2.  **证书认证**：使用 `.pfx` 格式的客户端证书进行双向认证，增强通信安全。
3.  **动态获取OpenID**：通过调用 `wxpay._getMpOpenid` 方法，使用小程序的 `appId` 和 `secret` 向微信服务器换取用户的 `openid`，避免敏感信息在客户端传递。

**Section sources**
- [wxpay/config.js](file://uniCloud-aliyun/cloudfunctions/wxpay/config.js#L0-L8)
- [uni-config-center/uni-pay/config.js](file://uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-pay/config.js#L0-L19)
- [wxpay-notify/config.json](file://uniCloud-aliyun/cloudfunctions/wxpay-notify/config.json#L0-L5)
- [wxpay.js](file://uni_modules/uni-pay/uniCloud/cloudfunctions/uni-pay-co/libs/wxpay.js#L3-L112)

## 高德地图API应用

项目利用高德地图API进行地理位置解析。当用户发布内容时，前端通过 `uni.getLocation` 获取其 GPS 坐标（GCJ-02 坐标系）。这些坐标随后被发送至后端云函数 `articleApi.addReady`。

后端服务接收到坐标后，调用高德地图的逆地理编码接口，将经纬度转换为人类可读的详细地址信息，包括省、市、区、街道等。解析后的地址信息用于：
1.  **展示位置**：在发布页面显示“当前位置：北京市朝阳区”。
2.  **创建位置分类**：根据区域名称（如“朝阳区”）自动生成一个带有独特背景色图标的位置分类，提升本地化内容的组织效率。

**Section sources**
- [fabu.vue](file://pages/fabu/fabu.vue#L130-L383)
- [index.vue](file://pages/index/index.vue#L609-L658)

## 外部服务端点统一管理

所有外部服务的域名和配置都通过 `utils/domainConfig.js` 进行集中管理。该文件定义了一个 `domainConfig` 对象，包含以下关键部分：

*   **域名映射表 (domainMap)**：用于修复历史遗留的错误域名，例如将 `jingle350.cn` 自动重定向到正确的 `jingle0350.cn`。
*   **主域名 (correctDomain)**：当前正在使用的正确域名 `aly22.jingle0350.cn`，更换CDN或服务商时只需修改此处。
*   **默认图片路径 (defaultImages)**：为头像、视频等提供默认占位图。
*   **图片参数 (imageParams)**：预设了缩略图、压缩和WebP格式的URL参数。

通过 `fixImageUrl` 和 `addImageParams` 等导出函数，前端可以方便地对图片URL进行修复和优化，实现了对外部服务端点的统一、便捷管理。

**Section sources**
- [domainConfig.js](file://utils/domainConfig.js#L0-L121)