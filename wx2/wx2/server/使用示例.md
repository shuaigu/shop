# 固定 IP 代理服务使用示例

## 一、在云函数中使用代理

### 1. 砍价返现（使用代理）

在 `articleWx` 云对象中使用：

```javascript
// 导入砍价返现处理类
const CashbackHandlerV3 = require('./cashback-handler-v3.js');

// 创建实例时启用代理
const cashbackHandler = new CashbackHandlerV3(
    true,  // 启用代理
    {      // 代理配置（可选，默认使用 115.159.35.33:8888）
        host: '115.159.35.33',
        port: 8888,
        protocol: 'http'
    }
);

// 处理返现
const result = await cashbackHandler.processCashback({
    bargain_record_id: 'xxx',
    user_id: 'user123',
    openid: 'oXXXXXXXXXXXXXXXXXXXXX',
    amount: 1.50,  // 元
    desc: '砍价返现',
    user_name: '张三'  // 可选
});
```

### 2. 不使用代理（直连）

如果微信支付已经支持 uniCloud 的动态 IP，可以不使用代理：

```javascript
// 不使用代理
const cashbackHandler = new CashbackHandlerV3(false);

// 或者直接使用默认构造函数
const cashbackHandler = new CashbackHandlerV3();
```

## 二、在 articleWx 云对象中集成

### 修改 index.obj.js

```javascript
// 在 articleWx/index.obj.js 中添加

module.exports = {
    // ... 其他代码 ...
    
    /**
     * 处理砍价返现（使用固定 IP 代理）
     * @param {Object} params 返现参数
     */
    async processCashbackWithProxy(params) {
        const CashbackHandlerV3 = require('./cashback-handler-v3.js');
        
        // 创建实例，启用代理
        const cashbackHandler = new CashbackHandlerV3(true, {
            host: '115.159.35.33',
            port: 8888,
            protocol: 'http'
        });
        
        return await cashbackHandler.processCashback(params);
    },
    
    /**
     * 批量处理待返现记录（使用固定 IP 代理）
     */
    async processPendingCashbacksWithProxy() {
        const CashbackHandlerV3 = require('./cashback-handler-v3.js');
        
        const cashbackHandler = new CashbackHandlerV3(true);
        
        return await cashbackHandler.processPendingCashbacks();
    },
    
    /**
     * 测试代理连接
     */
    async testProxyConnection() {
        try {
            const proxyUrl = 'http://115.159.35.33:8888/health';
            const result = await uniCloud.httpclient.request(proxyUrl, {
                method: 'GET',
                dataType: 'json'
            });
            
            return {
                success: true,
                message: '代理服务器连接正常',
                data: result.data
            };
        } catch (err) {
            return {
                success: false,
                message: '代理服务器连接失败: ' + err.message
            };
        }
    },
    
    /**
     * 获取代理服务器 IP
     */
    async getProxyIP() {
        try {
            const result = await uniCloud.httpclient.request('http://115.159.35.33:8888/ip', {
                method: 'GET',
                dataType: 'json'
            });
            
            return {
                success: true,
                ip: result.data.ip,
                message: '请将此 IP 添加到微信支付白名单'
            };
        } catch (err) {
            return {
                success: false,
                message: '获取 IP 失败: ' + err.message
            };
        }
    }
}
```

## 三、前端调用示例

### 1. 测试代理连接

```vue
<template>
    <view>
        <button @click="testProxy">测试代理服务器</button>
        <button @click="getProxyIP">获取代理 IP</button>
        <button @click="processCashback">发起返现</button>
    </view>
</template>

<script setup>
import { ref } from 'vue';

// 测试代理连接
const testProxy = async () => {
    try {
        uni.showLoading({ title: '测试中...' });
        
        const api = uniCloud.importObject('articleWx');
        const result = await api.testProxyConnection();
        
        uni.hideLoading();
        
        if (result.success) {
            uni.showToast({
                title: '代理服务器正常',
                icon: 'success'
            });
        } else {
            uni.showToast({
                title: result.message,
                icon: 'none'
            });
        }
    } catch (err) {
        uni.hideLoading();
        uni.showToast({
            title: '测试失败: ' + err.message,
            icon: 'none'
        });
    }
};

// 获取代理 IP
const getProxyIP = async () => {
    try {
        uni.showLoading({ title: '获取中...' });
        
        const api = uniCloud.importObject('articleWx');
        const result = await api.getProxyIP();
        
        uni.hideLoading();
        
        if (result.success) {
            // 复制 IP 到剪贴板
            uni.setClipboardData({
                data: result.ip,
                success: () => {
                    uni.showModal({
                        title: '代理服务器 IP',
                        content: `IP: ${result.ip}

已复制到剪贴板

${result.message}`,
                        showCancel: false
                    });
                }
            });
        } else {
            uni.showToast({
                title: result.message,
                icon: 'none'
            });
        }
    } catch (err) {
        uni.hideLoading();
        uni.showToast({
            title: '获取失败: ' + err.message,
            icon: 'none'
        });
    }
};

// 发起返现
const processCashback = async () => {
    try {
        uni.showLoading({ title: '处理中...' });
        
        const api = uniCloud.importObject('articleWx');
        const result = await api.processCashbackWithProxy({
            bargain_record_id: 'xxx',
            user_id: 'user123',
            openid: 'oXXXXXXXXXXXXXXXXXXXXX',
            amount: 1.50,
            desc: '砍价返现'
        });
        
        uni.hideLoading();
        
        if (result.success) {
            uni.showModal({
                title: '返现成功',
                content: `返现金额: ¥${result.amount}\n订单号: ${result.out_detail_no}`,
                showCancel: false
            });
        } else {
            uni.showToast({
                title: result.message,
                icon: 'none'
            });
        }
    } catch (err) {
        uni.hideLoading();
        uni.showToast({
            title: '返现失败: ' + err.message,
            icon: 'none'
        });
    }
};
</script>
```

## 四、环境变量配置（推荐）

为了方便在不同环境切换，建议使用环境变量：

### 1. 创建配置文件

在 `articleWx` 目录下创建 `proxy-config.js`：

```javascript
// articleWx/proxy-config.js

// 代理配置
module.exports = {
    // 是否启用代理（生产环境启用，开发环境可以关闭）
    enabled: true,
    
    // 代理服务器配置
    host: '115.159.35.33',
    port: 8888,
    protocol: 'http',
    
    // 获取配置的便捷方法
    getConfig() {
        return {
            enabled: this.enabled,
            host: this.host,
            port: this.port,
            protocol: this.protocol
        };
    },
    
    // 获取代理 URL
    getProxyUrl() {
        return `${this.protocol}://${this.host}:${this.port}`;
    }
};
```

### 2. 在代码中使用

```javascript
const CashbackHandlerV3 = require('./cashback-handler-v3.js');
const proxyConfig = require('./proxy-config.js');

// 使用配置文件
const cashbackHandler = new CashbackHandlerV3(
    proxyConfig.enabled,
    proxyConfig.getConfig()
);
```

## 五、监控和日志

### 1. 查看代理服务器日志

```bash
# 在服务器上查看实时日志
pm2 logs unicloud-proxy

# 查看最近 100 行日志
pm2 logs unicloud-proxy --lines 100

# 只看错误日志
pm2 logs unicloud-proxy --err
```

### 2. 云函数日志

在 uniCloud Web 控制台查看云函数日志，搜索关键字：
- `通过代理服务器发送请求`
- `代理请求成功`
- `代理请求失败`

## 六、故障切换

如果代理服务器出现问题，可以快速切换回直连模式：

```javascript
// 方法1：修改配置文件
// proxy-config.js
module.exports = {
    enabled: false,  // 关闭代理
    // ... 其他配置
};

// 方法2：在代码中判断
try {
    // 先尝试使用代理
    const cashbackHandler = new CashbackHandlerV3(true);
    const result = await cashbackHandler.processCashback(params);
} catch (err) {
    console.error('代理请求失败，切换到直连模式:', err);
    // 切换到直连模式
    const cashbackHandler = new CashbackHandlerV3(false);
    const result = await cashbackHandler.processCashback(params);
}
```

## 七、性能优化

### 1. 连接池（代理服务器端）

在 `proxy-server.js` 中配置连接池：

```javascript
const axios = require('axios');

// 配置 axios 连接池
axios.defaults.httpAgent = new require('http').Agent({
    keepAlive: true,
    maxSockets: 100
});

axios.defaults.httpsAgent = new require('https').Agent({
    keepAlive: true,
    maxSockets: 100
});
```

### 2. 请求缓存（可选）

对于重复的查询请求，可以添加缓存：

```javascript
const NodeCache = require('node-cache');
const cache = new NodeCache({ stdTTL: 60 }); // 60秒过期

app.post('/proxy', async (req, res) => {
    const cacheKey = `${req.body.target_method}:${req.body.target_url}`;
    
    // 只缓存 GET 请求
    if (req.body.target_method === 'GET') {
        const cached = cache.get(cacheKey);
        if (cached) {
            return res.json(cached);
        }
    }
    
    // ... 发送请求 ...
    
    // 缓存结果
    if (req.body.target_method === 'GET') {
        cache.set(cacheKey, result);
    }
    
    res.json(result);
});
```

## 八、安全建议

### 1. 添加 API 密钥认证

修改代理服务器，添加认证：

```javascript
// proxy-server.js
const API_KEY = 'your-secret-key-here';

app.use('/proxy', (req, res, next) => {
    const authHeader = req.headers['x-api-key'];
    
    if (authHeader !== API_KEY) {
        return res.status(401).json({
            success: false,
            error: '未授权访问'
        });
    }
    
    next();
});
```

云函数中使用：

```javascript
const result = await uniCloud.httpclient.request(proxyUrl, {
    method: 'POST',
    data: proxyRequestData,
    headers: {
        'Content-Type': 'application/json',
        'X-API-Key': 'your-secret-key-here'
    }
});
```

### 2. IP 白名单

只允许 uniCloud 的 IP 访问代理服务器（在服务器防火墙中配置）。

## 九、测试清单

在正式使用前，请完成以下测试：

- [ ] 代理服务器健康检查
- [ ] 获取代理服务器 IP
- [ ] 测试代理转发功能
- [ ] 测试微信支付 API 连通性
- [ ] 确认 IP 已添加到微信支付白名单
- [ ] 发起一笔小额测试返现（0.1元）
- [ ] 查看云函数日志确认请求成功
- [ ] 查看代理服务器日志确认转发正常

## 十、常见问题

### Q1: 代理服务器无法访问
A: 检查服务器防火墙是否开放 8888 端口，检查 PM2 进程是否正常运行。

### Q2: 微信支付返回"IP未在白名单"
A: 确认已将 115.159.35.33 添加到白名单，等待 5-10 分钟生效。

### Q3: 代理转发超时
A: 检查服务器网络是否正常，检查目标 API 是否可访问。

### Q4: 性能下降
A: 代理会增加一定延迟（通常 <100ms），如果延迟过高，检查服务器带宽和负载。

## 十一、联系支持

如遇到问题：
1. 查看代理服务器日志
2. 查看云函数日志
3. 使用测试工具验证代理功能
4. 检查网络连通性
