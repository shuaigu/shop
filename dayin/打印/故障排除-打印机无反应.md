# 故障排除：打印机没反应

## 🔍 问题确认

您遇到的是**API 404错误**，这表明使用了不存在的API端点。

### 错误信息
```
POST https://cloud.liankenet.com/api/print/text 404
404 Not Found
```

## ✅ 已修复

我已经修复了首页"快速打印"功能的问题：

### 修改内容
- ❌ **旧代码**：使用 `printApi.printText()` 调用 `/api/print/text` 接口（不存在）
- ✅ **新代码**：使用 `printApi.submitPrintTask()` 调用 `/v3/print/submitTask` 接口（V3 API）

### 修改文件
- `pages/index/index.vue` - `testPrint()` 方法

## 🚀 现在请重新测试

### 步骤1：重新编译（重要！）
```
微信开发者工具 → 点击「编译」按钮
或按快捷键 Ctrl+B
```

### 步骤2：清空Console
```
开发者工具 → Console → 点击清空按钮（🚫图标）
```

### 步骤3：重新测试打印
```
小程序首页 → 点击「🖨️ 快速打印」
→ 确认 → 查看Console日志
```

### 步骤4：检查结果

**成功标志**：
- ✅ Console显示：`API请求(Token): /v3/print/submitTask`
- ✅ 返回状态码：200
- ✅ 返回任务ID：`task_id: "xxx"`
- ✅ 显示对话框：「测试打印已提交」

**如果仍然失败**：
- 检查打印机配置（必须有password和driverName）
- 查看Console的完整错误信息
- 按照下面的详细排查步骤

## 📋 详细排查步骤

### 1️⃣ 检查打印机配置

在Console执行：
```javascript
const printer = uni.getStorageSync('selectedPrinter')
console.log('打印机信息:', printer)
```

**必须包含这些字段**：
```javascript
{
  id: "lc01cc05708199",           // ✅ 设备ID
  password: "XnoyolfCxRRxQThh",   // ✅ 设备密码（不是secret）
  model: "LP-N110W_D2",           // ✅ 打印机型号
  driverName: "LP-N110W_D2",      // ✅ 驱动名称
  name: "测试云盒...",             // ✅ 显示名称
  status: "online"                // ✅ 状态
}
```

**如果缺少字段**：
1. 删除当前打印机
2. 重新添加（使用快速填充）
3. 确认所有字段都有值

### 2️⃣ 检查API请求

查看Console日志，找到：

**正确的请求**：
```javascript
API请求(Token): {
  url: "https://cloud.liankenet.com/v3/print/submitTask",
  method: "POST",
  data: {
    deviceId: "lc01cc05708199",
    devicePassword: "XnoyolfCxRRxQThh",
    printerName: "LP-N110W_D2",
    driverName: "LP-N110W_D2",
    jobFileUrl: "https://...",
    dmPaperSize: 9,
    dmOrientation: 1,
    dmColor: 1,
    dmDuplex: 1,
    dmCopies: 1,
    isPreview: 1
  },
  headers: {
    "Content-Type": "application/json",
    "Authorization": "Basic xxx"
  }
}
```

**错误的请求**：
```javascript
// ❌ 如果看到这个URL，说明还在用旧代码
url: "https://cloud.liankenet.com/api/print/text"
```

### 3️⃣ 检查API响应

**成功响应**：
```javascript
API响应: {
  statusCode: 200,
  data: {
    code: 200,
    msg: "success",
    data: {
      task_id: "20260127xxxxx"
    }
  }
}
```

**失败响应**：
```javascript
// 404 - API端点不存在
statusCode: 404

// 401 - 认证失败
statusCode: 401

// 400 - 参数错误
statusCode: 400, 
data: { code: 400, msg: "缺少必需参数" }
```

### 4️⃣ 检查网络连接

1. **测试网络**：
   ```
   测试页面 → 🖨️ 获取打印机列表
   ```
   - 如果能获取到列表，说明网络正常
   - 如果失败，检查网络或域名配置

2. **检查域名配置**：
   ```
   manifest.json → mp-weixin → "mp-weixin": {
     "setting": {
       "urlCheck": false  // 开发阶段关闭URL校验
     }
   }
   ```

3. **检查服务器域名**（正式环境）：
   ```
   微信小程序管理后台 → 开发 → 开发设置 → 服务器域名
   request合法域名: https://cloud.liankenet.com
   uploadFile合法域名: https://cloud.liankenet.com
   ```

### 5️⃣ 检查云盒和打印机状态

1. **登录管理后台**：
   - 访问：https://open.liankenet.com
   - 查看设备列表
   - 确认云盒显示「在线」

2. **检查打印机连接**：
   - 云盒管理页面 → 打印机列表
   - 确认打印机显示「就绪」
   - 确认打印机型号和驱动正确

3. **检查USB连接**：
   - 打印机USB线连接牢固
   - 打印机电源已开启
   - 云盒程序正在运行

## 🔄 推荐测试流程

### 完整测试流程（推荐）

1. **清空数据**：
   ```javascript
   uni.clearStorageSync()  // 清空所有本地数据
   ```

2. **重新编译**：
   ```
   微信开发者工具 → 编译
   ```

3. **添加打印机**：
   ```
   首页 → 当前打印机 → + 添加打印机 
   → ⚡ 快速填充测试设备 → 确定
   ```

4. **连接测试**：
   ```
   首页 → 🔌 连接测试 → 🚀 开始测试
   ```
   - 查看三步是否都成功
   - 记录任务ID

5. **查询任务**：
   ```
   测试页面 → 查询任务状态
   ```
   - 查看任务状态
   - 确认是否成功

6. **正式打印**：
   ```
   打印页面 → 文档 → 文件URL
   → 输入测试URL → 开始打印
   ```

### 快速测试流程（仅测试API）

如果只想快速验证API是否正常：

1. 编译项目
2. 点击「连接测试」
3. 查看Console日志
4. 确认API请求使用的是 `/v3/print/submitTask`

## ⚠️ 常见问题

### Q1: 重新编译后仍然报404错误

**可能原因**：
- 浏览器缓存
- 代码未保存
- 未重新编译

**解决方法**：
1. 保存所有文件（Ctrl+S）
2. 重新编译（Ctrl+B）
3. 如果还不行，关闭开发者工具重新打开

### Q2: 提示"打印机缺少密码配置"

**原因**：打印机信息中没有 `password` 字段

**解决**：
1. 删除打印机
2. 使用「快速填充」重新添加
3. 确认password字段有值

### Q3: 任务提交成功但打印机无动作

**可能原因**：
- 云盒离线
- 打印机未连接
- 任务在队列中等待

**解决**：
1. 查询任务状态
2. 检查云盒和打印机状态
3. 等待几分钟后重新查询

### Q4: Console显示"网络请求失败"

**可能原因**：
- 网络断开
- 域名未配置
- 防火墙拦截

**解决**：
1. 检查网络连接
2. 关闭URL校验（开发阶段）
3. 配置服务器域名（生产环境）

## 📞 仍然无法解决？

### 收集诊断信息

1. **Console完整日志**：
   - 截图Console的所有输出
   - 包括错误堆栈

2. **打印机信息**：
   ```javascript
   const printer = uni.getStorageSync('selectedPrinter')
   console.log(JSON.stringify(printer, null, 2))
   ```

3. **API请求详情**：
   - 请求URL
   - 请求方法
   - 请求参数
   - 响应状态码
   - 响应内容

4. **环境信息**：
   - 操作系统
   - 微信开发者工具版本
   - 项目版本（v1.2.0）

### 联系技术支持

发送以上信息到：
- 邮箱：support@liankenet.com
- 标题：【打印机无反应】问题反馈

或者：
- 查看「使用指南.md」常见问题章节
- 查看「验证清单.md」完整测试流程

## 📚 相关文档

- **快速参考.md** - 快速操作指南
- **使用指南.md** - 详细使用说明
- **验证清单.md** - 完整测试流程
- **README.md** - 项目说明

## ✅ 问题解决确认

修复后，您应该看到：

1. ✅ Console不再显示404错误
2. ✅ API请求URL是 `/v3/print/submitTask`
3. ✅ 返回状态码是200
4. ✅ 显示任务ID
5. ✅ 可以查询任务状态

---

**更新日期**: 2026-01-27  
**版本**: v1.2.1  
**问题**: API 404错误  
**状态**: ✅ 已修复
