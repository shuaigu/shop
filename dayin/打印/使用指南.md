# 链科云打印小程序使用指南

## 🎯 功能概述

本小程序已完善云盒打印机连接功能，支持通过链科云API进行文档打印。

---

## ✅ 已修复的问题

### 1. 打印机信息字段统一
- **问题**：之前打印机信息使用 `secret` 字段，但API需要 `password` 字段
- **修复**：统一使用 `password` 字段存储设备密码

### 2. 驱动名称字段补充
- **问题**：缺少 `driverName` 字段，导致打印参数不完整
- **修复**：添加 `driverName` 字段，默认使用打印机型号

### 3. 参数验证增强
- **问题**：打印时未验证必需参数是否完整
- **修复**：添加参数完整性检查，打印前提示缺失参数

---

## 📱 快速开始

### 第一步：添加打印机

1. 打开小程序，点击首页「当前打印机」卡片
2. 进入打印机管理页面
3. 点击「+ 添加打印机」按钮
4. 有两种方式添加：

#### 方式一：快速填充（推荐用于测试）
- 点击「⚡ 快速填充测试设备」按钮
- 系统自动填充配置文件中的默认设备信息
- 检查信息无误后点击「确定」

#### 方式二：手动输入
填写以下信息：
- **打印机名称**：自定义名称（如：办公室打印机）
- **打印机型号**：设备型号（如：LP-N110W_D2）
- **打印机ID**：设备ID（如：lc01cc05708199）
- **打印机密钥**：设备密码（如：XnoyolfCxRRxQThh）
- **驱动名称**：驱动程序名称（可选，默认使用型号）

### 第二步：连接测试

1. 返回首页
2. 点击「🔌 连接测试」按钮
3. 系统会自动执行三步测试：
   - ✓ 验证设备信息
   - ✓ 连接打印机
   - ✓ 发送测试任务
4. 查看日志确认每步是否成功
5. 记录返回的任务ID

### 第三步：查询任务状态

1. 在测试页面，找到「任务状态查询」卡片
2. 点击「查询任务状态」按钮
3. 查看任务状态：
   - **PENDING**：待处理（黄色）
   - **PROCESSING**：处理中（黄色）
   - **SUCCESS**：成功（绿色）
   - **FAILED/ERROR**：失败（红色）
4. 如果任务成功完成，点击「打开预览图」查看打印预览

---

## 🖨️ 使用打印功能

### 文档打印（推荐）

1. 进入「打印」页面
2. 选择「文档」类型
3. 选择输入方式：

#### URL方式（推荐）
- 选择「文件URL」
- 输入文件的完整URL地址
- 示例：`https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf`
- **要求**：URL必须公开可访问

#### 本地文件方式
- 选择「本地文件」
- 点击「选择文件」
- 选择要打印的PDF、Word等文档
- 系统会自动上传文件

4. 设置打印参数：
   - **打印机**：选择已添加的打印机
   - **打印份数**：1-99份
   - **纸张大小**：A4、A5、A3、Letter
   - **打印方向**：竖向/横向
   - **颜色**：黑白/彩色
   - **双面打印**：关闭/长边/短边

5. 点击「开始打印」
6. 记录返回的任务ID
7. 可在历史记录中查询任务状态

### 文本打印

1. 选择「文本」类型
2. 输入要打印的文本内容
3. 调整字体大小（12-48）
4. 设置打印参数
5. 开始打印

### 图片打印

1. 选择「图片」类型
2. 点击「+ 添加图片」
3. 从相册选择或拍照
4. 最多支持9张图片
5. 设置打印参数
6. 开始打印

### 标签打印

1. 选择「标签」类型
2. 输入标签内容
3. 选择标签模板
4. 设置打印参数
5. 开始打印

---

## ⚙️ 打印参数详解

### 纸张大小 (dmPaperSize)
| 名称 | 值 | 说明 |
|------|-----|------|
| Letter | 1 | 8.5×11英寸 |
| A3 | 8 | 297×420mm |
| A4 | 9 | 210×297mm（常用） |
| A5 | 11 | 148×210mm |

### 打印方向 (dmOrientation)
| 名称 | 值 | 说明 |
|------|-----|------|
| 竖向 | 1 | Portrait（默认） |
| 横向 | 2 | Landscape |

### 颜色模式 (dmColor)
| 名称 | 值 | 说明 |
|------|-----|------|
| 黑白 | 1 | 单色打印（默认） |
| 彩色 | 2 | 彩色打印 |

### 双面打印 (dmDuplex)
| 名称 | 值 | 说明 |
|------|-----|------|
| 关闭 | 1 | 单面打印（默认） |
| 长边 | 2 | 沿长边翻转 |
| 短边 | 3 | 沿短边翻转 |

### 预览选项 (isPreview)
| 名称 | 值 | 说明 |
|------|-----|------|
| 否 | 0 | 不生成预览图 |
| 是 | 1 | 生成预览图（默认） |

---

## 🔍 任务状态说明

### 任务生命周期

1. **PENDING**（待处理）
   - 任务已提交，等待云盒处理
   - 通常持续几秒钟

2. **PROCESSING**（处理中）
   - 云盒正在处理任务
   - 正在生成打印文件或预览图

3. **SUCCESS**（成功）
   - 任务处理完成
   - 如果开启预览，可查看预览图
   - 打印机应该开始打印

4. **FAILED**（失败）
   - 任务处理失败
   - 检查错误信息
   - 可能原因：
     - 文件URL无法访问
     - 打印参数错误
     - 打印机离线
     - 权限不足

5. **ERROR**（错误）
   - 系统错误
   - 联系技术支持

### 查询任务

1. 在「测试」页面查询单个任务
2. 在「历史」页面查看所有任务
3. 任务信息保存在本地存储
4. 可以多次查询同一任务

---

## 📊 历史记录

历史记录会自动保存以下信息：
- 任务ID
- 打印类型
- 打印机名称
- 提交时间
- 任务状态
- 打印参数

最多保存最近100条记录。

---

## 🔧 常见问题

### Q1: 打印任务提交失败怎么办？

**检查清单**：
1. 确认打印机信息是否完整（ID、密码、驱动名称）
2. 检查网络连接是否正常
3. 确认打印机在管理后台显示在线
4. 验证文件URL是否可公开访问（如使用URL打印）

**解决方法**：
- 重新添加打印机
- 使用「连接测试」功能验证配置
- 查看日志了解具体错误信息

### Q2: 如何获取设备ID和密码？

1. 登录链科云管理后台：https://open.liankenet.com
2. 查看设备列表
3. 点击设备详情
4. 复制设备ID和密码

### Q3: 支持哪些文件格式？

**文档打印支持**：
- PDF文档（推荐）
- Word文档（.doc, .docx）
- Excel表格（.xls, .xlsx）
- PowerPoint演示（.ppt, .pptx）
- 文本文件（.txt）

**图片打印支持**：
- JPG/JPEG
- PNG
- GIF
- BMP

### Q4: 任务一直是PENDING状态怎么办？

**可能原因**：
1. 云盒离线或未运行
2. 打印机未连接或离线
3. 网络延迟

**解决方法**：
1. 检查云盒程序是否运行
2. 检查打印机电源和连接
3. 等待1-2分钟后重新查询
4. 如果仍然失败，取消任务并重新提交

### Q5: 预览图不显示怎么办？

**原因**：
- 任务未完成
- 未开启预览功能
- 预览图生成失败

**解决方法**：
1. 确认任务状态为SUCCESS
2. 确认打印参数中 `isPreview = 1`
3. 重新查询任务状态
4. 如果预览图仍不显示，任务可能已完成打印

### Q6: 如何测试打印机连接？

**方法一：使用连接测试页面**
1. 首页点击「🔌 连接测试」
2. 点击「🚀 开始测试」
3. 查看测试日志
4. 确认三个步骤都成功

**方法二：使用快速打印**
1. 首页点击「🖨️ 快速打印」
2. 确认打印机
3. 提交测试任务
4. 查看打印结果

**方法三：获取打印机列表**
1. 在测试页面点击「🖨️ 获取打印机列表」
2. 查看日志输出的打印机信息
3. 确认目标打印机在列表中

---

## 🌐 管理后台

### Web管理页面

1. 在测试页面点击「🌐 打开Web管理」
2. 链接会自动复制到剪贴板
3. 在浏览器中打开链接
4. 可以查看：
   - 设备状态
   - 打印机列表
   - 任务历史
   - 设备配置

### 管理后台地址

- **云打印管理**：https://printing.liankenet.com
- **设备管理**：https://open.liankenet.com
- **API文档**：https://cloud.liankenet.com/api/docs

---

## 📝 API配置说明

### 配置文件位置

`utils/printApi.js`

### 主要配置项

```javascript
const config = {
  clientId: 'dImA9V2fbB556AFMYaK88eHtXyHpCCgH',
  clientSecret: 'dImA9V2fbB556AFMYaK88eHtXyHpCCgH',
  baseUrl: 'https://cloud.liankenet.com',
  version: 'v1',
  defaultDevice: {
    id: 'lc01cc05708199',
    password: 'XnoyolfCxRRxQThh',
    model: 'LP-N110W_D2',
    name: 'LP-N110W_D2_60',
    driverName: 'LP-N110W_D2'
  }
}
```

### 认证方式

小程序支持三种认证方式：

1. **Token认证（推荐）**
   - 使用设备ID和密码生成Base64 Token
   - Header: `Authorization: Basic <token>`
   - 适用于V3 API

2. **签名认证**
   - 使用MD5签名算法
   - Headers: `X-Client-Id`, `X-Timestamp`, `X-Sign`
   - 适用于V1/V2 API

3. **无认证**
   - 仅适用于部分公开接口
   - 如获取打印机列表

---

## 🚀 最佳实践

### 1. 生产环境配置

- 修改 `utils/printApi.js` 中的 `clientId` 和 `clientSecret`
- 使用真实的设备ID和密码
- 建议将敏感信息存储在服务器端

### 2. 错误处理

- 始终检查API返回的状态码
- 使用try-catch捕获异常
- 向用户显示友好的错误信息

### 3. 性能优化

- 使用URL打印代替本地文件上传（更快）
- 预览图按需生成（`isPreview = 0`）
- 批量打印时控制并发数量

### 4. 用户体验

- 打印前显示参数预览
- 提供任务进度反馈
- 保存用户常用设置

### 5. 安全建议

- 不要在前端暴露完整的密钥
- 使用HTTPS传输敏感信息
- 定期更新设备密码

---

## 📞 技术支持

### 联系方式

- **官网**：https://liankenet.com
- **文档**：https://cloud.liankenet.com/api/docs
- **客服邮箱**：support@liankenet.com

### 反馈问题

提交问题时请提供：
1. 设备ID（脱敏处理）
2. 任务ID
3. 错误信息截图
4. 操作步骤说明
5. 小程序版本号

---

## 📅 更新日志

### v1.2.0 (2026-01-27)
- ✅ 修复打印机信息字段不统一问题
- ✅ 添加驱动名称字段支持
- ✅ 增强打印参数验证
- ✅ 添加快速填充测试设备功能
- ✅ 优化错误提示信息
- ✅ 完善使用文档

### v1.1.0 (2026-01-15)
- ✅ 更新API配置
- ✅ 添加V3 API支持
- ✅ 完善任务状态查询
- ✅ 添加预览图功能
- ✅ 增强连接测试功能

### v1.0.0 (2025-12-01)
- 🎉 初始版本发布
- ✨ 基础打印功能
- ✨ 打印机管理
- ✨ 历史记录

---

**版本**：v1.2.0  
**更新日期**：2026-01-27  
**作者**：Qoder AI Assistant

---

## 📖 附录

### A. 设备信息获取步骤

1. 访问 https://open.liankenet.com
2. 使用账号登录
3. 点击「设备管理」
4. 找到您的云盒设备
5. 点击「查看详情」
6. 复制以下信息：
   - 设备ID（Device ID）
   - 设备密码（Device Password）
   - 设备型号（Model）

### B. 打印机驱动名称查找

1. 在设备管理页面点击「打印机列表」
2. 查看打印机详情
3. 复制「驱动名称」字段
4. 如果没有显示，使用打印机型号

### C. 文件URL要求

**有效的URL示例**：
```
https://example.com/document.pdf
https://cdn.example.com/files/report.pdf
https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf
```

**无效的URL**：
- `file:///C:/documents/test.pdf`（本地路径）
- `http://localhost/test.pdf`（内网地址）
- `https://example.com/private.pdf`（需要认证）

**URL托管建议**：
- 使用云存储服务（阿里云OSS、腾讯云COS等）
- 设置公开读权限
- 配置CORS跨域
- 使用CDN加速

---

**祝您使用愉快！** 🎉
