# 链科云打印小程序使用说明

## 一、项目简介

这是一个基于 uni-app 开发的链科云打印微信小程序，支持文本、图片、文档和标签打印功能。

## 二、功能特点

### 1. 多种打印方式
- **文本打印**：支持自定义文本内容和字体大小
- **图片打印**：支持批量选择图片打印
- **文档打印**：支持 PDF、Word、Excel、PPT 等文档格式
- **标签打印**：支持多种标签模板

### 2. 打印机管理
- 添加打印机（支持扫码添加）
- 切换打印机
- 查看打印机状态

### 3. 打印设置
- 自定义打印份数
- 选择纸张大小
- 设置打印方向（竖向/横向）
- 选择颜色模式（彩色/黑白）

### 4. 历史记录
- 查看打印历史
- 按状态和类型筛选
- 查看详细信息
- 重新打印失败任务

## 三、配置步骤

### 1. 获取 API 密钥

1. 登录链科云打印管理后台：https://open.liankenet.com
2. 进入"开发秘钥"菜单
3. 获取 `clientId` 和 `clientSecret`

### 2. 获取设备信息

1. 在管理后台进入「设备管理」
2. 查看您的云盒设备详情
3. 记录以下信息：
   - 设备ID（Device ID）
   - 设备密码（Device Password）
   - 打印机型号（Model）
   - 驱动名称（Driver Name）

### 3. 配置小程序

打开 `utils/printApi.js` 文件，修改配置：

```javascript
const config = {
    clientId: '你的clientId',
    clientSecret: '你的clientSecret',
    baseUrl: 'https://cloud.liankenet.com',
    version: 'v1',
    defaultDevice: {
        id: '你的设备ID',
        password: '你的设备密码',
        model: '你的打印机型号',
        name: '你的打印机名称',
        driverName: '你的驱动名称'
    }
}
```

### 4. 配置微信小程序

打开 `manifest.json` 文件，修改小程序 appid：

```json
"mp-weixin": {
    "appid": "你的小程序appid",
    "setting": {
        "urlCheck": false
    }
}
```

### 5. 配置服务器域名

在微信小程序管理后台，配置以下服务器域名：

**request合法域名**：
- https://cloud.liankenet.com

**uploadFile合法域名**：
- https://cloud.liankenet.com

## 四、快速开始 🚀

### 1. 添加打印机（推荐使用快速填充）

**方式一：快速填充（推荐）**
1. 点击首页的「当前打印机」卡片
2. 点击「+ 添加打印机」按钮
3. 点击「⚡ 快速填充测试设备」
4. 检查信息后点击「确定」

**方式二：手动输入**
1. 点击首页的「当前打印机」卡片
2. 点击「+ 添加打印机」按钮
3. 手动填写：
   - 打印机名称
   - 打印机型号
   - 打印机ID
   - 打印机密钥
   - 驱动名称（可选）
4. 点击「确定」完成添加

### 2. 连接测试

1. 返回首页
2. 点击「🔌 连接测试」按钮
3. 点击「🚀 开始测试」
4. 查看日志确认连接成功
5. 记录返回的任务ID

### 3. 查询任务状态

1. 在测试页面找到「任务状态查询」卡片
2. 点击「查询任务状态」按钮
3. 查看任务状态和完成时间
4. 任务成功后点击「打开预览图」

### 4. 开始打印

**文档打印（推荐）**
1. 进入「打印」页面
2. 选择「文档」类型
3. 选择「文件URL」方式
4. 输入文件URL（示例：`https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf`）
5. 设置打印参数（纸张、方向、颜色等）
6. 点击「开始打印」
7. 可在历史记录中查看任务状态

**其他打印类型**
- 文本打印：输入文本内容
- 图片打印：选择图片
- 标签打印：输入标签内容

### 5. 查看历史

1. 点击底部「历史」标签
2. 可按状态和类型筛选
3. 点击记录查看详情
4. 失败的任务可重新打印

## 五、详细文档 📖

- **使用指南.md** - 完整的使用说明和最佳实践
- **更新说明-2026-01-27.md** - 最新版本更新内容
- **打印功能完善说明.md** - 技术文档和API说明

## 六、API 接口说明

### 主要接口

1. **获取打印机列表**
   - 接口：`GET /api/printer/list`

2. **获取打印机状态**
   - 接口：`GET /api/printer/status`

3. **添加打印机**
   - 接口：`POST /api/printer/add`

4. **文本打印**
   - 接口：`POST /api/print/text`

5. **图片打印**
   - 接口：`POST /api/print/image`

6. **文档打印**
   - 接口：`POST /api/print/document`

7. **标签打印**
   - 接口：`POST /api/print/label`

8. **文件上传**
   - 接口：`POST /api/file/upload`

### 请求签名

所有API请求都需要签名验证：

1. 将请求参数按字母顺序排序
2. 拼接成字符串：`key1=value1&key2=value2&timestamp=xxx&secret=xxx`
3. 使用MD5加密生成签名
4. 将签名添加到请求参数中

## 七、开发说明

### 技术栈

- uni-app（Vue 3）
- 微信小程序

### 项目结构

```
打印/
├── pages/                 # 页面
│   ├── index/            # 首页
│   ├── print/            # 打印页面
│   ├── printer/          # 打印机管理
│   └── history/          # 历史记录
├── utils/                # 工具类
│   └── printApi.js       # API封装
├── App.vue               # 应用入口
├── main.js               # 主入口
├── manifest.json         # 配置文件
└── pages.json            # 页面配置
```

### 本地存储数据

- `printers`: 打印机列表
- `selectedPrinter`: 当前选中的打印机
- `printHistory`: 打印历史记录

## 八、常见问题

### 1. 打印失败怎么办？

**检查清单：**
- ✅ 打印机信息是否完整（ID、密码、驱动名称）
- ✅ 网络连接是否正常
- ✅ 打印机在管理后台是否显示在线
- ✅ 文件URL是否可公开访问（如使用URL打印）

**解决方法：**
1. 删除打印机并重新添加（使用快速填充）
2. 使用「连接测试」功能验证配置
3. 查看开发者工具Console日志
4. 参考「使用指南.md」文档

### 2. 无法连接打印机

**可能原因：**
- 打印机ID或密码错误
- 云盒程序未运行
- 打印机离线或未连接
- 网络问题

**解决方法：**
1. 登录管理后台确认设备在线
2. 检查云盒程序是否运行
3. 重启打印机和云盒
4. 检查网络连接

### 3. 任务一直是PENDING状态

**可能原因：**
- 云盒离线
- 打印机未连接
- 网络延迟

**解决方法：**
1. 等待1-2分钟后重新查询
2. 检查云盒和打印机状态
3. 取消任务并重新提交

### 4. 图片/文档上传失败

- 检查文件大小（建议不超过50MB）
- 检查网络状态
- 检查文件格式是否支持
- 使用URL方式代替本地上传

### 5. 预览图不显示

**原因：**
- 任务未完成
- 未开启预览功能（isPreview=0）

**解决方法：**
1. 确认任务状态为SUCCESS
2. 重新查询任务状态
3. 确认打印参数中isPreview=1

更多问题请参考「使用指南.md」中的常见问题章节。

## 九、联系方式

- 官网：https://liankenet.com
- 设备管理：https://open.liankenet.com
- 云打印管理：https://printing.liankenet.com
- API文档：https://cloud.liankenet.com/api/docs
- 技术支持：support@liankenet.com

## 十、注意事项

1. **安全性**：请妥善保管 `clientSecret`，不要泄露
2. **测试**：正式使用前请先在测试环境充分测试
3. **费用**：根据实际打印次数收费，请关注账户余额
4. **兼容性**：建议使用最新版本微信小程序
5. **网络**：确保网络连接稳定

## 十一、更新日志

### v1.2.0 (2026-01-27) ⭐ 最新
- **✅ 修复打印机信息字段不匹配问题**
  - 统一使用 `password` 字段（原为 `secret`）
  - 添加 `driverName` 驱动名称字段
  - 修复打印时参数缺失导致的失败问题
- **✅ 增强参数验证**
  - 添加打印前参数完整性检查
  - 改进错误提示信息
  - 添加调试日志输出
- **✅ 优化用户体验**
  - 添加「快速填充测试设备」功能
  - 简化打印机添加流程
  - 完善使用指南文档
- **📝 新增文档**
  - 使用指南.md - 详细使用说明
  - 更新说明-2026-01-27.md - 本次更新内容

### v1.1.0 (2026-01-15)
- 更新API配置为实际测试设备
- 添加V3 API支持
- 完善任务状态查询功能
- 添加预览图功能
- 增强连接测试功能

### v1.0.0 (2025-12-01)
- 首次发布
- 支持文本、图片、文档、标签打印
- 打印机管理功能
- 打印历史记录
- 完整的打印设置选项
