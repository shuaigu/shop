{"version":3,"file":"userProfile.js","sources":["pages/userProfile/userProfile.vue","D:/代码测试/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdXNlclByb2ZpbGUvdXNlclByb2ZpbGUudnVl"],"sourcesContent":["<script setup>\r\n  import { ref, computed, onMounted } from 'vue'\r\n  import { useUserInfoStore } from '@/store/user.js'\r\n  // uni对象是全局的，不需要导入\r\n  // userStore\r\n  const userStore = useUserInfoStore()\r\n  // 用户云对象\r\n  const userApi = uniCloud.importObject('userDy')\r\n  \r\n  // 页面参数\r\n  const loginCode = ref('')\r\n  \r\n  // 用户信息\r\n  const userProfile = ref({\r\n    nickName: '',\r\n    avatarUrl: '/static/images/defalut.png',\r\n    mobile: ''\r\n  })\r\n  \r\n  // 表单校验状态\r\n  const formValid = ref(false)\r\n  // 提交状态\r\n  const submitting = ref(false)\r\n  // 表单验证错误信息\r\n  const validationErrors = ref({\r\n    nickname: ''\r\n  })\r\n  \r\n  // 计算属性判断表单是否有效\r\n  const isFormValid = computed(() => {\r\n    return userProfile.value.nickName.trim() !== '' && \r\n           userProfile.value.avatarUrl !== '/static/images/defalut.png' &&\r\n           !validationErrors.value.nickname\r\n  })\r\n  \r\n  // 验证昵称\r\n  function validateNickname(value) {\r\n    if (!value.trim()) {\r\n      validationErrors.value.nickname = '昵称不能为空'\r\n      return false\r\n    }\r\n    if (value.length > 20) {\r\n      validationErrors.value.nickname = '昵称不能超过20个字符'\r\n      return false\r\n    }\r\n    validationErrors.value.nickname = ''\r\n    return true\r\n  }\r\n  \r\n  // 监听昵称输入\r\n  const onNicknameInput = (e) => {\r\n    const value = e.detail.value\r\n    userProfile.value.nickName = value\r\n    validateNickname(value)\r\n  }\r\n  \r\n  // 选择头像\r\n  const chooseAvatar = () => {\r\n    uni.chooseImage({\r\n      count: 1,\r\n      sizeType: ['compressed'],\r\n      sourceType: ['album', 'camera'],\r\n      success: (res) => {\r\n        const tempFilePath = res.tempFilePaths[0]\r\n        \r\n        // 使用uni.uploadFile上传到服务器或临时存储\r\n        // 这里暂时直接设置临时路径\r\n        userProfile.value.avatarUrl = tempFilePath\r\n      }\r\n    })\r\n  }\r\n  \r\n  // 获取手机号\r\n  const getPhoneNumber = async (e) => {\r\n    try {\r\n      if (e.detail.errMsg !== 'getPhoneNumber:ok') {\r\n        uni.showToast({\r\n          title: '未授权手机号',\r\n          icon: 'none',\r\n          duration: 2000\r\n        })\r\n        return\r\n      }\r\n      \r\n      const params = {\r\n        code: loginCode.value,\r\n        encryptedData: e.detail.encryptedData,\r\n        iv: e.detail.iv\r\n      }\r\n      \r\n      uni.showLoading({\r\n        title: '获取中...',\r\n        mask: true\r\n      })\r\n      \r\n      // 调用接口获取手机号\r\n      const res = await userApi.getPhoneNumberDy(params)\r\n      \r\n      uni.hideLoading()\r\n      \r\n      if (res.code === 0 && res.data?.phoneNumber) {\r\n        userProfile.value.mobile = res.data.phoneNumber\r\n        uni.showToast({\r\n          title: '获取成功',\r\n          icon: 'success',\r\n          duration: 2000\r\n        })\r\n      } else {\r\n        throw new Error(res.message || '获取手机号失败')\r\n      }\r\n    } catch (err) {\r\n      console.error('获取手机号失败:', err)\r\n      uni.showToast({\r\n        title: err.message || '获取手机号失败',\r\n        icon: 'none',\r\n        duration: 2000\r\n      })\r\n    }\r\n  }\r\n  \r\n  // 提交用户信息\r\n  const submitUserInfo = async () => {\r\n    if (!isFormValid.value) {\r\n      uni.showToast({\r\n        title: '请填写完整信息',\r\n        icon: 'none',\r\n        duration: 2000\r\n      })\r\n      return\r\n    }\r\n    \r\n    submitting.value = true\r\n    \r\n    try {\r\n      uni.showLoading({\r\n        title: '保存中...',\r\n        mask: true\r\n      })\r\n      \r\n      // 获取登录code\r\n      const loginRes = await uni.login()\r\n      if (!loginRes.code) {\r\n        throw new Error('获取登录凭证失败')\r\n      }\r\n      \r\n      let cloudFunctionName = 'user'\r\n      let actionName = 'registerUser'\r\n      \r\n      // #ifdef MP-TOUTIAO\r\n      cloudFunctionName = 'userDy'\r\n      actionName = 'registerUserDy'\r\n      // #endif\r\n      \r\n      // 调用云函数注册/更新用户信息\r\n      const { result } = await uni.cloud.callFunction({\r\n        name: cloudFunctionName,\r\n        data: {\r\n          action: actionName,\r\n          params: {\r\n            code: loginRes.code,\r\n            nickName: userProfile.value.nickName,\r\n            avatarUrl: userProfile.value.avatarUrl,\r\n            mobile: userProfile.value.mobile\r\n          }\r\n        }\r\n      })\r\n      \r\n      if (result.code === 0) {\r\n        // 保存用户信息到本地\r\n        userStore.setUserInfo({\r\n          uid: result.data._id || result.data.uid || '',\r\n          nickName: result.data.nickName || '',\r\n          avatarUrl: result.data.avatarUrl || \"/static/images/defalut.png\",\r\n          mobile: result.data.mobile || '',\r\n          isLogin: true,\r\n          role: Array.isArray(result.data.role) ? result.data.role : ['user'],\r\n        })\r\n        \r\n        uni.showToast({\r\n          title: '保存成功',\r\n          icon: 'success',\r\n          duration: 2000,\r\n          success: () => {\r\n            // 延迟返回，确保toast显示完成\r\n            setTimeout(() => {\r\n              // 返回上一页\r\n              uni.navigateBack()\r\n            }, 2000)\r\n          }\r\n        })\r\n      } else {\r\n        throw new Error(result.message || '保存失败')\r\n      }\r\n    } catch (err) {\r\n      console.error('提交用户信息错误:', err)\r\n      uni.showToast({\r\n        title: '保存失败，请重试',\r\n        icon: 'none',\r\n        duration: 2000\r\n      })\r\n    } finally {\r\n      submitting.value = false\r\n      uni.hideLoading()\r\n    }\r\n  }\r\n  \r\n  // 返回登录页\r\n  const goBack = () => {\r\n    uni.navigateBack()\r\n  }\r\n  \r\n  // 页面加载\r\n  onMounted(() => {\r\n    // 获取页面参数\r\n    const pages = getCurrentPages();\r\n    const currentPage = pages[pages.length - 1];\r\n    \r\n    // 获取页面传递的loginCode\r\n    if (currentPage && currentPage.options && currentPage.options.code) {\r\n      loginCode.value = currentPage.options.code;\r\n    } else {\r\n      // 兼容方式获取参数\r\n      const query = uni.$route?.query || uni.getLaunchOptionsSync().query || {};\r\n      if (query.code) {\r\n        loginCode.value = query.code;\r\n      }\r\n    }\r\n  })\r\n</script>\r\n\r\n<template>\r\n  <view class=\"profile-container\">\r\n    <view class=\"page-header\">\r\n      <view class=\"back-btn\" @click=\"goBack\">\r\n        <text class=\"back-icon\">←</text>\r\n      </view>\r\n      <view class=\"header-title\">完善资料</view>\r\n    </view>\r\n    \r\n    <view class=\"avatar-section\">\r\n      <view class=\"avatar-wrapper\" @click=\"chooseAvatar\">\r\n        <image :src=\"userProfile.avatarUrl\" mode=\"aspectFill\" class=\"avatar-image\"></image>\r\n        <view class=\"avatar-edit\">\r\n          <text class=\"edit-icon\">+</text>\r\n        </view>\r\n      </view>\r\n      <view class=\"avatar-tip\">点击更换头像</view>\r\n    </view>\r\n    \r\n    <view class=\"form-section\">\r\n      <view class=\"form-item\">\r\n        <text class=\"form-label\">昵称</text>\r\n        <input \r\n          class=\"form-input\" \r\n          type=\"text\" \r\n          placeholder=\"请输入昵称\"\r\n          v-model=\"userProfile.nickName\"\r\n          @input=\"onNicknameInput\"\r\n        />\r\n        <view v-if=\"validationErrors.nickname\" class=\"error-message\">\r\n          {{ validationErrors.nickname }}\r\n        </view>\r\n      </view>\r\n      \r\n      <view class=\"form-item\">\r\n        <text class=\"form-label\">手机号</text>\r\n        <view class=\"phone-section\">\r\n          <text class=\"phone-text\" v-if=\"userProfile.mobile\">{{ userProfile.mobile }}</text>\r\n          <text class=\"phone-placeholder\" v-else>未绑定手机号</text>\r\n          <button class=\"phone-btn\" open-type=\"getPhoneNumber\" @getphonenumber=\"getPhoneNumber\">获取</button>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <view class=\"submit-section\">\r\n      <button \r\n        class=\"submit-btn\" \r\n        :disabled=\"!isFormValid || submitting\" \r\n        :loading=\"submitting\"\r\n        @click=\"submitUserInfo\"\r\n      >\r\n        完成\r\n      </button>\r\n      <view class=\"skip-btn\" @click=\"submitUserInfo\">跳过手机号绑定</view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<style lang=\"scss\" scoped>\r\n.profile-container {\r\n  min-height: 100vh;\r\n  padding: 0 30rpx;\r\n  background-color: #fff;\r\n}\r\n\r\n.page-header {\r\n  position: relative;\r\n  height: 100rpx;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  \r\n  .back-btn {\r\n    position: absolute;\r\n    left: 0;\r\n    width: 80rpx;\r\n    height: 80rpx;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    \r\n    .back-icon {\r\n      font-size: 40rpx;\r\n      color: #333;\r\n    }\r\n  }\r\n  \r\n  .header-title {\r\n    font-size: 34rpx;\r\n    font-weight: 500;\r\n    color: #333;\r\n  }\r\n}\r\n\r\n.avatar-section {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  padding: 60rpx 0;\r\n  \r\n  .avatar-wrapper {\r\n    position: relative;\r\n    width: 180rpx;\r\n    height: 180rpx;\r\n    border-radius: 90rpx;\r\n    overflow: hidden;\r\n    \r\n    .avatar-image {\r\n      width: 100%;\r\n      height: 100%;\r\n    }\r\n    \r\n    .avatar-edit {\r\n      position: absolute;\r\n      right: 0;\r\n      bottom: 0;\r\n      width: 50rpx;\r\n      height: 50rpx;\r\n      border-radius: 25rpx;\r\n      background-color: $pyq-vi-color;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      \r\n      .edit-icon {\r\n        color: #fff;\r\n        font-size: 30rpx;\r\n      }\r\n    }\r\n  }\r\n  \r\n  .avatar-tip {\r\n    margin-top: 20rpx;\r\n    font-size: 26rpx;\r\n    color: #999;\r\n  }\r\n}\r\n\r\n.form-section {\r\n  margin-top: 40rpx;\r\n  \r\n  .form-item {\r\n    margin-bottom: 40rpx;\r\n    \r\n    .form-label {\r\n      display: block;\r\n      font-size: 28rpx;\r\n      color: #333;\r\n      margin-bottom: 20rpx;\r\n    }\r\n    \r\n    .form-input {\r\n      width: 100%;\r\n      height: 80rpx;\r\n      border-radius: 12rpx;\r\n      background-color: #f8f8f8;\r\n      padding: 0 20rpx;\r\n      font-size: 28rpx;\r\n      color: #333;\r\n    }\r\n    \r\n    .phone-section {\r\n      display: flex;\r\n      align-items: center;\r\n      height: 80rpx;\r\n      background-color: #f8f8f8;\r\n      border-radius: 12rpx;\r\n      padding: 0 20rpx;\r\n      \r\n      .phone-text, .phone-placeholder {\r\n        flex: 1;\r\n        font-size: 28rpx;\r\n      }\r\n      \r\n      .phone-text {\r\n        color: #333;\r\n      }\r\n      \r\n      .phone-placeholder {\r\n        color: #999;\r\n      }\r\n      \r\n      .phone-btn {\r\n        width: 120rpx;\r\n        height: 60rpx;\r\n        line-height: 60rpx;\r\n        background-color: $pyq-vi-color;\r\n        color: #fff;\r\n        font-size: 26rpx;\r\n        padding: 0;\r\n        margin: 0;\r\n        border-radius: 30rpx;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n.submit-section {\r\n  margin-top: 80rpx;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  \r\n  .submit-btn {\r\n    width: 80%;\r\n    height: 88rpx;\r\n    line-height: 88rpx;\r\n    background-color: $pyq-vi-color;\r\n    color: #fff;\r\n    font-size: 32rpx;\r\n    border-radius: 44rpx;\r\n    \r\n    &[disabled] {\r\n      background-color: #ccc;\r\n      color: #fff;\r\n    }\r\n  }\r\n  \r\n  .skip-btn {\r\n    margin-top: 30rpx;\r\n    font-size: 28rpx;\r\n    color: #999;\r\n    text-decoration: underline;\r\n  }\r\n}\r\n\r\n.error-message {\r\n  font-size: 24rpx;\r\n  color: #ff4d4f;\r\n  margin-top: 10rpx;\r\n}\r\n</style> ","import MiniProgramPage from 'E:/dy2/pages/userProfile/userProfile.vue'\ntt.createPage(MiniProgramPage)"],"names":["useUserInfoStore","uniCloud","ref","computed","uni","onMounted"],"mappings":"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"}