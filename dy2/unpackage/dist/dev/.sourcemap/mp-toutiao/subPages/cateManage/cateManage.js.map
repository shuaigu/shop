{"version":3,"file":"cateManage.js","sources":["subPages/cateManage/cateManage.vue","D:/代码测试/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/c3ViUGFnZXNcY2F0ZU1hbmFnZVxjYXRlTWFuYWdlLnZ1ZQ"],"sourcesContent":["<script setup>\n\timport { ref } from 'vue'\n\timport { onShow } from '@dcloudio/uni-app'\n\tconst cateApi = uniCloud.importObject('cateWx', { customUI: true })\n\tconst qiniuCloud = uniCloud.importObject('qiniuyunCloud', { customUI: true })\n\t\n\t// 获取分类\n\tconst cateList = ref([])\n\tconst cateListGet = async () => {\n\t\t// 使用 get 方法并传递 showAll=true 来获取所有分类(包括隐藏的)\n\t\tconst res = await cateApi.get(null, true)\n\t\tconsole.log(res)\n\t\tcateList.value = res.data\n\t}\n\tonShow(() => {\n\t\tcateListGet()\n\t})\n\t// 弹窗显示状态 - 初始值设为 false\n\tconst showPopup = ref(false)\n\t// 是否是编辑模式\n\tconst isEdit = ref(false)\n\t// 编辑时的初始值\n\tconst editValue = ref('')\n\t// 当前编辑的分类ID\n\tconst currentId = ref('')\n\t// 分类图片\n\tconst cateImage = ref('')\n\t// 图片上传状态\n\tconst imageUploading = ref(false)\n\t// 图片上传进度\n\tconst uploadProgress = ref(0)\n\t// 分类是否可见\n\tconst isVisible = ref(true)\n\n\t// 添加分类\n\tconst handleAddCate = () => {\n\t\tconsole.log(1)\n\t\t// isEdit为false代表此时添加操作\n\t\tisEdit.value = false\n\t\t// 重置图片和编辑值\n\t\tcateImage.value = ''\n\t\teditValue.value = ''\n\t\tisVisible.value = true\n\t\tshowPopup.value = true\n\t}\n\n\t// 编辑分类\n\tconst edit = async (id) => {\n\t\tisEdit.value = true\n\t\tcurrentId.value = id // 保存当前编辑的ID\n\t\t// 根据点击id获取对应分类名称\n\t\tconst res = await cateApi.get(id)\n\t\tconsole.log(res, '单个获取')\n\t\teditValue.value = res.data[0]?.cate_name\n\t\tcateImage.value = res.data[0]?.cate_img || ''\n\t\tisVisible.value = res.data[0]?.is_visible !== false // 默认为true，除非明确设置为false\n\t\tshowPopup.value = true\n\t}\n\n\t// 删除分类\n\tconst del = async (id) => {\n\t\tconst res = await cateApi.del(id)\n\t\tif (res.deleted === 1) {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '删除成功',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t\tcateListGet()\n\t\t}\n\t}\n\t\n\t// 选择图片\n\tconst chooseImage = async () => {\n\t\ttry {\n\t\t\tconst res = await uni.chooseImage({\n\t\t\t\tcount: 1,\n\t\t\t\tsizeType: ['compressed'],\n\t\t\t\tsourceType: ['album', 'camera']\n\t\t\t})\n\t\t\t\n\t\t\tif (res.tempFilePaths && res.tempFilePaths.length > 0) {\n\t\t\t\t// 先显示本地临时图片\n\t\t\t\tconst tempPath = res.tempFilePaths[0]\n\t\t\t\t\n\t\t\t\t// 上传图片到服务器\n\t\t\t\tawait uploadImage(tempPath)\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error('选择图片失败:', e)\n\t\t\tif (e.errMsg !== 'chooseImage:fail cancel') {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '选择图片失败',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\t\n\t// 上传图片到服务器\n\tconst uploadImage = async (filePath) => {\n\t\ttry {\n\t\t\timageUploading.value = true\n\t\t\tuploadProgress.value = 0\n\t\t\t\n\t\t\t// 获取文件扩展名\n\t\t\tconst fileExt = filePath.substring(filePath.lastIndexOf('.') + 1).toLowerCase()\n\t\t\t\n\t\t\t// 上传到uniCloud云存储\n\t\t\tconst result = await uniCloud.uploadFile({\n\t\t\t\tfilePath: filePath,\n\t\t\t\tcloudPath: `cate_icons/${Date.now()}_${Math.random().toString(36).substring(2, 10)}.${fileExt}`,\n\t\t\t\tonUploadProgress: (progressEvent) => {\n\t\t\t\t\tuploadProgress.value = Math.round((progressEvent.loaded / progressEvent.total) * 100)\n\t\t\t\t}\n\t\t\t})\n\t\t\t\n\t\t\tconsole.log('上传结果:', result)\n\t\t\t\n\t\t\tif (result.fileID) {\n\t\t\t\t// 获取临时访问链接\n\t\t\t\tconst tempUrl = await uniCloud.getTempFileURL({\n\t\t\t\t\tfileList: [result.fileID]\n\t\t\t\t})\n\t\t\t\t\n\t\t\t\tconsole.log('临时链接:', tempUrl)\n\t\t\t\t\n\t\t\t\tif (tempUrl.fileList && tempUrl.fileList[0] && tempUrl.fileList[0].tempFileURL) {\n\t\t\t\t\t// 更新图片URL\n\t\t\t\t\tcateImage.value = result.fileID\n\t\t\t\t\t\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '图片上传成功',\n\t\t\t\t\t\ticon: 'success'\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error('获取临时链接失败')\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow new Error('上传失败')\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error('上传图片错误:', e)\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '图片上传失败',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t} finally {\n\t\t\timageUploading.value = false\n\t\t}\n\t}\n\n\t// 确认添加/编辑--弹框确认事件\n\tconst handleConfirm = async (data) => {\n\t\t// 检查是否正在上传图片\n\t\tif (imageUploading.value) {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '图片正在上传中，请稍候',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t\treturn\n\t\t}\n\t\t\n\t\t// 如果是字符串，则兼容旧版本\n\t\tif (typeof data === 'string') {\n\t\t\tdata = {\n\t\t\t\tcate_name: data,\n\t\t\t\tcate_img: cateImage.value,\n\t\t\t\tis_visible: isVisible.value\n\t\t\t}\n\t\t} else if (!data.cate_img && cateImage.value) {\n\t\t\t// 确保图片URL被包含\n\t\t\tdata.cate_img = cateImage.value\n\t\t}\n\t\t\n\t\tif (isEdit.value) {\n\t\t\t// 编辑逻辑\n\t\t\tconsole.log('编辑', data)\n\t\t\tconst upRes = await cateApi.update(currentId.value, data) // 使用保存的ID\n\t\t\tconsole.log(upRes)\n\t\t\tif (upRes.updated === 1) {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '更新成功',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t\tcateListGet()\n\t\t\t}\n\t\t} else {\n\t\t\t// 添加逻辑\n\t\t\tconsole.log('添加', data)\n\t\t\tconst res = await cateApi.add(data)\n\t\t\tif (res.id) {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '添加成功',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t\tcateListGet()\n\t\t\t}\n\t\t}\n\t\t// 重置当前编辑的ID和图片\n\t\tcurrentId.value = ''\n\t\tcateImage.value = ''\n\t}\n\n\t// 点击取消\n\tconst handleCanner = () => {\n\t\tshowPopup.value = false\n\t}\n\t\n\t// 快速切换可见性\n\tconst toggleVisibility = async (id, currentVisibility) => {\n\t\t// 反转逻辑：当前是可见的，切换后应该隐藏，反之亦然\n\t\tconst newVisibility = !currentVisibility;\n\t\t\n\t\ttry {\n\t\t\t// 仅更新可见性字段\n\t\t\tconst upRes = await cateApi.update(id, {\n\t\t\t\tis_visible: newVisibility\n\t\t\t});\n\t\t\t\n\t\t\tif (upRes.updated === 1) {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: newVisibility ? '已启用显示' : '已隐藏分类',\n\t\t\t\t\ticon: 'none'\n\t\t\t\t})\n\t\t\t\tcateListGet()\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('切换可见性失败:', error);\n\t\t\tuni.showToast({\n\t\t\t\ttitle: '操作失败，请重试',\n\t\t\t\ticon: 'none'\n\t\t\t});\n\t\t}\n\t}\n</script>\n\n<template>\n\t<view class=\"cateManage\">\n\t\t<view class=\"cateName\">\n\t\t\t<view class=\"value\" v-for=\"item in cateList\" :key=\"item._id\">\n\t\t\t\t<view class=\"name-container\">\n\t\t\t\t\t<image class=\"cate-image\" :src=\"item.cate_img\" mode=\"aspectFill\" @error=\"item.cate_img = '/static/images/defalut.png'\"></image>\n\t\t\t\t\t<view class=\"name\" :class=\"{ 'hidden-category': !item.is_visible }\">\n\t\t\t\t\t\t{{item.cate_name}}\n\t\t\t\t\t\t<text class=\"hidden-label\" v-if=\"!item.is_visible\">(已隐藏)</text>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"right\">\n\t\t\t\t\t<switch \n\t\t\t\t\t\t:checked=\"item.is_visible === false\" \n\t\t\t\t\t\t@change=\"() => toggleVisibility(item._id, item.is_visible !== false)\" \n\t\t\t\t\t\tcolor=\"#399bfe\"\n\t\t\t\t\t\tstyle=\"margin-right: 16rpx;\"\n\t\t\t\t\t\tscale=\"0.8\"\n\t\t\t\t\t/>\n\t\t\t\t\t<uni-icons @click=\"edit(item._id)\" style=\"margin-right: 16rpx;\" color=\"#399bfe\"\n\t\t\t\t\t\ttype=\"compose\" size=\"22\"></uni-icons>\n\t\t\t\t\t<uni-icons @click=\"del(item._id)\" color=\"#e65c00\" custom-prefix=\"iconfont\"\n\t\t\t\t\t\ttype=\"icon-shanchu1\" size=\"20\"></uni-icons>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\t</view>\n\t<!-- 弹框 -->\n\t<manage-popup \n\t\t:show=\"showPopup\" \n\t\t:title=\"isEdit ? '编辑分类' : '添加分类'\" \n\t\t:edit-value=\"editValue\"\n\t\t:image-url=\"cateImage\"\n\t\t:image-uploading=\"imageUploading\"\n\t\t:upload-progress=\"uploadProgress\"\n\t\t:is-visible=\"isVisible\"\n\t\t@choose-image=\"chooseImage\"\n\t\t@confirm=\"handleConfirm\" \n\t\t@update:show=\"handleCanner\" \n\t/>\n\t<!-- 悬浮按钮 -->\n\t<floatButton icon=\"plus\" :size=\"100\" :position=\"{ bottom: '120rpx', right: '40rpx' }\"\n\t\t@click=\"handleAddCate\"></floatButton>\n</template>\n\n<style lang=\"scss\" scoped>\n\t/*防止分包页面公共样式无法读取*/\n\t@import \"@/style/common.scss\";\n\n\t.cateManage {\n\t\t@include pagesBaseStyle;\n\n\t\t.cateName {\n\t\t\tpadding: 24rpx;\n\t\t\tborder-radius: 24rpx;\n\t\t\tbackground-color: #fff;\n\n\t\t\t.value {\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: space-between;\n\t\t\t\tpadding: 16rpx;\n\t\t\t\tfont-size: 28rpx;\n\t\t\t\tcolor: $pyq-text-color-body;\n\t\t\t\tborder-bottom: 1px solid $pyq-border-color-translucent;\n\n\t\t\t\t&:nth-last-child(1) {\n\t\t\t\t\tborder: none;\n\t\t\t\t}\n\n\t\t\t\t.name-container {\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\t\n\t\t\t\t\t.cate-image {\n\t\t\t\t\t\twidth: 60rpx;\n\t\t\t\t\t\theight: 60rpx;\n\t\t\t\t\t\tborder-radius: 8rpx;\n\t\t\t\t\t\tmargin-right: 16rpx;\n\t\t\t\t\t\tbackground-color: #f5f5f5;\n\t\t\t\t\t\tobject-fit: cover;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t.name {\n\t\t\t\t\t\tfont-size: 28rpx;\n\t\t\t\t\t\t\n\t\t\t\t\t\t&.hidden-category {\n\t\t\t\t\t\t\tcolor: #999;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t.hidden-label {\n\t\t\t\t\t\t\tfont-size: 24rpx;\n\t\t\t\t\t\t\tcolor: #999;\n\t\t\t\t\t\t\tmargin-left: 8rpx;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t.right {\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n</style>","import MiniProgramPage from 'E:/dy2/subPages/cateManage/cateManage.vue'\ntt.createPage(MiniProgramPage)"],"names":["uniCloud","ref","uni","onShow"],"mappings":"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"}