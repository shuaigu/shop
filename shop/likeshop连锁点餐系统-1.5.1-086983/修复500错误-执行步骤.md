# 修复 500 错误 - 执行步骤

## 🐛 问题原因

后端接口返回 500 错误，原因：

1. ✅ **已修复：模型缺少表名配置**
   - 已在 `MarketingChatOrder.php` 中添加 `protected $name = 'marketing_chat_order';`

2. ⚠️ **需要检查：数据库表是否存在**
   - 需要执行 SQL 创建 `la_marketing_chat_order` 表

## 📝 立即执行以下步骤

### 步骤 1：创建数据库表

**方法一：使用 phpMyAdmin 或 Navicat**

1. 打开数据库管理工具
2. 选择你的数据库（likeshop 数据库）
3. 点击"SQL"或"查询"标签
4. 复制并执行以下 SQL：

```sql
-- 营销聊天订单表
CREATE TABLE IF NOT EXISTS `la_marketing_chat_order` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_sn` varchar(64) NOT NULL DEFAULT '' COMMENT '订单编号',
  `user_id` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `order_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '订单金额',
  `pay_way` tinyint(1) NOT NULL DEFAULT '0' COMMENT '支付方式：1-微信支付，2-支付宝支付，3-余额支付',
  `pay_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '支付状态：0-未支付，1-已支付',
  `pay_time` int(11) NOT NULL DEFAULT '0' COMMENT '支付时间',
  `transaction_id` varchar(128) NOT NULL DEFAULT '' COMMENT '第三方平台交易流水号',
  `remark` varchar(255) NOT NULL DEFAULT '' COMMENT '备注',
  `create_time` int(11) NOT NULL DEFAULT '0' COMMENT '创建时间',
  `update_time` int(11) NOT NULL DEFAULT '0' COMMENT '更新时间',
  `delete_time` int(11) DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  KEY `order_sn` (`order_sn`),
  KEY `user_id` (`user_id`),
  KEY `pay_status` (`pay_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='营销聊天订单表';
```

**方法二：使用命令行**

```bash
# 进入 MySQL
mysql -u root -p

# 选择数据库（根据你的实际数据库名修改）
use likeshop;

# 执行 SQL 文件
source /path/to/营销聊天订单表.sql;

# 或直接复制上面的 SQL 执行
```

### 步骤 2：验证表是否创建成功

执行以下 SQL 检查：

```sql
-- 查看表是否存在
SHOW TABLES LIKE 'la_marketing_chat_order';

-- 查看表结构
DESC la_marketing_chat_order;
```

**预期结果：**

```
+----------------+----------------+------+-----+---------+----------------+
| Field          | Type           | Null | Key | Default | Extra          |
+----------------+----------------+------+-----+---------+----------------+
| id             | int unsigned   | NO   | PRI | NULL    | auto_increment |
| order_sn       | varchar(64)    | NO   | MUL |         |                |
| user_id        | int unsigned   | NO   | MUL | 0       |                |
| order_amount   | decimal(10,2)  | NO   |     | 0.00    |                |
| pay_way        | tinyint        | NO   |     | 0       |                |
| pay_status     | tinyint        | NO   | MUL | 0       |                |
| pay_time       | int            | NO   |     | 0       |                |
| transaction_id | varchar(128)   | NO   |     |         |                |
| remark         | varchar(255)   | NO   |     |         |                |
| create_time    | int            | NO   |     | 0       |                |
| update_time    | int            | NO   |     | 0       |                |
| delete_time    | int            | YES  |     | NULL    |                |
+----------------+----------------+------+-----+---------+----------------+
```

### 步骤 3：测试接口

执行完上述步骤后，在微信开发者工具中：

1. **清除缓存并重新编译**
   - 点击"项目" > "清除缓存"
   - 重新编译小程序

2. **测试支付功能**
   - 进入营销聊天页面
   - 点击"立即支付"按钮
   - 查看控制台是否还有错误

3. **检查错误信息**
   - 如果还有错误，查看控制台的详细错误信息
   - 检查 Network 标签中的请求响应

## 🔍 常见问题排查

### Q1: 仍然返回 500 错误？

**检查项：**

1. 数据库表是否真的创建成功？
   ```sql
   SHOW TABLES LIKE 'la_marketing_chat_order';
   ```

2. 后端日志中的详细错误？
   ```bash
   # 查看后端日志
   tail -f server/runtime/log/error.log
   ```

3. PHP 错误日志？
   ```bash
   # 根据你的服务器配置查看
   tail -f /var/log/php/error.log
   ```

### Q2: 提示用户未登录？

**解决方法：**

1. 确保小程序已登录
2. 检查 token 是否有效
   ```javascript
   // 在小程序控制台执行
   console.log(uni.getStorageSync('token'))
   ```

3. 如果 token 为空，需要重新登录

### Q3: 数据库连接失败？

**检查配置：**

```php
// server/.env 或 config/database.php
[DATABASE]
TYPE = mysql
HOSTNAME = 127.0.0.1
DATABASE = likeshop
USERNAME = root
PASSWORD = your_password
HOSTPORT = 3306
```

## ✅ 验证清单

执行完成后，请逐项检查：

- [ ] 数据库表 `la_marketing_chat_order` 已创建
- [ ] 模型文件已添加 `protected $name = 'marketing_chat_order';`
- [ ] 小程序代码已重新编译
- [ ] 用户已登录（token 有效）
- [ ] 点击支付按钮不再显示 500 错误
- [ ] 能够跳转到支付页面

## 📞 如果问题仍未解决

请提供以下信息：

1. 控制台的完整错误信息（截图）
2. Network 标签中的请求详情（截图）
3. 后端日志文件内容
4. 数据库表列表（`SHOW TABLES;` 的结果）

---

**修改时间：** 2026-01-30  
**状态：** ✅ 模型已修复，等待创建数据库表
