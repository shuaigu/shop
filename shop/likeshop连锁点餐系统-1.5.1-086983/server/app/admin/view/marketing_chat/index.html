{layout name="layout1" /}
<style>
    .layui-form-label {
        width: 120px;
    }
    .layui-input-block {
        margin-left: 150px;
    }
    .message-card {
        background: #f8f8f8;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        position: relative;
    }
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-weight: bold;
    }
    .message-actions {
        display: flex;
        gap: 5px;
    }
    .button-item {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
        background: #fff;
        border-radius: 3px;
        align-items: center;
    }
    .json-editor {
        width: 100%;
        height: 400px;
        font-family: monospace;
    }
</style>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <div class="layui-collapse like-layui-collapse" lay-accordion="" style="border:1px dashed #c4c4c4">
                <div class="layui-colla-item">
                    <h2 class="layui-colla-title like-layui-colla-title" style="background-color: #fff">操作提示</h2>
                    <div class="layui-colla-content layui-show">
                        <p>* 配置营销聊天页面的对话流程、横幅文案等内容</p>
                        <p>* 支持可视化编辑和JSON代码编辑两种方式</p>
                        <p>* 修改后前端需要刷新页面才能看到效果</p>
                    </div>
                </div>
            </div>

            <!--标签页-->
            <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief" style="margin-top: 15px;">
                <ul class="layui-tab-title">
                    <li class="layui-this">基础设置</li>
                    <li>对话流程（可视化）</li>
                    <li>对话流程（JSON）</li>
                </ul>
                <div class="layui-tab-content">
                    <!--基础设置-->
                    <div class="layui-tab-item layui-show">
                        <div class="layui-form">
                            <div class="layui-form-item">
                                <label class="layui-form-label">横幅标题：</label>
                                <div class="layui-input-block" style="width:500px;">
                                    <input type="text" id="banner_title" value="" placeholder="我们帮您把业务/产品推广出去" class="layui-input" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">横幅副标题：</label>
                                <div class="layui-input-block" style="width:500px;">
                                    <input type="text" id="banner_subtitle" value="" placeholder="您只需要等着客户主动找上门" class="layui-input" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">底部信息：</label>
                                <div class="layui-input-block" style="width:500px;">
                                    <input type="text" id="footer_text" value="" placeholder="页面信息及服务由XXX企业管理有限公司提供" class="layui-input" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">客服头像：</label>
                                <div class="layui-input-block">
                                    <div class="like-upload-image">
                                        <div class="upload-image-div" id="avatar-preview" style="display:none;">
                                            <img src="" alt="avatar" id="avatar-img">
                                            <input type="hidden" id="service_avatar" value="">
                                            <div class="del-upload-btn">x</div>
                                        </div>
                                        <div class="upload-image-elem" id="avatar-upload">
                                            <a class="add-upload-image" id="upload-avatar"> + 添加图片</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label"></label>
                                <div class="layui-input-block">
                                    <button class="layui-btn layui-btn-normal" id="save-basic">保存基础设置</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--对话流程（可视化）-->
                    <div class="layui-tab-item">
                        <div style="margin-bottom: 15px;">
                            <button class="layui-btn layui-btn-sm" id="add-message">
                                <i class="layui-icon layui-icon-add-1"></i> 添加消息
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-warm" id="preview-flow">
                                <i class="layui-icon layui-icon-template-1"></i> 预览
                            </button>
                        </div>
                        <div id="message-list" class="layui-form">
                            <!-- 消息列表动态生成 -->
                        </div>
                        <div class="layui-form-item" style="margin-top: 20px;">
                            <div class="layui-input-block">
                                <button class="layui-btn layui-btn-normal" id="save-flow">保存对话流程</button>
                            </div>
                        </div>
                    </div>

                    <!--对话流程（JSON）-->
                    <div class="layui-tab-item">
                        <div style="margin-bottom: 10px;">
                            <span class="layui-word-aux">直接编辑JSON格式的对话流程配置，适合高级用户</span>
                        </div>
                        <textarea id="json-editor" class="layui-textarea json-editor" placeholder='请输入JSON格式的对话流程'></textarea>
                        <div class="layui-form-item" style="margin-top: 15px;">
                            <div class="layui-input-block">
                                <button class="layui-btn layui-btn-normal" id="save-json">保存JSON配置</button>
                                <button class="layui-btn" id="format-json">格式化</button>
                                <button class="layui-btn layui-btn-warm" id="validate-json">验证</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
layui.config({
    version: "{$front_version}",
    base: '/static/lib/'
}).use(['form', 'element', 'layer'], function(){
    var $ = layui.$, 
        form = layui.form, 
        element = layui.element,
        layer = layui.layer;

    var chatFlow = []; // 存储对话流程

    // 加载配置
    function loadConfig() {
        like.ajax({
            url: '{:url("marketing_chat/getConfig")}',
            type: "get",
            success: function(res) {
                if(res.code == 1) {
                    var data = res.data;
                    $('#banner_title').val(data.banner_title || '');
                    $('#banner_subtitle').val(data.banner_subtitle || '');
                    $('#footer_text').val(data.footer_text || '');
                    
                    // 处理头像
                    if(data.service_avatar) {
                        $('#avatar-img').attr('src', data.service_avatar);
                        $('#service_avatar').val(data.service_avatar);
                        $('#avatar-preview').show();
                        $('#avatar-upload').hide();
                    }
                    
                    // 加载对话流程
                    chatFlow = data.chat_flow || [];
                    renderMessages();
                    $('#json-editor').val(JSON.stringify(chatFlow, null, 2));
                }
            }
        });
    }

    // 渲染消息列表
    function renderMessages() {
        var html = '';
        chatFlow.forEach(function(msg, index) {
            html += createMessageCard(msg, index);
        });
        $('#message-list').html(html);
        form.render();
    }

    // 创建消息卡片
    function createMessageCard(msg, index) {
        var html = '<div class="message-card" data-index="' + index + '">';
        html += '<div class="message-header">';
        html += '<span>消息 ' + (index + 1) + '</span>';
        html += '<div class="message-actions">';
        html += '<button class="layui-btn layui-btn-xs move-up" data-index="' + index + '"><i class="layui-icon layui-icon-up"></i></button>';
        html += '<button class="layui-btn layui-btn-xs move-down" data-index="' + index + '"><i class="layui-icon layui-icon-down"></i></button>';
        html += '<button class="layui-btn layui-btn-xs layui-btn-danger del-msg" data-index="' + index + '"><i class="layui-icon layui-icon-delete"></i></button>';
        html += '</div></div>';
        
        html += '<div class="layui-form-item"><label class="layui-form-label">消息内容：</label>';
        html += '<div class="layui-input-block"><textarea class="layui-textarea msg-content" data-index="' + index + '" rows="3">' + (msg.content || '') + '</textarea></div></div>';
        
        html += '<div class="layui-form-item"><label class="layui-form-label">延迟(毫秒)：</label>';
        html += '<div class="layui-input-inline" style="width:200px;"><input type="number" class="layui-input msg-delay" data-index="' + index + '" value="' + (msg.delay || 500) + '"></div></div>';
        
        html += '<div class="layui-form-item"><label class="layui-form-label">等待响应：</label>';
        html += '<div class="layui-input-block"><input type="checkbox" class="msg-wait" data-index="' + index + '" ' + (msg.waitForResponse ? 'checked' : '') + ' lay-skin="switch" lay-text="是|否"></div></div>';
        
        if(msg.waitForResponse) {
            html += '<div class="layui-form-item"><label class="layui-form-label">响应键名：</label>';
            html += '<div class="layui-input-inline" style="width:200px;"><input type="text" class="layui-input msg-key" data-index="' + index + '" value="' + (msg.responseKey || '') + '"></div></div>';
            
            html += '<div class="layui-form-item"><label class="layui-form-label">按钮选项：</label>';
            html += '<div class="layui-input-block"><button class="layui-btn layui-btn-xs add-button" data-index="' + index + '">添加按钮</button>';
            html += '<div class="button-list" data-index="' + index + '">';
            if(msg.buttons) {
                msg.buttons.forEach(function(btn, btnIdx) {
                    html += createButtonItem(index, btnIdx, btn);
                });
            }
            html += '</div></div></div>';
        }
        
        html += '</div>';
        return html;
    }

    // 创建按钮项
    function createButtonItem(msgIndex, btnIndex, btn) {
        var html = '<div class="button-item">';
        html += '<input type="text" class="layui-input" style="width:120px;" placeholder="按钮文字" value="' + (btn.text || '') + '" data-field="text">';
        html += '<input type="text" class="layui-input" style="width:120px;" placeholder="按钮值" value="' + (btn.value || '') + '" data-field="value">';
        html += '<select class="layui-input" style="width:100px;" data-field="type">';
        html += '<option value="">默认</option>';
        html += '<option value="primary" ' + (btn.type === 'primary' ? 'selected' : '') + '>主要</option>';
        html += '<option value="warning" ' + (btn.type === 'warning' ? 'selected' : '') + '>警告</option>';
        html += '</select>';
        html += '<button class="layui-btn layui-btn-xs layui-btn-danger del-button">删除</button>';
        html += '</div>';
        return html;
    }

    // 添加消息
    $(document).on('click', '#add-message', function() {
        chatFlow.push({
            type: 'service',
            content: '',
            delay: 500,
            waitForResponse: false
        });
        renderMessages();
    });

    // 删除消息
    $(document).on('click', '.del-msg', function() {
        var index = $(this).data('index');
        layer.confirm('确定删除这条消息吗？', function(idx) {
            chatFlow.splice(index, 1);
            renderMessages();
            layer.close(idx);
        });
    });

    // 上移/下移
    $(document).on('click', '.move-up', function() {
        var index = $(this).data('index');
        if(index > 0) {
            var temp = chatFlow[index];
            chatFlow[index] = chatFlow[index - 1];
            chatFlow[index - 1] = temp;
            renderMessages();
        }
    });

    $(document).on('click', '.move-down', function() {
        var index = $(this).data('index');
        if(index < chatFlow.length - 1) {
            var temp = chatFlow[index];
            chatFlow[index] = chatFlow[index + 1];
            chatFlow[index + 1] = temp;
            renderMessages();
        }
    });

    // 更新消息内容
    $(document).on('blur', '.msg-content', function() {
        var index = $(this).data('index');
        chatFlow[index].content = $(this).val();
    });

    $(document).on('change', '.msg-delay', function() {
        var index = $(this).data('index');
        chatFlow[index].delay = parseInt($(this).val());
    });

    // 添加按钮
    $(document).on('click', '.add-button', function() {
        var index = $(this).data('index');
        if(!chatFlow[index].buttons) {
            chatFlow[index].buttons = [];
        }
        chatFlow[index].buttons.push({text: '', value: '', type: ''});
        renderMessages();
    });

    // 删除按钮
    $(document).on('click', '.del-button', function() {
        var btnItem = $(this).closest('.button-item');
        var buttonList = btnItem.closest('.button-list');
        var msgIndex = buttonList.data('index');
        var btnIndex = btnItem.index();
        chatFlow[msgIndex].buttons.splice(btnIndex, 1);
        renderMessages();
    });

    // 图片上传
    like.delUpload();
    $(document).on("click", "#upload-avatar", function () {
        like.imageUpload({
            limit: 1,
            field: "service_avatar",
            that: $(this)
        });
    });

    // 保存基础设置
    $('#save-basic').click(function() {
        var data = {
            banner_title: $('#banner_title').val(),
            banner_subtitle: $('#banner_subtitle').val(),
            footer_text: $('#footer_text').val(),
            service_avatar: $('#service_avatar').val()
        };
        
        like.ajax({
            url: '{:url("marketing_chat/saveConfig")}',
            data: data,
            type: "post",
            success: function(res) {
                if(res.code == 1) {
                    layer.msg('保存成功', {icon: 1});
                }
            }
        });
    });

    // 保存对话流程
    $('#save-flow').click(function() {
        // 收集所有数据
        chatFlow.forEach(function(msg, index) {
            msg.content = $('.msg-content[data-index="' + index + '"]').val();
            msg.delay = parseInt($('.msg-delay[data-index="' + index + '"]').val());
            msg.waitForResponse = $('.msg-wait[data-index="' + index + '"]').prop('checked');
            
            if(msg.waitForResponse) {
                msg.responseKey = $('.msg-key[data-index="' + index + '"]').val();
                msg.buttons = [];
                $('.button-list[data-index="' + index + '"] .button-item').each(function() {
                    var btn = {
                        text: $(this).find('[data-field="text"]').val(),
                        value: $(this).find('[data-field="value"]').val(),
                        type: $(this).find('[data-field="type"]').val()
                    };
                    msg.buttons.push(btn);
                });
            }
        });
        
        like.ajax({
            url: '{:url("marketing_chat/saveConfig")}',
            data: {chat_flow: chatFlow},
            type: "post",
            success: function(res) {
                if(res.code == 1) {
                    layer.msg('保存成功', {icon: 1});
                    $('#json-editor').val(JSON.stringify(chatFlow, null, 2));
                }
            }
        });
    });

    // JSON编辑
    $('#format-json').click(function() {
        try {
            var json = JSON.parse($('#json-editor').val());
            $('#json-editor').val(JSON.stringify(json, null, 2));
            layer.msg('格式化成功', {icon: 1});
        } catch(e) {
            layer.msg('JSON格式错误：' + e.message, {icon: 2});
        }
    });

    $('#validate-json').click(function() {
        try {
            JSON.parse($('#json-editor').val());
            layer.msg('JSON格式正确', {icon: 1});
        } catch(e) {
            layer.msg('JSON格式错误：' + e.message, {icon: 2});
        }
    });

    $('#save-json').click(function() {
        try {
            var json = JSON.parse($('#json-editor').val());
            like.ajax({
                url: '{:url("marketing_chat/saveConfig")}',
                data: {chat_flow: json},
                type: "post",
                success: function(res) {
                    if(res.code == 1) {
                        layer.msg('保存成功', {icon: 1});
                        chatFlow = json;
                        renderMessages();
                    }
                }
            });
        } catch(e) {
            layer.msg('JSON格式错误：' + e.message, {icon: 2});
        }
    });

    // 初始化加载
    loadConfig();
});
</script>
