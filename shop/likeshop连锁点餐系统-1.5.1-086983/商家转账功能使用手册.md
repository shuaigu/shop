# å•†å®¶è½¬è´¦åˆ°é›¶é’±åŠŸèƒ½ä½¿ç”¨æ‰‹å†Œ

## ğŸ“¦ åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå·²æˆåŠŸé›†æˆå¾®ä¿¡æ”¯ä»˜ V3 ç‰ˆæœ¬çš„"å•†å®¶è½¬è´¦åˆ°é›¶é’±"åŠŸèƒ½ï¼Œå¯ç”¨äºæµ‹è¯•å’Œå®é™…ä¸šåŠ¡ä¸­çš„æ‰¹é‡è½¬è´¦éœ€æ±‚ã€‚

## âœ… å·²å®Œæˆçš„é…ç½®

### 1. å‰ç«¯é¡µé¢
- âœ“ åˆ›å»ºäº†æµ‹è¯•é¡µé¢ï¼š`pages/user/transfer_test.vue`
- âœ“ åœ¨"æˆ‘çš„"é¡µé¢æ·»åŠ äº†å…¥å£ï¼ˆç¬¬ä¸€ä¸ªå›¾æ ‡ä½ç½®ï¼‰
- âœ“ åœ¨ `pages.json` ä¸­æ³¨å†Œäº†è·¯ç”±

### 2. åç«¯æ¥å£
- âœ“ API æ¥å£ï¼š`/api/user/transferTest`
- âœ“ ä½ç½®ï¼š`server/app/api/controller/User.php` çš„ `transferTest()` æ–¹æ³•
- âœ“ æ”¯æŒ V3 ç­¾åç®—æ³•
- âœ“ è‡ªåŠ¨è¯»å–è¯ä¹¦åºåˆ—å·

### 3. è¯ä¹¦æ–‡ä»¶
è¯ä¹¦æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š
- ä½ç½®ï¼š`server/app/api/controller/` ç›®å½•
- æ–‡ä»¶ï¼š
  - `apiclient_cert.pem`ï¼ˆè¯ä¹¦å…¬é’¥ï¼‰
  - `apiclient_key.pem`ï¼ˆè¯ä¹¦ç§é’¥ï¼‰
  - `apiclient_cert.p12`ï¼ˆPKCS12 æ ¼å¼è¯ä¹¦ï¼‰

## ğŸ”§ æœ€åä¸€æ­¥ï¼šå¡«å†™ APIV3 å¯†é’¥

### æ‰“å¼€æ–‡ä»¶

ç¼–è¾‘ `server/app/api/controller/User.php`ï¼Œæ‰¾åˆ° **ç¬¬ 150 è¡Œ**ï¼š

```php
$apiV3Key = 'YOUR_API_V3_KEY_32_CHARACTERS_HERE';
```

### è·å– APIV3 å¯†é’¥

1. ç™»å½• [å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°](https://pay.weixin.qq.com/)
2. è¿›å…¥ **è´¦æˆ·ä¸­å¿ƒ** â†’ **APIå®‰å…¨** â†’ **APIv3å¯†é’¥**
3. ç‚¹å‡»"æŸ¥çœ‹"æˆ–"è®¾ç½®APIv3å¯†é’¥"
4. å¦‚æœæœªè®¾ç½®ï¼Œç‚¹å‡»"è®¾ç½®"æŒ‰é’®ï¼Œè¾“å…¥ä¸€ä¸ª **32ä½** çš„éšæœºå­—ç¬¦ä¸²
5. å¤åˆ¶è¯¥å¯†é’¥

### å¡«å†™å¯†é’¥

å°†ç¬¬ 150 è¡Œä¿®æ”¹ä¸ºï¼š

```php
$apiV3Key = 'è¿™é‡Œå¡«å†™æ‚¨çš„32ä½APIV3å¯†é’¥';
```

**ç¤ºä¾‹ï¼š**
```php
$apiV3Key = 'a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6';
```

## ğŸ§ª æµ‹è¯•æµç¨‹

### 1. æœ¬åœ°æµ‹è¯•ï¼ˆå¦‚æœè¯ä¹¦åœ¨æœ¬åœ°ï¼‰

å¦‚æœæ‚¨æƒ³åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼Œè¯·ä¿®æ”¹ `User.php` ç¬¬ 153 è¡Œï¼š

```php
// æ³¨é‡Šæ‰æœåŠ¡å™¨è·¯å¾„
// $certPath = __DIR__;

// å¯ç”¨æœ¬åœ°è·¯å¾„
$certPath = 'c:/Users/10205/Pictures/1545803671_20250301_cert';
```

### 2. æœåŠ¡å™¨æµ‹è¯•

è¯ä¹¦å·²åœ¨æœåŠ¡å™¨ä¸Šï¼Œç›´æ¥ä½¿ç”¨å½“å‰é…ç½®å³å¯ï¼š

```php
$certPath = __DIR__;  // è‡ªåŠ¨ä½¿ç”¨ controller ç›®å½•
```

### 3. å¼€å§‹æµ‹è¯•

1. **æ‰“å¼€å°ç¨‹åº**
2. **è¿›å…¥"æˆ‘çš„"é¡µé¢**
3. **ç‚¹å‡»"æ‰“æ¬¾æµ‹è¯•"**ï¼ˆç¬¬ä¸€ä¸ªå›¾æ ‡ï¼‰
4. **è¾“å…¥é‡‘é¢**ï¼šå»ºè®®æµ‹è¯•é‡‘é¢ `0.3` å…ƒ
5. **ç‚¹å‡»"ç«‹å³å‘èµ·è½¬è´¦æµ‹è¯•"**
6. **æŸ¥çœ‹ç»“æœ**ï¼š
   - æˆåŠŸï¼šæ˜¾ç¤º"è½¬è´¦æ‰¹æ¬¡å·²æäº¤æˆåŠŸ"
   - å¤±è´¥ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯

## ğŸ“Š æµ‹è¯•ç»“æœè¯´æ˜

### æˆåŠŸç¤ºä¾‹

```json
{
  "code": 1,
  "msg": "è½¬è´¦æ‰¹æ¬¡å·²æäº¤æˆåŠŸï¼",
  "data": {
    "http_code": 200,
    "out_batch_no": "BATCH20250130123456789",
    "result": {
      "batch_id": "1002600000000000000000000001",
      "out_batch_no": "BATCH20250130123456789",
      "create_time": "2025-01-30T12:34:56+08:00"
    }
  }
}
```

**è¯´æ˜**ï¼šè½¬è´¦æ‰¹æ¬¡å·²æˆåŠŸæäº¤åˆ°å¾®ä¿¡æ”¯ä»˜ç³»ç»Ÿï¼Œèµ„é‡‘å°†åœ¨å‡ åˆ†é’Ÿå†…åˆ°è´¦ç”¨æˆ·é›¶é’±ã€‚

### å¸¸è§é”™è¯¯å¤„ç†

#### é”™è¯¯ 1ï¼šPARAM_ERROR - å‚æ•°é”™è¯¯

**åŸå› **ï¼šAPIV3 å¯†é’¥æœªå¡«å†™æˆ–å¡«å†™é”™è¯¯

**è§£å†³**ï¼š
1. ç¡®è®¤ç¬¬ 150 è¡Œ `$apiV3Key` æ˜¯å¦æ­£ç¡®å¡«å†™
2. ç¡®è®¤å¯†é’¥é•¿åº¦æ˜¯å¦ä¸º 32 ä½
3. ç¡®è®¤å¯†é’¥æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼

#### é”™è¯¯ 2ï¼šSIGN_ERROR - ç­¾åé”™è¯¯

**åŸå› **ï¼š
- è¯ä¹¦æ–‡ä»¶ä¸åŒ¹é…
- APIV3 å¯†é’¥é”™è¯¯
- ç³»ç»Ÿæ—¶é—´ä¸å‡†ç¡®

**è§£å†³**ï¼š
1. ç¡®è®¤è¯ä¹¦æ–‡ä»¶å®Œæ•´æ— æŸ
2. é‡æ–°ä»å•†æˆ·å¹³å°ä¸‹è½½è¯ä¹¦
3. æ£€æŸ¥æœåŠ¡å™¨æ—¶é—´æ˜¯å¦å‡†ç¡®

#### é”™è¯¯ 3ï¼šNO_AUTH - æƒé™éªŒè¯å¤±è´¥

**åŸå› **ï¼šå•†æˆ·æœªå¼€é€š"å•†å®¶è½¬è´¦åˆ°é›¶é’±"äº§å“

**è§£å†³**ï¼š
1. ç™»å½•å•†æˆ·å¹³å°
2. è¿›å…¥ **äº§å“ä¸­å¿ƒ** â†’ **æˆ‘çš„äº§å“**
3. ç¡®è®¤æ˜¯å¦å¼€é€š"å•†å®¶è½¬è´¦åˆ°é›¶é’±"
4. å¦‚æœæœªå¼€é€šï¼Œç‚¹å‡»"ç”³è¯·å¼€é€š"

#### é”™è¯¯ 4ï¼šè¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨

**åŸå› **ï¼šè¯ä¹¦è·¯å¾„é…ç½®é”™è¯¯

**è§£å†³**ï¼š
1. ç¡®è®¤è¯ä¹¦æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
2. æ£€æŸ¥ `User.php` ä¸­çš„ `$certPath` é…ç½®
3. å¦‚æœè¯ä¹¦åœ¨ controller ç›®å½•ï¼Œä½¿ç”¨ `__DIR__`
4. å¦‚æœè¯ä¹¦åœ¨å…¶ä»–ç›®å½•ï¼Œå¡«å†™ç»å¯¹è·¯å¾„

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿æŠ¤ APIV3 å¯†é’¥

- âŒ ä¸è¦å°†å¯†é’¥æäº¤åˆ° Git ä»“åº“
- âŒ ä¸è¦åœ¨å‰ç«¯ä»£ç ä¸­æš´éœ²å¯†é’¥
- âœ… å»ºè®®å°†å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ä¸­
- âœ… å®šæœŸæ›´æ¢å¯†é’¥

### 2. è¯ä¹¦æ–‡ä»¶å®‰å…¨

- âœ… è¯ä¹¦æ–‡ä»¶æƒé™è®¾ç½®ä¸º `600` æˆ– `400`
- âœ… å®šæœŸå¤‡ä»½è¯ä¹¦æ–‡ä»¶
- âŒ ä¸è¦å°†è¯ä¹¦æ–‡ä»¶æ”¾åœ¨ Web å¯è®¿é—®ç›®å½•

### 3. è½¬è´¦é‡‘é¢é™åˆ¶

å»ºè®®åœ¨ä»£ç ä¸­æ·»åŠ é‡‘é¢é™åˆ¶ï¼š

```php
// å•ç¬”é™é¢
if ($amount > 2000) {
    return JsonServer::error('å•ç¬”è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡2000å…ƒ');
}

// æ¯æ—¥é™é¢
$todayTotal = è®¡ç®—ä»Šæ—¥å·²è½¬è´¦æ€»é¢();
if ($todayTotal + $amount > 10000) {
    return JsonServer::error('ä»Šæ—¥è½¬è´¦æ€»é¢å·²è¾¾ä¸Šé™');
}
```

## ğŸ“ˆ å®é™…ä¸šåŠ¡åº”ç”¨

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥å°†è¯¥åŠŸèƒ½åº”ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

### 1. ä½£é‡‘æç°
ç”¨æˆ·ç”³è¯·æç° â†’ å®¡æ ¸é€šè¿‡ â†’ è°ƒç”¨è½¬è´¦æ¥å£ â†’ èµ„é‡‘åˆ°è´¦

### 2. é€€æ¬¾åœºæ™¯
è®¢å•å–æ¶ˆ/é€€è´§ â†’ é€€æ¬¾å®¡æ ¸ â†’ è°ƒç”¨è½¬è´¦æ¥å£ â†’ é€€æ¬¾åˆ°é›¶é’±

### 3. æ´»åŠ¨å¥–åŠ±
æ´»åŠ¨ä¸­å¥– â†’ å‘æ”¾å¥–åŠ± â†’ è°ƒç”¨è½¬è´¦æ¥å£ â†’ å¥–é‡‘åˆ°è´¦

### 4. åˆ†é”€ä½£é‡‘
è¾¾åˆ°æç°æ¡ä»¶ â†’ è‡ªåŠ¨ç»“ç®— â†’ è°ƒç”¨è½¬è´¦æ¥å£ â†’ ä½£é‡‘åˆ°è´¦

## ğŸ”§ è¿›é˜¶é…ç½®

### æ–¹æ³• 1ï¼šå°†å¯†é’¥ç§»åˆ°é…ç½®æ–‡ä»¶

ç¼–è¾‘ `server/config/app.php`ï¼Œæ·»åŠ ï¼š

```php
return [
    // ... å…¶ä»–é…ç½®
    
    'wechat_pay_v3' => [
        'apiv3_key' => env('WECHAT_PAY_APIV3_KEY', ''),
    ],
];
```

ç„¶ååœ¨ `User.php` ä¸­è¯»å–ï¼š

```php
$apiV3Key = config('app.wechat_pay_v3.apiv3_key');
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```
WECHAT_PAY_APIV3_KEY=ä½ çš„32ä½å¯†é’¥
```

åœ¨ä»£ç ä¸­è¯»å–ï¼š

```php
$apiV3Key = env('WECHAT_PAY_APIV3_KEY');
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å®˜æ–¹æ–‡æ¡£
- [å¾®ä¿¡æ”¯ä»˜ V3 æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [å•†å®¶è½¬è´¦åˆ°é›¶é’± API](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter4_3_1.shtml)

### å¸¸ç”¨å·¥å…·
- [å¾®ä¿¡æ”¯ä»˜å¼€å‘è€…å·¥å…·](https://pay.weixin.qq.com/wiki/doc/apiv3/tools/index.shtml)
- [ç­¾åéªŒè¯å·¥å…·](https://pay.weixin.qq.com/wiki/doc/apiv3/tools/signature.shtml)

## âœ¨ åŠŸèƒ½ç‰¹ç‚¹æ€»ç»“

- âœ… å®Œæ•´çš„ V3 ç­¾åå®ç°
- âœ… è‡ªåŠ¨è¯»å–è¯ä¹¦åºåˆ—å·
- âœ… è¯¦ç»†çš„é”™è¯¯æç¤º
- âœ… æ”¯æŒæœ¬åœ°å’ŒæœåŠ¡å™¨åŒç¯å¢ƒ
- âœ… å®‰å…¨çš„å‚æ•°éªŒè¯
- âœ… å‹å¥½çš„æµ‹è¯•ç•Œé¢

---

**é…ç½®å®Œæˆåï¼Œç«‹å³æµ‹è¯•ï¼Œç¥æ‚¨ä½¿ç”¨é¡ºåˆ©ï¼** ğŸ‰
