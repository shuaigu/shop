# 营销聊天付款功能 - 部署说明

## 一、功能概述

本功能为营销聊天对话流程添加了在线支付功能，支持：
- 微信支付（小程序、H5）
- 支付宝支付
- 自定义付款金额
- 完整的支付回调处理

## 二、部署步骤

### 1. 创建数据库表

执行 `营销聊天订单表.sql` 文件，创建 `la_marketing_chat_order` 表：

```sql
-- 在数据库中执行
source 营销聊天订单表.sql;
```

或直接在数据库管理工具中执行该SQL文件。

### 2. 后端文件说明

已创建/修改的文件：

**新增文件：**
- `server/app/common/model/MarketingChatOrder.php` - 营销聊天订单模型

**修改文件：**
- `server/app/api/controller/Pay.php` - 添加创建营销聊天订单接口
- `server/app/api/logic/PayLogic.php` - 添加营销聊天订单支付逻辑
- `server/app/common/server/WeChatPayServer.php` - 支持营销聊天订单微信支付
- `server/app/common/server/AliPayServer.php` - 支持营销聊天订单支付宝支付
- `server/app/common/logic/PayNotifyLogic.php` - 添加营销聊天订单支付回调

### 3. 前端文件说明

**修改文件：**
- `uniapp/api/app.js` - 添加创建营销聊天订单API
- `uniapp/pages/marketing_chat/marketing_chat.vue` - 实现支付功能

## 三、使用方法

### 1. 在对话流程JSON中添加付款消息

在后台管理 > 营销聊天配置 > 对话流程配置中，添加如下JSON：

```json
{
    "type": "service",
    "content": "为了确认您的诚意，请先支付0.4元诚意金（可抵扣后续费用）",
    "delay": 1000,
    "waitForResponse": true,
    "responseKey": "paymentConfirm",
    "buttons": [
        {
            "text": "立即支付 ¥0.40",
            "value": "pay",
            "type": "payment",
            "amount": 0.4
        },
        {
            "text": "暂不支付",
            "value": "skip",
            "type": "warning"
        }
    ]
}
```

### 2. 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `type` | string | 消息类型，固定为 `"service"` |
| `content` | string | 消息内容 |
| `delay` | number | 消息延迟显示时间（毫秒） |
| `waitForResponse` | boolean | 是否等待用户响应 |
| `responseKey` | string | 响应键名，用于后续条件判断 |
| `buttons` | array | 按钮数组 |
| `buttons[].text` | string | 按钮文本 |
| `buttons[].value` | string | 按钮值 |
| `buttons[].type` | string | **重要：设置为 `"payment"` 表示这是支付按钮** |
| `buttons[].amount` | number | **重要：支付金额（单位：元）** |

### 3. 支付流程

1. 用户在对话流程中看到付款消息
2. 点击"立即支付"按钮
3. 前端调用 `/pay/createMarketingChatOrder` 创建订单
4. 前端调用 `/pay/unifiedpay` 发起支付
5. 调起微信/支付宝支付界面
6. 用户完成支付
7. 后端接收支付回调，更新订单状态
8. 对话流程继续进行

### 4. 根据支付结果显示不同内容

可以在后续消息中使用条件判断：

```json
{
    "type": "service",
    "content": "✓ 支付成功！感谢您的信任，我们将为您提供优质服务。",
    "delay": 800,
    "condition": {
        "key": "paymentConfirm",
        "value": "paid"
    }
}
```

## 四、接口说明

### 创建营销聊天订单
- **接口：** `POST /api/pay/createMarketingChatOrder`
- **参数：**
  - `amount` (number, 必填) - 订单金额
  - `remark` (string, 可选) - 备注信息
- **返回：**
```json
{
    "code": 1,
    "msg": "订单创建成功",
    "data": {
        "order_id": 123,
        "order_sn": "MC20260130123456",
        "order_amount": 0.4
    }
}
```

### 统一支付接口
- **接口：** `POST /api/pay/unifiedpay`
- **参数：**
  - `order_id` (number, 必填) - 订单ID
  - `from` (string, 必填) - 订单来源，营销聊天固定为 `"marketing_chat"`
  - `pay_way` (number, 必填) - 支付方式：1-微信支付，2-支付宝支付
- **返回：** 支付参数

## 五、支付回调

### 微信支付回调
- **小程序：** `/api/pay/notifyMnp`
- **公众号：** `/api/pay/notifyOa`

### 支付宝回调
- **统一回调：** `/api/pay/aliNotify`

## 六、测试说明

### 小程序环境
- 需要配置微信支付商户号
- 需要在微信小程序后台配置支付回调域名

### H5环境
- 点击"立即支付"会显示模拟支付弹窗
- 可用于功能测试

## 七、注意事项

1. **支付金额单位：** JSON配置中的 `amount` 单位为元，后端会自动转换为分
2. **订单号生成规则：** `MC` + 年月日时分秒 + 4位随机数
3. **支付回调：** 请确保服务器回调地址可被微信/支付宝访问
4. **数据库表：** 必须先执行SQL创建表，否则会报错
5. **用户登录：** 支付功能需要用户登录，未登录用户会提示登录

## 八、常见问题

### Q1: 点击支付按钮没有反应？
A: 检查浏览器控制台是否有报错，确认：
- 用户是否已登录
- 后端接口是否正常
- 数据库表是否已创建

### Q2: 支付后订单状态未更新？
A: 检查：
- 支付回调地址是否配置正确
- 服务器能否接收到回调请求
- 查看后端日志确认回调是否成功

### Q3: 微信支付提示"发起支付失败:授权信息失效"？
A: 用户需要重新授权登录小程序

## 九、后续优化建议

1. 添加订单查询接口，让用户可以查看历史付款记录
2. 添加退款功能
3. 添加支付成功后的消息通知（短信/模板消息）
4. 在后台添加营销聊天订单管理页面

## 十、技术支持

如有问题，请查看：
- 后端日志：`server/runtime/log/`
- 数据库表：`la_marketing_chat_order`
- 前端控制台错误信息
