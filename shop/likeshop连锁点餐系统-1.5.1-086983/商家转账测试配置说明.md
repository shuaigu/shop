# 商家转账到零钱（V3 接口）配置说明

## ✅ 已完成的配置

以下信息已经自动配置，**无需手动填写**：

- ✓ 商户号：1545803671
- ✓ 小程序 AppID：wxf7ee79349bd957b8
- ✓ 证书文件路径：`c:/Users/10205/Pictures/1545803671_20250301_cert`
- ✓ 证书序列号：**自动从证书文件中读取**
- ✓ 私钥文件：**自动加载**

## 📝 需要您完成的配置

### 1. 填写 APIV3 密钥

打开文件：`server/app/api/controller/User.php`

找到 **第 150 行**：

```php
$apiV3Key = 'lishuai4323811lishuai4323811lish';
```

将 `YOUR_API_V3_KEY_32_CHARACTERS_HERE` 替换为您的 **APIV3 密钥**（32位字符串）。

### 2. 如何获取 APIV3 密钥

#### 方法一：在商户平台查看/设置

1. 登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心** → **API安全** → **APIv3密钥**
3. 如果已设置过，点击"查看"；如果未设置，点击"设置APIv3密钥"
4. 按照提示设置一个 **32位** 的字符串（建议使用随机生成工具）
5. 复制该密钥并粘贴到代码中

#### 方法二：使用随机生成工具

可以使用以下在线工具生成 32 位随机字符串：
- https://www.random.org/strings/
- 或者在 PHP 中运行：`echo bin2hex(random_bytes(16));`

**⚠️ 重要提示：**
- APIV3 密钥是 **32位字符串**（例如：`abcd1234efgh5678ijkl9012mnop3456`）
- 不是商户支付密钥
- 不是商户号
- 设置后请妥善保管，不要泄露

## 🧪 测试步骤

### 1. 填写 APIV3 密钥

编辑 `User.php` 第 150 行，填写您的 APIV3 密钥：

```php
$apiV3Key = 'your_real_32_character_key_here';
```

### 2. 保存文件

保存 `User.php` 文件。

### 3. 在小程序中测试

1. 打开小程序
2. 进入"我的"页面
3. 点击"打款测试"入口
4. 输入测试金额（建议：0.3 元）
5. 点击"立即发起转账测试"

### 4. 查看结果

- **成功**：会显示"转账批次已提交成功"，零钱将在几分钟内到账
- **失败**：会显示具体的错误信息，根据提示进行排查

## ❓ 常见问题

### Q1: 提示"证书序列号为空"

A: 这是因为 PHP 的 `openssl_x509_parse` 函数无法正确解析证书。请手动获取序列号：

1. 在商户平台 → 账户中心 → API安全 → 查看证书
2. 将序列号复制并填写到代码第 153 行（如果需要手动指定）

### Q2: 提示"签名验证失败"

A: 检查以下几点：
- APIV3 密钥是否填写正确（必须是 32 位）
- 证书文件是否完整（不要手动编辑 .pem 文件）
- 时间戳是否正确（检查服务器时间）

### Q3: 提示"产品权限验证失败"

A: 请确认：
- 商户平台是否开通了"商家转账到零钱"产品
- 商户号是否满足条件（入驻满90天，30天有流水）

### Q4: 测试成功后，如何在实际业务中使用？

A: 测试通过后，可以将 `transferTest` 方法的逻辑封装成一个独立的服务类，供其他业务模块调用。

## 📞 技术支持

如有其他问题，请参考：
- [微信支付官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [商家转账到零钱产品介绍](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter4_3_1.shtml)

---

**祝测试顺利！** 🎉
