# 排查支付500错误

## 错误信息
```
POST https://shop.jingle0350.cn/api/pay/createMarketingChatOrder 500
errError: 创建订单失败
```

## 排查步骤

### 步骤1：检查数据库表是否存在

在数据库管理工具（phpMyAdmin/Navicat）中执行：

```sql
SHOW TABLES LIKE 'la_marketing_chat_order';
```

**如果没有返回结果，说明表不存在，需要执行创建表SQL：**

```sql
-- 复制 营销聊天订单表.sql 中的内容执行
CREATE TABLE IF NOT EXISTS `la_marketing_chat_order` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_sn` varchar(64) NOT NULL DEFAULT '' COMMENT '订单编号',
  `user_id` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '用户ID',
  `order_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '订单金额',
  `pay_way` tinyint(1) NOT NULL DEFAULT '0' COMMENT '支付方式：1-微信支付，2-支付宝支付，3-余额支付',
  `pay_status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '支付状态：0-未支付，1-已支付',
  `pay_time` int(11) NOT NULL DEFAULT '0' COMMENT '支付时间',
  `transaction_id` varchar(128) NOT NULL DEFAULT '' COMMENT '第三方平台交易流水号',
  `remark` varchar(255) NOT NULL DEFAULT '' COMMENT '备注',
  `create_time` int(11) NOT NULL DEFAULT '0' COMMENT '创建时间',
  `update_time` int(11) NOT NULL DEFAULT '0' COMMENT '更新时间',
  `delete_time` int(11) DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  KEY `order_sn` (`order_sn`),
  KEY `user_id` (`user_id`),
  KEY `pay_status` (`pay_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='营销聊天订单表';
```

### 步骤2：检查用户登录状态

在微信开发者工具的 Console 中执行：

```javascript
// 检查是否有token
console.log('Token:', uni.getStorageSync('token'))
```

**如果没有token，需要重新登录：**
1. 退出小程序
2. 重新进入
3. 完成微信授权登录

### 步骤3：检查后端日志

查看服务器日志文件（如果存在）：
- 位置：`server/runtime/log/日期.log`
- 查找 "createMarketingChatOrder" 相关的错误信息

### 步骤4：临时调试方案

在 `server/app/api/controller/Pay.php` 的 `createMarketingChatOrder()` 方法的 try-catch 中添加详细错误信息：

```php
public function createMarketingChatOrder()
{
    $amount = $this->request->post('amount', 0);
    $remark = $this->request->post('remark', '营销聊天诚意金');
    
    if (!$amount || $amount <= 0) {
        return JsonServer::error('请输入正确的金额');
    }

    try {
        // 调试信息：检查用户ID
        if (!$this->user_id) {
            return JsonServer::error('用户未登录，请先登录');
        }

        // 创建订单
        $order = new MarketingChatOrder();
        $order->order_sn = MarketingChatOrder::generateOrderSn();
        $order->user_id = $this->user_id;
        $order->order_amount = $amount;
        $order->pay_status = 0;
        $order->remark = $remark;
        $order->create_time = time();
        $order->update_time = time();
        $order->save();

        return JsonServer::success('订单创建成功', [
            'order_id' => $order->id,
            'order_sn' => $order->order_sn,
            'order_amount' => $order->order_amount
        ]);
    } catch (\Exception $e) {
        // 返回详细错误信息用于调试
        return JsonServer::error('创建订单失败: ' . $e->getMessage() . ' | 文件: ' . $e->getFile() . ' | 行号: ' . $e->getLine());
    }
}
```

### 步骤5：验证表前缀

检查数据库配置中的表前缀是否为 `la_`：

查看 `server/config/database.php` 中的：
```php
'prefix' => 'la_',  // 确保是 la_
```

## 最可能的原因排序

1. ⭐⭐⭐⭐⭐ **数据库表未创建** - 90%的可能性
2. ⭐⭐⭐⭐ **用户未登录** - 需要token
3. ⭐⭐⭐ **表前缀配置错误**
4. ⭐⭐ **数据库连接失败**
5. ⭐ **PHP版本或扩展问题**

## 快速解决方案

**如果你着急使用，按以下顺序操作：**

1. **立即执行创建表SQL**（最重要！）
2. **重新登录小程序**（确保有token）
3. **刷新小程序页面**
4. **再次点击"立即支付"**

## 验证是否修复

执行SQL查询：
```sql
SELECT * FROM la_marketing_chat_order ORDER BY create_time DESC LIMIT 1;
```

如果有数据返回，说明已经修复成功！
